[{"data":1,"prerenderedAt":387},["ShallowReactive",2],{"global-music-player":3,"post-/2024/10/shiroi-docker-deployment":114,"surround-/2024/10/shiroi-docker-deployment":376},{"musicList":4,"error":113},[5,12,18,24,30,36,42,48,53,58,63,68,72,77,83,89,95,101,107],{"id":6,"title":7,"artist":8,"source":9,"url":10,"cover":11},"403010","Want To Be Close","川村ゆみ/アトラスサウンドチーム","netease","https://api.obdo.cc/meting/?server=netease&type=url&id=403010","https://p3.music.126.net/2QZtLwZhscppyPcH4qHAsw==/109951170737833679.jpg?param=90y90",{"id":13,"title":14,"artist":15,"source":9,"url":16,"cover":17},"2121025432","Full Moon, Full Life","Lotus Juice/高橋あず美","https://api.obdo.cc/meting/?server=netease&type=url&id=2121025432","https://p3.music.126.net/_RrQQv9o4QFB649P7cVmwg==/109951169287473362.jpg?param=90y90",{"id":19,"title":20,"artist":21,"source":9,"url":22,"cover":23},"760528","メグメル (cuckool Mix 2007)","eufonius","https://api.obdo.cc/meting/?server=netease&type=url&id=760528","https://p3.music.126.net/UVSTEnyyWfnQmhI5kqvvMQ==/109951170852620291.jpg?param=90y90",{"id":25,"title":26,"artist":27,"source":9,"url":28,"cover":29},"1484017181","Sofia","Álvaro Soler","https://api.obdo.cc/meting/?server=netease&type=url&id=1484017181","https://p3.music.126.net/Db50NT4VRJJPIBFYRMhdvQ==/109951165359298851.jpg?param=90y90",{"id":31,"title":32,"artist":33,"source":9,"url":34,"cover":35},"22706984","Étude pour les petites supercordes","戸越まごめ","https://api.obdo.cc/meting/?server=netease&type=url&id=22706984","https://p3.music.126.net/kkkPkRGflxLurhhKBbCmPg==/109951171268737495.jpg?param=90y90",{"id":37,"title":38,"artist":39,"source":9,"url":40,"cover":41},"1311319929","アルカテイル","鈴木このみ/VISUAL ARTS / Key","https://api.obdo.cc/meting/?server=netease&type=url&id=1311319929","https://p3.music.126.net/MVWKZCUCNQocuhMRBpL-Qw==/109951169976613728.jpg?param=90y90",{"id":43,"title":44,"artist":45,"source":9,"url":46,"cover":47},"2734259397","Utopia or Dystopia","夢乃ゆき","https://api.obdo.cc/meting/?server=netease&type=url&id=2734259397","https://p3.music.126.net/fgj1rPzHY_l63_jJ2Cg2uw==/109951171811747559.jpg?param=90y90",{"id":49,"title":50,"artist":51,"source":9,"url":52,"cover":23},"760533","だんご大家族","茶太/真理絵/くない瓜/Rio/Morrigan/藤枝あかね/加藤恒太","https://api.obdo.cc/meting/?server=netease&type=url&id=760533",{"id":54,"title":55,"artist":56,"source":9,"url":57,"cover":35},"22706980","渚","VISUAL ARTS / Key","https://api.obdo.cc/meting/?server=netease&type=url&id=22706980",{"id":59,"title":60,"artist":61,"source":9,"url":62,"cover":35},"22707008","潮鳴り","折戸伸治","https://api.obdo.cc/meting/?server=netease&type=url&id=22707008",{"id":64,"title":65,"artist":56,"source":9,"url":66,"cover":67},"1446832656","REFLECTION BLUE","https://api.obdo.cc/meting/?server=netease&type=url&id=1446832656","https://p3.music.126.net/9Z_HRqDjs2iBLz7_qqSPkg==/109951170197587239.jpg?param=90y90",{"id":69,"title":70,"artist":56,"source":9,"url":71,"cover":35},"22706979","汐","https://api.obdo.cc/meting/?server=netease&type=url&id=22706979",{"id":73,"title":74,"artist":75,"source":9,"url":76,"cover":67},"1446837300","しろはの子守歌","小原好美/VISUAL ARTS / Key","https://api.obdo.cc/meting/?server=netease&type=url&id=1446837300",{"id":78,"title":79,"artist":80,"source":9,"url":81,"cover":82},"1303019256","astral ability","橋本みゆき/佐咲紗花","https://api.obdo.cc/meting/?server=netease&type=url&id=1303019256","https://p3.music.126.net/YM3igu2abTjWdIfT_Gn5Lw==/109951163479574970.jpg?param=90y90",{"id":84,"title":85,"artist":86,"source":9,"url":87,"cover":88},"541492408","強がるオトナのSecret Labo","後藤麻衣","https://api.obdo.cc/meting/?server=netease&type=url&id=541492408","https://p3.music.126.net/KyQpNXO_3pvMwcgBhl0oGg==/109951163169040453.jpg?param=90y90",{"id":90,"title":91,"artist":92,"source":9,"url":93,"cover":94},"530057368","PERFECT GIRL","種崎敦美","https://api.obdo.cc/meting/?server=netease&type=url&id=530057368","https://p3.music.126.net/ZGqIyyu7ziQayjXIpID4qg==/109951163108870649.jpg?param=90y90",{"id":96,"title":97,"artist":98,"source":9,"url":99,"cover":100},"542058337","大和撫子はあこがれ","遥そら","https://api.obdo.cc/meting/?server=netease&type=url&id=542058337","https://p3.music.126.net/r4KRde43oriYxAgyD8-MOA==/109951163169043939.jpg?param=90y90",{"id":102,"title":103,"artist":104,"source":9,"url":105,"cover":106},"1958727599","明日への扉","高橋李依","https://api.obdo.cc/meting/?server=netease&type=url&id=1958727599","https://p3.music.126.net/fNvDL1E9IX-__sUBPhLAGw==/109951167585364773.jpg?param=90y90",{"id":108,"title":109,"artist":110,"source":9,"url":111,"cover":112},"1818615632","色香水","神山羊","https://api.obdo.cc/meting/?server=netease&type=url&id=1818615632","https://p3.music.126.net/z-GWtONkPJHkPS8G9v55qw==/109951166198068699.jpg?param=90y90",null,{"id":115,"title":116,"body":117,"categories":351,"date":353,"description":354,"draft":355,"extension":356,"hide-info":355,"image":357,"meta":358,"navigation":360,"path":361,"permalink":113,"published":113,"readingTime":362,"recommend":343,"references":113,"seo":367,"sitemap":368,"stem":369,"subtitle":113,"tags":370,"type":373,"updated":374,"__hash__":375},"content/posts/2024/10/shiroi-docker-deployment.md","GitHub Action 构建 Shiroi Docker 镜像",{"type":118,"value":119,"toc":342},"minimark",[120,124,128,131,134,137,140,164,167,170,173,176,179,186,189,192,195,198,209,216,223,237,246,252,268,278,281,287,290,301,304,307,315,318,321,327,333,336,339],[121,122,123],"h2",{"id":123},"前言",[125,126,127],"p",{},"Mix-Space 是一个前后端分离的博客系统，你可以将前端和后端分别部署在不同的位置。此前，你可以将前端部署在 Vercel 云函数上，以缓解服务器压力并提升访问速度。",[125,129,130],{},"但随着 Vercel 调整 Hobby 免费套餐的额度，免费额度已越来越不够用。此时，我们可以通过 Docker 将 Shiro 部署到自己的服务器上来解决问题。然而，在使用 Shiroi（Shiro 的闭源捐赠版）时，原作者 innei 并未提供可用的 Docker 镜像。",[125,132,133],{},"这意味着你需要在自己的服务器上构建 Shiroi，但对于配置较低（低于 2G 内存）的云服务器来说，这很困难，基本会导致服务器爆内存假死。",[125,135,136],{},"Innei 给出的解决方案是使用 Github Action 完成构建，并将构建产物直接推送到你的服务器上，从而减轻服务器压力。",[125,138,139],{},"不过，这个方案在我看来有以下局限性：",[141,142,143],"card-list",{},[144,145,146,150,158,161],"ul",{},[147,148,149],"li",{},"需要在服务器安装相关依赖：Node.js、PM2、Sharp，但部分用户（比如我）使用的是 1Panel 管理服务器，不希望安装额外依赖",[147,151,152,153,157],{},"输出目录被固定在服务器的 ",[154,155,156],"code",{"code":156},"root"," 目录，不易更改",[147,159,160],{},"需要在 Github 仓库存储服务器登录信息，如 SSH 密钥等",[147,162,163],{},"项目本身有回滚功能，但一般用户可能不需要，也会占用大量服务器空间",[125,165,166],{},"总之，我并不想折腾这套方案。那么，有没有更好的办法？",[125,168,169],{},"欸，你说 Docker 部署不就行了？虽然 Innei 没给 Docker 镜像，但我们可以自己造！",[121,171,172],{"id":172},"思路",[125,174,175],{},"我们当然不能直接在自己的服务器上构建镜像，构建 Docker 镜像的资源占用并不会比直接构建站点静态文件少。",[125,177,178],{},"那我们可以借鉴 innei 的思路，用 Github Action 进行 Docker 镜像构建，不就可以了吗？",[125,180,181,182,185],{},"但仅仅构建还不够，还需要有地方存放镜像。我也不想用直接推送到服务器的办法，这同样需要在 Github 存储服务器登录信息。虽然用 ",[154,183,184],{"code":184},"secret"," 存储理论上安全，但谁能保证呢？",[125,187,188],{},"而且部分用户的服务器在国内，Github Action 主动推送的速度也未必理想。",[121,190,191],{"id":191},"选择",[125,193,194],{},"最终，我选择用 Github Action 构建镜像，然后上传到 Github Packages。Github Packages 默认会对私有库镜像进行私有保护，保障镜像不会泄露。",[125,196,197],{},"Docker 对镜像仓库的管理分为 3 个层级：命名空间（namespace）、镜像仓库（repository）、标签（tag）：",[144,199,200,203,206],{},[147,201,202],{},"命名空间以名称为标识，一个命名空间可管理多个镜像仓库",[147,204,205],{},"镜像仓库通过名称标识，一个仓库可保存一个镜像的多个版本",[147,207,208],{},"镜像版本通过标签区分",[125,210,211,212,215],{},"基于以上层级关系，一个完整的镜像路径 ",[154,213,214],{"code":214},"{namespace}/{repository}:{tag}"," 可以唯一确定一个镜像。",[125,217,218,219,222],{},"新建一个私有库，并在 ",[154,220,221],{"code":221},".github/workflows"," 目录下新建 yml 工作流文件，填入如下内容：",[224,225,227,234],"alert",{"type":226},"warning",[228,229,231],"template",{"v-slot:title":230},"",[125,232,233],{},"请注意新建的仓库权限，一定要为私有仓库！",[125,235,236],{},"若为公开仓库则所有人都可下载本镜像。",[238,239,244],"pre",{"className":240,"code":242,"language":243,"meta":230},[241],"language-yaml","name: Docker Build\n\non:\n  push:\n    branches:\n      - main\n  schedule:\n    - cron: '0 3 * * *'\n\n  repository_dispatch:\n    types: [trigger-workflow]\n\npermissions: write-all\nconcurrency:\n  group: ${{ github.workflow }}-${{ github.ref }}\n  cancel-in-progress: true\n\nenv:\n  PNPM_VERSION: 9.x.x\n  HASH_FILE: build_hash\n\njobs:\n  prepare:\n    name: Prepare\n    runs-on: ubuntu-latest\n    if: ${{ github.event.head_commit.message != 'Update hash file' }}\n\n    outputs:\n      hash_content: ${{ steps.read_hash.outputs.hash_content }}\n\n    steps:\n      - name: Checkout\n        uses: actions/checkout@v4\n      - name: Read HASH_FILE content\n        id: read_hash\n        run: |\n          content=$(cat ${{ env.HASH_FILE }}) || true\n          echo \"hash_content=$content\" >> \"$GITHUB_OUTPUT\"\n  check:\n    name: Check Should Rebuild\n    runs-on: ubuntu-latest\n    needs: prepare\n    outputs:\n      canceled: ${{ steps.use_content.outputs.canceled }}\n\n    steps:\n      - uses: actions/checkout@v4\n        with:\n          repository: innei-dev/shiroi\n          token: ${{ secrets.GH_PAT }}\n          fetch-depth: 0\n          lfs: true\n\n      - name: Use content from prev job and compare\n        id: use_content\n        env:\n          FILE_HASH: ${{ needs.prepare.outputs.hash_content }}\n        run: |\n          file_hash=$FILE_HASH\n          current_hash=$(git rev-parse --short HEAD)\n          echo \"File Hash: $file_hash\"\n          echo \"Current Git Hash: $current_hash\"\n          if [ \"$file_hash\" == \"$current_hash\" ]; then\n            echo \"Hashes match. Stopping workflow.\"\n            echo \"canceled=true\" >> $GITHUB_OUTPUT\n          else\n            echo \"Hashes do not match. Continuing workflow.\"\n          fi\n\n  build:\n    name: Build artifact\n    runs-on: ubuntu-latest\n    needs: check\n    if: ${{needs.check.outputs.canceled != 'true'}}\n\n    outputs:\n      sha_short: ${{ steps.store.outputs.sha_short }}\n      branch: ${{ steps.store.outputs.branch }}\n\n    steps:\n      - uses: actions/checkout@v4\n        with:\n          repository: innei-dev/shiroi\n          token: ${{ secrets.GH_PAT }}\n          fetch-depth: 0\n          lfs: true\n\n      - name: Login to Registry\n        uses: docker/login-action@v3\n        with:\n          registry: ghcr.io\n          username: ${{ github.actor }}\n          password: ${{ secrets.GITHUB_TOKEN }}\n\n      - name: Build Docker Image\n        run: |\n          docker build -t ghcr.io/${{ secrets.DOCKER_NAMESPACE }}/shiroi:latest .\n\n      - name: Push Docker Image to Github\n        run: |\n          docker push ghcr.io/${{ secrets.DOCKER_NAMESPACE }}/shiroi:latest\n\n      - name: Store artifact commit version\n        shell: bash\n        id: store\n        run: |\n          sha_short=$(git rev-parse --short HEAD)\n          branch_name=$(git rev-parse --abbrev-ref HEAD)\n          echo \"sha_short=$sha_short\" >> \"$GITHUB_OUTPUT\"\n          echo \"branch=$branch_name\" >> \"$GITHUB_OUTPUT\"\n  store:\n    name: Store artifact commit version\n    runs-on: ubuntu-latest\n    needs: [build]\n    steps:\n\n      - name: Checkout\n        uses: actions/checkout@v4\n        with:\n          persist-credentials: false\n          fetch-depth: 0\n\n      - name: Use outputs from build\n        env:\n          SHA_SHORT: ${{ needs.build.outputs.sha_short }}\n          BRANCH: ${{ needs.build.outputs.branch }}\n        run: |\n          echo \"SHA Short from build: $SHA_SHORT\"\n          echo \"Branch from build: $BRANCH\"\n\n      - name: Write hash to file\n        env:\n          SHA_SHORT: ${{ needs.build.outputs.sha_short }}\n\n        run: |\n          echo \"SHA_SHORT: $SHA_SHORT\"\n          echo $SHA_SHORT > ${{ env.HASH_FILE }}\n\n      - name: Commit files\n        run: |\n          git config --local user.email \"41898282+github-actions[bot]@users.noreply.github.com\"\n          git config --local user.name \"github-actions[bot]\"\n          git add ${{ env.HASH_FILE }}\n          git status\n          git commit -a -m \"Update hash file\"\n\n      - name: Push changes\n        uses: ad-m/github-push-action@master\n        with:\n          github_token: ${{ secrets.GITHUB_TOKEN }}\n          branch: ${{ github.ref }}\n","yaml",[154,245,242],{"__ignoreMap":230},[125,247,248,249,251],{},"这样就可以实现简单的构建并上传 Github Registry 镜像。你需要在仓库的 ",[154,250,184],{"code":184}," 设置中配置以下机密变量：",[141,253,254],{},[144,255,256,262],{},[147,257,258,261],{},[154,259,260],{"code":260},"GH_PAT","：有权限访问 Shiroi 仓库的 Github Access Token",[147,263,264,267],{},[154,265,266],{"code":266},"DOCKER_NAMESPACE","：镜像命名空间，全部小写，建议用个人 Github 用户名",[224,269,270,275],{},[228,271,272],{"v-slot:title":230},[125,273,274],{},"注意！",[125,276,277],{},"由于 Github Action 的限制，仓库 3 个月无活动时，工作流会被禁用。\n@innei",[125,279,280],{},"我们采用 innei 的办法，每次构建结束后上传一个存储哈希值的文件，保持仓库活跃。同时，构建前对仓库哈希值进行对比，避免重复构建。",[125,282,283,284,286],{},"参考上述修改环境 ",[154,285,184],{"code":184}," 后，运行工作流（注意先开启仓库设置中 Github Action 写入文件的权限），即可生成哈希值文件并构建镜像。",[121,288,289],{"id":289},"使用",[125,291,292,293,296,297,300],{},"保存工作流文件，等待运行完毕后，你应该可以在仓库侧边栏的 ",[154,294,295],{"code":295},"Packages"," 或个人 Github 主页的 ",[154,298,299],{"code":299},"Package"," 里找到镜像文件。",[125,302,303],{},"在服务器上拉取镜像前，需要先配置 Docker 私有仓库。注意，Gitea 实例必须为 HTTPS 地址，否则 Docker 会拒绝拉取不安全的私有仓库。",[125,305,306],{},"在服务器上输入以下指令登录 Github Registry 私有仓库：",[238,308,313],{"className":309,"code":311,"language":312,"meta":230},[310],"language-bash","docker login ghcr.io\n","bash",[154,314,311],{"__ignoreMap":230},[125,316,317],{},"输入账号和有访问权限的 Github Access Token，确认登录后即可拉取私有仓库镜像。如果你用的是 1Panel，可以在容器仓库设置中直接配置私有仓库。",[125,319,320],{},"你也可以用如下 compose 文件配置安装 Shiroi：",[238,322,325],{"className":323,"code":324,"language":243,"meta":230},[241],"services:\n  shiro:\n    container_name: Shiroi\n    image:\n    restart: always\n    environment:\n      - NEXT_SHARP_PATH=/usr/local/lib/node_modules/sharp\n      - NEXT_PUBLIC_API_URL=https://api.example.com/api/v2\n      - NEXT_PUBLIC_GATEWAY_URL=https://api.example.com\n    ports:\n      - 127.0.0.1:2323:2323\n    networks:\n      - mx-network\n",[154,326,324],{"__ignoreMap":230},[125,328,329,332],{},[154,330,331],{"code":331},"image"," 填写你在软件包仓库看到的容器镜像信息。",[121,334,335],{"id":335},"后话",[125,337,338],{},"这样你就算是简单完成了，本文本质上偏专业系，而非喂饭文。",[125,340,341],{},"如有疑问，欢迎在评论区提问或结合搜索引擎查阅本文。",{"title":230,"searchDepth":343,"depth":343,"links":344},4,[345,347,348,349,350],{"id":123,"depth":346,"text":123},2,{"id":172,"depth":346,"text":172},{"id":191,"depth":346,"text":191},{"id":289,"depth":346,"text":289},{"id":335,"depth":346,"text":335},[352],"技术探索","2024-10-21T19:24:26","本文介绍了如何利用 GitHub Actions 为 Mix-Space 的闭源前端 Shiroi 构建 Docker 镜像并推送至 GitHub Packages，解决低配服务器本地构建内存不足的问题。本文记录了完整 Workflow 配置，包括定时触发、哈希去重、登录 ghcr.io、构建与推送 latest 镜像等关键步骤，并说明在 1Panel 或命令行拉取私有镜像的方法。本文分享了避免在服务器安装 Node、PM2 等依赖、无需暴露 SSH 密钥即可实现安全拉取与更新的实践经验，适合希望将 Shiroi 容器化部署到个人服务器的用户。",false,"md","https://mx-space.js.org/assets/images/preview/shiro.png",{"slots":359},{},true,"/2024/10/shiroi-docker-deployment",{"text":363,"minutes":364,"time":365,"words":366},"9 min read",8.275,496500,1655,{"title":116,"description":354},{"loc":361},"posts/2024/10/shiroi-docker-deployment",[371,372],"Mix-Space","Docker","tech","2025-06-02T22:00:00","TDoLS2G12CKxH9kIxt5DuBrkuyV2Z-oz6IQfFkOVp-k",[377,382],{"title":378,"path":379,"stem":380,"date":381,"type":373,"children":-1},"编写1Panel应用商店第三方程序","/2024/10/write-1panel-app","posts/2024/10/write-1panel-app","2024-10-17T19:24:26",{"title":383,"path":384,"stem":385,"date":386,"type":373,"children":-1},"破坏型迁移：站点反复横跳与稳定工作","/2024/12/break-change-2024","posts/2024/12/break-change-2024","2024-12-07T18:24:26",1768199113098]