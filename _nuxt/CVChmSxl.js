import{J as ae,g as te,r as M,o as re,N as se,aE as ne,x as _,Q as l,aO as i,b6 as u,aS as f,aR as v,K as a,ba as ie,aV as C,b9 as d,aU as oe,aN as ce,a_ as x,aW as le,a$ as A,b5 as ue}from"./DeZJN128.js";import{t as de,g as me,_ as ye,l as fe,L as ve}from"./v2xUNtTU.js";import"./D-deoX8n.js";const _e={class:"music-player"},ge={class:"music-info"},pe={key:0,class:"music-cover"},he={class:"music-details"},Le={key:0,class:"music-loading"},Pe={class:"music-title"},Me={class:"music-artist"},xe=["href","title"],ke={key:1,class:"music-source-text"},Ee=["src"],Te={class:"music-actions"},be=["title"],Ie={key:2,class:"lyrics-display"},we={class:"lyric-content"},Ce={key:1},Ae={key:3,class:"music-error"},Be=ae({__name:"MusicPlayer",props:{music:{}},setup(B){const g=B,{fetchNeteaseMetadata:N,fetchNeteaseLyrics:S,detectMusicSource:z,extractMusicId:$,getMusicLink:F,parseLyrics:O}=me(),k=de(),e=te({isLoading:!1,hasError:!1,errorMessage:"",isPlaying:!1,currentTime:0,duration:0,isLyricsLoading:!1,currentLyricIndex:0,hasPlayedBefore:!1}),s=M(g.music),o=M(),c=M([]),U={netease:"网易云音乐",tencent:"QQ音乐",kuwo:"酷我音乐",xiami:"虾米音乐",kugou:"酷狗音乐",youtube:"YouTube",url:"外部链接"};re(()=>g.music.id,t=>{t&&(s.value=g.music,G(),T())}),se(()=>{s.value=g.music,T(),W()}),ne(()=>{Y()});const p=_(()=>({title:s.value.title||"未知曲目",artist:s.value.artist||"未知艺术家",platform:s.value.platform||s.value.source||"音乐"})),h=_(()=>U[s.value.source]||s.value.source),L=_(()=>F(s.value.source,s.value.id)),V=_(()=>!!L.value),D=_(()=>e.duration?e.currentTime/e.duration*100:0),E=_(()=>{if(c.value.length===0)return 0;const t=c.value[e.currentLyricIndex],r=c.value[e.currentLyricIndex+1];if(!t)return 0;if(!r){const P=e.currentTime-t.time;return Math.min(100,P/3*100)}const n=r.time-t.time;if(n<=0)return 100;const m=e.currentTime-t.time;return m>=n?100:Math.max(0,m/n*100)});function G(){e.isPlaying&&o.value&&o.value.pause(),e.isPlaying=!1,e.currentTime=0,e.duration=0,e.hasError=!1,e.errorMessage="",e.currentLyricIndex=0,e.isLyricsLoading=!1,e.hasPlayedBefore=!1,c.value=[]}async function T(){let t=s.value.source,r=s.value.id;if(s.value.url&&!r&&(t=z(s.value.url),r=$(s.value.url,t)||"",s.value={...s.value,source:t,id:r}),t!=="netease"||!r){e.isLoading=!1;return}try{e.isLoading=!0,e.hasError=!1,e.errorMessage="";const n=await N(r);(n.title||n.artist||n.cover||n.url)&&(s.value={...s.value,title:n.title||s.value.title,artist:n.artist||s.value.artist,cover:n.cover||s.value.cover,url:n.url||s.value.url}),await Q(r)}catch(n){console.error("[MusicPlayer] Failed to fetch metadata:",n),e.hasError=!0,n instanceof TypeError?e.errorMessage="网络连接失败，请检查网络设置":n instanceof SyntaxError?e.errorMessage="音乐信息格式错误":e.errorMessage="加载音乐信息失败"}finally{e.isLoading=!1}}async function Q(t){try{e.isLyricsLoading=!0;const r=await S(t);r&&(c.value=O(r),e.currentLyricIndex=0)}catch(r){console.warn("[MusicPlayer] Failed to fetch lyrics:",r),c.value=[]}finally{e.isLyricsLoading=!1}}function b(t){if(!Number.isFinite(t))return"0:00";const r=Math.floor(t/60),n=Math.floor(t%60);return`${r}:${n<10?"0":""}${n}`}function I(){o.value&&(e.isPlaying?o.value.pause():o.value.play().catch(t=>{console.warn("[MusicPlayer] Failed to play audio:",t),e.hasError=!0}))}function R(){e.isPlaying=!1}function j(){e.isPlaying=!0,e.hasPlayedBefore=!0}function J(){e.isPlaying=!1}function K(){console.error("[MusicPlayer] Audio playback error"),e.isPlaying&&(e.hasError=!0,e.errorMessage="音乐播放失败，可能文件不可用或格式不支持"),e.isPlaying=!1}function W(){document.addEventListener("play",w,!0)}function Y(){document.removeEventListener("play",w,!0)}function w(t){const r=t.target;o.value&&r!==o.value&&r.tagName==="AUDIO"&&e.isPlaying&&I()}function Z(){if(!o.value)return;const t=o.value.currentTime;Math.abs(t-e.currentTime)>=.1&&(e.currentTime=t),q(t)}function q(t){if(c.value.length!==0)for(let r=c.value.length-1;r>=0;r--){const n=c.value[r];if(n&&n.time<=t){e.currentLyricIndex=r;break}}}function H(){o.value&&(e.duration=o.value.duration)}function X(t){if(o.value&&e.duration){const r=t/100*e.duration;o.value.currentTime=r,e.currentTime=r}}return(t,r)=>{const n=ie,m=ye,P=ve,ee=fe;return i(),l("div",_e,[u("div",ge,[a(s).cover?(i(),l("div",pe,[f(n,{src:a(s).cover,alt:a(p).title,class:"cover-image",loading:"lazy",fit:"cover"},null,8,["src","alt"])])):v("",!0),u("div",he,[a(e).isLoading?(i(),l("div",Le,[f(m,{name:"eos-icons:loading",size:"14"}),r[0]||(r[0]=u("span",null,"加载中...",-1))])):(i(),l(C,{key:1},[u("div",Pe,d(a(p).title),1),u("div",Me,d(a(p).artist),1),a(V)&&a(L)?(i(),l("a",{key:0,href:a(L),target:"_blank",rel:"noopener noreferrer",class:"music-source",title:`在 ${a(h)} 中打开`},[f(m,{name:"mdi:music",size:"14"}),u("span",null,d(a(h)),1)],8,xe)):(i(),l("div",ke,[f(m,{name:"mdi:music",size:"14"}),u("span",null,d(a(h)),1)]))],64))])]),f(ee,null,{default:oe(()=>[a(s).url?(i(),l("audio",{key:0,ref_key:"audioElement",ref:o,src:a(s).url,crossorigin:"anonymous",onEnded:R,onPlay:j,onPause:J,onError:K,onTimeupdate:Z,onLoadedmetadata:H},null,40,Ee)):v("",!0),a(e).isPlaying&&a(e).duration>0?(i(),ce(P,{key:1,percent:a(D),"current-time":b(a(e).currentTime),duration:b(a(e).duration),onChange:X},null,8,["percent","current-time","duration"])):v("",!0),u("div",Te,[a(s).url?(i(),l("button",{key:0,class:x(["play-button",{playing:a(e).isPlaying}]),title:a(e).isPlaying?"暂停":"播放",onClick:I},[f(m,{name:a(e).isPlaying?"mdi:pause-circle":"mdi:play-circle",size:"20"},null,8,["name"]),u("span",null,d(a(e).isPlaying?"暂停":"播放"),1)],10,be)):v("",!0)]),a(c).length>0&&a(k).showMusicLyrics&&a(e).hasPlayedBefore?(i(),l("div",Ie,[(i(),l(C,null,le([-1,0,1],y=>u("div",{key:`${a(e).currentLyricIndex}-${y}`,class:x(["lyric-line",{active:y===0}])},[u("div",we,[y===0?(i(),l("span",{key:0,class:"lyric-text-wrapper",style:A({"--progress":a(E)})},d(a(c)[a(e).currentLyricIndex]?.text||""),5)):(i(),l("span",Ce,d(a(c)[a(e).currentLyricIndex+y]?.text||""),1)),a(k).showMusicTranslation&&a(c)[a(e).currentLyricIndex+y]?.translation?(i(),l("span",{key:2,class:x(y===0?"lyric-translation":"lyric-translation-inactive"),style:A(y===0?{"--progress":a(E)}:{})},d(a(c)[a(e).currentLyricIndex+y]?.translation),7)):v("",!0)])],2)),64))])):v("",!0),a(e).hasError&&a(s).url?(i(),l("div",Ae,[f(m,{name:"mdi:alert-circle",size:"16"}),u("span",null,d(a(e).errorMessage||"音乐加载失败"),1)])):v("",!0)]),_:1})])}}}),$e=Object.assign(ue(Be,[["__scopeId","data-v-59bae92c"]]),{__name:"MusicPlayer"});export{$e as default};
