const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./BuZIuJxQ.js","./CyAqJ3nm.js","./entry.BiVjzasw.css","./Lightbox.DLcruoWU.css"])))=>i.map(i=>d[i]);
import{z as D,y as R,s as z,aD as B,al as O,B as j,aj as M,r as b,ae as q,o as U,aC as m,ad as v,aE as H,c as V,Y as J,d as G,e as W,h as i,g as T,N as S,J as Y,a3 as F,L as u,w as Q,t as Z,S as ee,U as te,b as ne,_ as oe}from"./CyAqJ3nm.js";const re=te(()=>ne(()=>import("./BuZIuJxQ.js"),__vite__mapDeps([0,1,2,3]),import.meta.url).then(p=>p.default||p)),ae={ref:"comment",class:"z-comment"},se={class:"text-creative"},ce={class:"popover-confirm"},ie={class:"url-text"},de={id:"artalk"},le={class:"loading-box"},me=D({__name:"Comment",setup(p){const f=R(),w=z(),E=B(),_=O(),g=H.getInstance(),$=j(),x=M("comment"),K=M("popover"),h=b(""),y=b({});q(x,"click",e=>{const o=e.target;if(!o||o.classList?.contains("atk-avatar-img"))return;const n=o instanceof HTMLAnchorElement?o:o.closest("a");n?.target==="_blank"&&(e.stopPropagation(),e.preventDefault(),h.value=n.href,y.value={getReferenceClientRect:()=>n.getBoundingClientRect(),triggerTarget:n},K.value?.show())},{capture:!0});function X(e){window.open(e,"_blank")}function I(e){try{return decodeURIComponent(e)}catch{return e}}function N(e){return!e||e==="/"||e.endsWith("/")?e:`${e}/`}let d=null;function P(){return typeof window<"u"&&window.katex?Promise.resolve(window.katex):d||(d=new Promise((e,o)=>{const n=document.querySelector('script[src*="katex"]');if(n){if(n.__katexLoaded){e(window.katex);return}const a=()=>{n.__katexLoaded=!0,e(window.katex)},l=()=>{console.warn("[KaTeX] 现有脚本加载失败"),o(new Error("KaTeX 加载失败"))};n.addEventListener("load",a,{once:!0}),n.addEventListener("error",l,{once:!0});return}const t=document.createElement("script");t.src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js",t.async=!0;const s=()=>{t.__katexLoaded=!0,e(window.katex)},r=()=>{console.warn("[KaTeX] 主 CDN 加载失败，尝试备用源..."),t.src="https://lib.baomitu.com/KaTeX/0.16.9/katex.min.js",t.addEventListener("load",s,{once:!0}),t.addEventListener("error",()=>{console.warn("[KaTeX] 备用源也加载失败"),o(new Error("KaTeX 加载失败"))},{once:!0})};t.addEventListener("load",s,{once:!0}),t.addEventListener("error",r,{once:!0}),document.head.appendChild(t)}),d)}async function L(){try{const e=await P();if(!e){console.warn("[KaTeX] 未能加载");return}document.querySelectorAll("#artalk .atk-content:not(.math-processed)").forEach(n=>{n.classList.add("math-processed");let t=n.innerHTML;const s=t;try{t=t.replace(/\$\$([^$\n]+)\$\$/g,(r,a)=>{try{return`<div class="math-display">${e.renderToString(a.trim(),{displayMode:!0})}</div>`}catch{return console.warn("[KaTeX] 块级公式渲染错误:",a),r}}),t=t.replace(/```math([\s\S]*?)```/g,(r,a)=>{try{return`<div class="math-block">${e.renderToString(a.trim(),{displayMode:!0})}</div>`}catch{return console.warn("[KaTeX] math 块渲染错误"),r}}),t=t.replace(new RegExp("(?<!```)\\$([^$\\n]+)\\$(?!\\$)(?!```)","g"),(r,a)=>{if(r.includes('<span class="math-'))return r;try{return`<span class="math-inline">${e.renderToString(a.trim(),{displayMode:!1})}</span>`}catch{return console.warn("[KaTeX] 行内公式渲染错误:",a),r}}),t!==s&&(n.innerHTML=t)}catch(r){console.error("[KaTeX] 渲染过程出错:",r)}})}catch(e){console.error("[KaTeX] 加载失败:",e)}}function C(){document.querySelectorAll("#artalk .atk-content img:not(.lightbox-processed)").forEach(o=>{const n=o;n.classList.add("lightbox-processed"),n.style.cursor="zoom-in",n.addEventListener("click",()=>{const{open:t}=$.use(()=>ee(re,{el:n}));t()})})}let c=null;function A(){const e=document.getElementById("artalk");e&&(c&&c.disconnect(),c=new MutationObserver(o=>{let n=!1,t=!1;o.forEach(s=>{s.type==="childList"&&s.addedNodes.length>0&&s.addedNodes.forEach(r=>{if(r.nodeType===Node.ELEMENT_NODE){const a=r;(a.tagName==="IMG"||a.querySelector("img"))&&(n=!0),(a.classList?.contains("atk-content")||a.querySelector(".atk-content"))&&(t=!0)}})}),n&&setTimeout(()=>C(),100),t&&setTimeout(()=>L(),300)}),c.observe(e,{childList:!0,subtree:!0}))}async function k(){try{if(!_.showComments){g.destroy();return}const e=N(w.path);await g.init({el:"#artalk",pageKey:e,pageTitle:document.title.replace(` | ${f.title}`,""),server:f.artalk?.server,site:f.artalk?.site,emoticons:"/assets/Owo-Artalk.json",darkMode:E.value==="dark"}),await m(()=>{setTimeout(()=>{C(),setTimeout(()=>L(),1e3),A()},500)})}catch(e){console.error("[Artalk] 初始化失败:",e instanceof Error?e.message:e)}}return U(()=>{_.initCommentsSetting(),m(()=>{setTimeout(k,100)})}),v(()=>w.path,()=>{m(()=>{setTimeout(k,100)})}),v(()=>_.showComments,()=>{m(()=>{setTimeout(k,100)})}),v(()=>E.value,e=>{g.setDarkMode(e==="dark")}),V(()=>{c&&(c.disconnect(),c=null)}),(e,o)=>{const n=Y,t=J("Tooltip");return W(),G("section",ae,[i("h3",se,[T(n,{name:"i-hugeicons:comment-01",class:"comment-tip"}),o[1]||(o[1]=S("评论 ",-1))]),T(t,F({ref:"popover"},u(y),{"append-to":()=>u(x),interactive:"",aria:{expanded:!1},trigger:"focusin"}),{content:Q(()=>[i("div",ce,[i("span",ie,Z(I(u(h))),1),i("button",{class:"confirm-btn",onClick:o[0]||(o[0]=s=>X(u(h)))}," 访问 ")])]),_:1},16,["append-to"]),i("div",de,[i("p",le,[T(n,{name:"line-md:loading-twotone-loop",class:"loading-img"}),o[2]||(o[2]=S("评论加载中... ",-1))])])],512)}}}),pe=Object.assign(oe(me,[["__scopeId","data-v-a2682ca7"]]),{__name:"PostComment"});export{pe as _};
