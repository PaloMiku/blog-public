import{J as ie,g as ce,r as A,o as oe,N as ue,x as S,Q as y,aO as f,b6 as g,aS as k,aR as x,K as r,bs as le,aV as j,b9 as _,aU as de,aN as me,a_ as z,aW as fe,a$ as U,b5 as ye}from"./e2a45o_1.js";import{f as w,r as pe,_ as he,k as ge}from"./C_wnGKrE.js";import{_ as ve}from"./By_Aqsgj.js";const b=new Map,I=new Map,$=new Map;function _e(n){if(!n)return[];const t=[],a=n.split(`
`);for(const l of a){if(!l.trim()||!l.includes("["))continue;const p=l.match(/\[(\d{2}):(\d{2})\.(\d+)\]/);if(!p)continue;const v=Number.parseInt(p[1]??"0",10),h=Number.parseInt(p[2]??"0",10),m=Number.parseInt(p[3]??"0",10),L=v*60+h+m/1e3;let e=l;if(e=e.replace(/\[\d{2}:\d{2}\.\d+\]/g,"").trim(),e){const s=e.lastIndexOf("(");if(s>0&&e.endsWith(")")){const u=e.substring(0,s).trim(),d=e.substring(s+1,e.length-1).trim();if(u&&d){t.push({time:L,text:u,translation:d});continue}}t.push({time:L,text:e})}}return t.sort((l,p)=>l.time-p.time)}function W(n){try{let t=n.match(/[?&]id=(\d+)/);return t?.[1]||(t=n.match(/\/song[/?#]*(\d+)/),t?.[1])||(t=n.match(/\/m\/song\/(\d+)/),t?.[1])?t[1]:null}catch{return null}}function D(n){const t=n.toLowerCase();return t.includes("music.163.com")||t.includes("netease")?"netease":t.includes("qq.com")||t.includes("y.qq.com")?"tencent":t.includes("kuwo.cn")?"kuwo":t.includes("xiami.com")?"xiami":t.includes("kugou.com")?"kugou":t.includes("youtube.com")||t.includes("youtu.be")?"youtube":"url"}function R(n,t){switch(t){case"netease":return W(n);case"tencent":return n.match(/(?:song\/|songid=)(\d+)/)?.[1]||null;default:return n.match(/(\d+)/)?.[1]||null}}async function Me(n){const t=`netease:${n}`;if(I.has(t))return I.get(t);const a=(async()=>{try{if(!w.meting?.apiServer)return console.warn("[MusicParser] Meting API server not configured"),{};const p=`${w.meting.apiServer.endsWith("/")?w.meting.apiServer:`${w.meting.apiServer}/`}?type=song&id=${n}`,v=await fetch(p);if(!v.ok)return console.warn(`[MusicParser] Song API returned status ${v.status}`),{};const h=await v.json();let m=h;if(Array.isArray(h)&&h.length>0&&(m=h[0]),!m||typeof m!="object")return console.warn("[MusicParser] Invalid response format:",h),{};const L=m.pic;let e;return m.url&&(e=m.url),{title:m.name||m.title||"未知曲目",artist:m.artist?Array.isArray(m.artist)?m.artist.map(u=>typeof u=="string"?u:u.name).join(" / "):String(m.artist):"未知艺术家",cover:L||void 0,url:e||void 0}}catch(l){return console.error(`[MusicParser] Failed to fetch netease metadata for id ${n}:`,l),{}}})();return I.set(t,a),a}async function Pe(n){const t=`netease:lyrics:${n}`;if($.has(t))return $.get(t);const a=(async()=>{try{if(!w.meting?.apiServer)return console.warn("[MusicParser] Meting API server not configured"),"";const p=`${w.meting.apiServer.endsWith("/")?w.meting.apiServer:`${w.meting.apiServer}/`}?server=netease&type=lrc&id=${n}`,v=await fetch(p);if(!v.ok)return console.warn(`[MusicParser] Lyric API returned status ${v.status}`),"";const h=await v.text();return!h||h.includes("暂无歌词")?"":h}catch(l){return console.error(`[MusicParser] Failed to fetch lyrics for id ${n}:`,l),""}})();return $.set(t,a),a}function B(){return{id:"",title:"解析失败",artist:"无法解析音乐信息",source:"url"}}function we(n){if(!n||typeof n!="string")return B();if(b.has(n))return b.get(n);let t;try{if(n.trim().startsWith("{")){const a=JSON.parse(n);if(a&&typeof a=="object")return t={id:(a.id||"").toString(),title:(a.title||"未知曲目").toString(),artist:(a.artist||"未知艺术家").toString(),cover:a.cover?String(a.cover):void 0,url:a.url?String(a.url):void 0,source:a.source||"url",platform:a.platform?String(a.platform):void 0},b.set(n,t),t}if(n.trim().startsWith("http")){const a=n.trim(),l=D(a);return t={id:R(a,l)||"",title:"加载中...",artist:"加载中...",url:a,source:l,cover:void 0},b.set(n,t),t}throw new Error("Invalid format")}catch(a){console.warn("[MusicParser] Failed to parse music extension:",n,a),t=B()}return b.set(n,t),t}function Le(){b.clear(),I.clear(),$.clear()}function ke(n,t){if(!t)return null;switch(n){case"netease":return`https://music.163.com/#/song?id=${t}`;case"tencent":return`https://y.qq.com/n/yqq/song/${t}.html`;case"kuwo":return`https://www.kuwo.cn/play_detail/${t}`;case"xiami":return`https://www.xiami.com/song/${t}`;case"kugou":return`https://www.kugou.com/song/${t}`;case"youtube":return`https://www.youtube.com/watch?v=${t}`;case"url":return null;default:return null}}function xe(){return{parseMusicExtension:we,createEmptyMusic:B,clearCache:Le,detectMusicSource:D,extractMusicId:R,extractNeteaseMusicId:W,fetchNeteaseMetadata:Me,fetchNeteaseLyrics:Pe,getMusicLink:ke,parseLyrics:_e}}const Se={class:"music-player"},be={class:"music-info"},Ie={key:0,class:"music-cover"},$e={class:"music-details"},Te={key:0,class:"music-loading"},Ee={class:"music-title"},Ce={class:"music-artist"},Ne=["href","title"],Ae={key:1,class:"music-source-text"},ze=["src"],Be={class:"music-actions"},qe=["title"],Fe={key:2,class:"lyrics-display"},Oe={class:"lyric-content"},je={key:1},Ue={key:3,class:"music-error"},We=ie({__name:"MusicPlayer",props:{music:{}},setup(n){const t=n,{fetchNeteaseMetadata:a,fetchNeteaseLyrics:l,detectMusicSource:p,extractMusicId:v,getMusicLink:h,parseLyrics:m}=xe(),L=pe(),e=ce({isLoading:!1,hasError:!1,errorMessage:"",isPlaying:!1,currentTime:0,duration:0,isLyricsLoading:!1,currentLyricIndex:0,hasPlayedBefore:!1}),s=A(t.music),u=A(),d=A([]),V={netease:"网易云音乐",tencent:"QQ音乐",kuwo:"酷我音乐",xiami:"虾米音乐",kugou:"酷狗音乐",youtube:"YouTube",url:"外部链接"};oe(()=>t.music.id,i=>{i&&(s.value=t.music,J(),F())}),ue(()=>{s.value=t.music,F()});const T=S(()=>({title:s.value.title||"未知曲目",artist:s.value.artist||"未知艺术家",platform:s.value.platform||s.value.source||"音乐"})),E=S(()=>V[s.value.source]||s.value.source),C=S(()=>h(s.value.source,s.value.id)),K=S(()=>!!C.value),Q=S(()=>e.duration?e.currentTime/e.duration*100:0),q=S(()=>{if(d.value.length===0)return 0;const i=d.value[e.currentLyricIndex],c=d.value[e.currentLyricIndex+1];if(!i)return 0;if(!c){const N=e.currentTime-i.time;return Math.min(100,N/3*100)}const o=c.time-i.time;if(o<=0)return 100;const M=e.currentTime-i.time;return M>=o?100:Math.max(0,M/o*100)});function J(){e.isPlaying&&u.value&&u.value.pause(),e.isPlaying=!1,e.currentTime=0,e.duration=0,e.hasError=!1,e.errorMessage="",e.currentLyricIndex=0,e.isLyricsLoading=!1,e.hasPlayedBefore=!1,d.value=[]}async function F(){let i=s.value.source,c=s.value.id;if(s.value.url&&!c&&(i=p(s.value.url),c=v(s.value.url,i)||"",s.value={...s.value,source:i,id:c}),i!=="netease"||!c){e.isLoading=!1;return}try{e.isLoading=!0,e.hasError=!1,e.errorMessage="";const o=await a(c);(o.title||o.artist||o.cover||o.url)&&(s.value={...s.value,title:o.title||s.value.title,artist:o.artist||s.value.artist,cover:o.cover||s.value.cover,url:o.url||s.value.url}),await Y(c)}catch(o){console.error("[MusicPlayer] Failed to fetch metadata:",o),e.hasError=!0,o instanceof TypeError?e.errorMessage="网络连接失败，请检查网络设置":o instanceof SyntaxError?e.errorMessage="音乐信息格式错误":e.errorMessage="加载音乐信息失败"}finally{e.isLoading=!1}}async function Y(i){try{e.isLyricsLoading=!0;const c=await l(i);c&&(d.value=m(c),e.currentLyricIndex=0)}catch(c){console.warn("[MusicPlayer] Failed to fetch lyrics:",c),d.value=[]}finally{e.isLyricsLoading=!1}}function O(i){if(!Number.isFinite(i))return"0:00";const c=Math.floor(i/60),o=Math.floor(i%60);return`${c}:${o<10?"0":""}${o}`}function Z(){u.value&&(e.isPlaying?u.value.pause():u.value.play().catch(i=>{console.warn("[MusicPlayer] Failed to play audio:",i),e.hasError=!0}))}function G(){e.isPlaying=!1}function H(){e.isPlaying=!0,e.hasPlayedBefore=!0}function X(){e.isPlaying=!1}function ee(){console.error("[MusicPlayer] Audio playback error"),e.isPlaying&&(e.hasError=!0,e.errorMessage="音乐播放失败，可能文件不可用或格式不支持"),e.isPlaying=!1}function te(){if(!u.value)return;const i=u.value.currentTime;Math.abs(i-e.currentTime)>=.1&&(e.currentTime=i),re(i)}function re(i){if(d.value.length!==0)for(let c=d.value.length-1;c>=0;c--){const o=d.value[c];if(o&&o.time<=i){e.currentLyricIndex=c;break}}}function ne(){u.value&&(e.duration=u.value.duration)}function se(i){if(u.value&&e.duration){const c=i/100*e.duration;u.value.currentTime=c,e.currentTime=c}}return(i,c)=>{const o=le,M=he,N=ve,ae=ge;return f(),y("div",Se,[g("div",be,[r(s).cover?(f(),y("div",Ie,[k(o,{src:r(s).cover,alt:r(T).title,class:"cover-image",loading:"lazy",fit:"cover"},null,8,["src","alt"])])):x("",!0),g("div",$e,[r(e).isLoading?(f(),y("div",Te,[k(M,{name:"eos-icons:loading",size:"14"}),c[0]||(c[0]=g("span",null,"加载中...",-1))])):(f(),y(j,{key:1},[g("div",Ee,_(r(T).title),1),g("div",Ce,_(r(T).artist),1),r(K)&&r(C)?(f(),y("a",{key:0,href:r(C),target:"_blank",rel:"noopener noreferrer",class:"music-source",title:`在 ${r(E)} 中打开`},[k(M,{name:"mdi:music",size:"14"}),g("span",null,_(r(E)),1)],8,Ne)):(f(),y("div",Ae,[k(M,{name:"mdi:music",size:"14"}),g("span",null,_(r(E)),1)]))],64))])]),k(ae,null,{default:de(()=>[r(s).url?(f(),y("audio",{key:0,ref_key:"audioElement",ref:u,src:r(s).url,crossorigin:"anonymous",onEnded:G,onPlay:H,onPause:X,onError:ee,onTimeupdate:te,onLoadedmetadata:ne},null,40,ze)):x("",!0),r(e).isPlaying&&r(e).duration>0?(f(),me(N,{key:1,percent:r(Q),"current-time":O(r(e).currentTime),duration:O(r(e).duration),onChange:se},null,8,["percent","current-time","duration"])):x("",!0),g("div",Be,[r(s).url?(f(),y("button",{key:0,class:z(["play-button",{playing:r(e).isPlaying}]),title:r(e).isPlaying?"暂停":"播放",onClick:Z},[k(M,{name:r(e).isPlaying?"mdi:pause-circle":"mdi:play-circle",size:"20"},null,8,["name"]),g("span",null,_(r(e).isPlaying?"暂停":"播放"),1)],10,qe)):x("",!0)]),r(d).length>0&&r(L).showMusicLyrics&&r(e).hasPlayedBefore?(f(),y("div",Fe,[(f(),y(j,null,fe([-1,0,1],P=>g("div",{key:`${r(e).currentLyricIndex}-${P}`,class:z(["lyric-line",{active:P===0}])},[g("div",Oe,[P===0?(f(),y("span",{key:0,class:"lyric-text-wrapper",style:U({"--progress":r(q)})},_(r(d)[r(e).currentLyricIndex]?.text||""),5)):(f(),y("span",je,_(r(d)[r(e).currentLyricIndex+P]?.text||""),1)),r(L).showMusicTranslation&&r(d)[r(e).currentLyricIndex+P]?.translation?(f(),y("span",{key:2,class:z(P===0?"lyric-translation":"lyric-translation-inactive"),style:U(P===0?{"--progress":r(q)}:{})},_(r(d)[r(e).currentLyricIndex+P]?.translation),7)):x("",!0)])],2)),64))])):x("",!0),r(e).hasError&&r(s).url?(f(),y("div",Ue,[k(M,{name:"mdi:alert-circle",size:"16"}),g("span",null,_(r(e).errorMessage||"音乐加载失败"),1)])):x("",!0)]),_:1})])}}}),De=Object.assign(ye(We,[["__scopeId","data-v-96ef0707"]]),{__name:"MusicPlayer"}),Qe=Object.freeze(Object.defineProperty({__proto__:null,default:De},Symbol.toStringTag,{value:"Module"}));export{Qe as M,De as _,xe as u};
