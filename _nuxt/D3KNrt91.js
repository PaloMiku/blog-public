import{z as Y,r as B,G as g,ae as J,bb as se,o as Z,c as ie,d as r,e as s,n as U,L as e,h as i,g as b,Q as E,S as ee,J as te,t as l,w as ne,f as u,a0 as oe,H as re,_ as ae,aD as ce,ac as G,ad as le,F as z,P as N,N as V,E as ue}from"./CyLn58k_.js";import de from"./dBVHZCPH.js";import"./CAtE-ks5.js";function K(n){return n.type==="character"}function R(n){return n.type==="media"}class Q{cache=new Map;maxSize;defaultTTL;constructor(a=100,o=1440*60*1e3){this.maxSize=a,this.defaultTTL=o}get(a){const o=this.cache.get(a);return o?this.isExpired(o)?(this.cache.delete(a),null):o.data:null}set(a,o,d){if(this.cache.size>=this.maxSize){const I=this.cache.keys().next().value;this.cache.delete(I)}this.cache.set(a,{data:o,timestamp:Date.now(),ttl:d??this.defaultTTL})}delete(a){this.cache.delete(a)}clear(){this.cache.clear()}has(a){const o=this.cache.get(a);return o?this.isExpired(o)?(this.cache.delete(a),!1):!0:!1}size(){return this.cache.size}cleanup(){let a=0;for(const[o,d]of this.cache.entries())this.isExpired(d)&&(this.cache.delete(o),a++);return a}isExpired(a){return Date.now()-a.timestamp>a.ttl}getTimeToLive(a){const o=this.cache.get(a);if(!o)return-1;const d=Date.now()-o.timestamp,I=o.ttl-d;return I>0?I:0}}function _e(n){if(!Array.isArray(n))return[];const a=new Map;return n.forEach(o=>{a.has(o.name)||a.set(o.name,{name:o.name||"未知声优",image:o.image||o.images?.medium||o.images?.small,link:o.link||(o.id?`https://bangumi.tv/person/${o.id}`:void 0)})}),Array.from(a.values()).slice(0,3)}function fe(n){const a=new Map;return Array.isArray(n)&&n.forEach(o=>{typeof o.value=="string"&&a.set(o.key,o.value)}),a}function me(n){if(!Array.isArray(n))return"";const a=n.find(d=>d.key==="别名");if(!a||!Array.isArray(a.value))return"";const o=a.value.find(d=>d.k==="纯 假名"||d.k==="假名");return o?o.v:""}function ve(n){const a=fe(n.infobox),o=me(n.infobox),d=_e(n.voiceActors||[]);return{type:"character",source:"bangumi",title:n.name||"未知角色",subtitle:o||void 0,description:n.summary||void 0,image:n.images?.large||n.images?.medium||void 0,rating:void 0,tags:void 0,link:`https://bangumi.tv/character/${n.id}`,nameJp:o||void 0,nameCn:n.name_cn||void 0,gender:a.get("性别")||a.get("性 别")||void 0,birthday:a.get("生日")||void 0,bloodType:a.get("血型")||void 0,height:a.get("身高")||void 0,weight:a.get("体重")||void 0,bwh:a.get("BWH")||void 0,voiceActors:d.length>0?d:void 0,metadata:{characterId:n.id}}}function he(n){return{type:"media",source:"bangumi",title:n.name_cn||n.name||"未命名作品",subtitle:void 0,description:n.summary||void 0,image:n.images?.large||n.images?.common||void 0,rating:n.rating?.score||void 0,tags:n.tags?.map(a=>({name:a.name,count:a.count})).slice(0,5)||void 0,link:`https://bangumi.tv/subject/${n.id}`,status:n.status==="Air"?"on-air":n.status==="End"?"finished":"planned",airDate:n.date||void 0,rank:n.rank||void 0,metadata:{bangumiId:n.id,ratingCount:n.rating?.total||void 0}}}const pe={key:1,class:"cover-placeholder"},ye={class:"player-info"},ge={key:0,class:"player-loading"},be={key:1,class:"player-text"},ke={class:"player-title"},xe={class:"player-artist"},Ce=["disabled","title"],we=["src"],Me=Y({__name:"MiniMusicPlayer",props:{musicUrl:{}},setup(n){const a=n,{detectMusicSource:o,extractMusicId:d,fetchNeteaseMetadata:I}=re(),h=B({}),C=B(!0),v=B(!1),x=B(!1),p=B(null);async function t(){if(a.musicUrl){C.value=!0,x.value=!1;try{const _=o(a.musicUrl),k=d(a.musicUrl,_);if(_==="netease"&&k){const f=await I(k);h.value={id:k,source:_,title:f.title||"未知曲目",artist:f.artist||"未知艺术家",cover:f.cover,url:f.url}}else h.value={id:"",source:"url",title:"外部音乐",artist:"未知艺术家",url:a.musicUrl}}catch(_){console.error("[MiniMusicPlayer] Failed to fetch music data:",_),x.value=!0,h.value={id:"",source:"url",title:"加载失败",artist:"请检查链接"}}finally{C.value=!1}}}const{currentPlayingId:w,setPlaying:P,stop:T}=se(),A=`mini-music-player-${Date.now().toString(36)}-${Math.random().toString(36).slice(2)}`,M=g(()=>{const _=h.value?.id??h.value?.url??a.musicUrl;return _&&String(_).length>0?`mini-music-player-${encodeURIComponent(String(_))}`:A});J(w,_=>{p.value&&_!==M.value&&v.value&&p.value.pause()});function O(){!p.value||!h.value.url||(v.value?p.value.pause():p.value.play().catch(_=>{console.warn("[MiniMusicPlayer] Play failed:",_),x.value=!0}))}function q(){v.value=!0,P(M.value)}function S(){v.value=!1,w.value===M.value&&T()}function j(){v.value=!1,w.value===M.value&&T()}function F(){x.value=!0,v.value=!1,w.value===M.value&&T()}return Z(()=>{t()}),ie(()=>{w.value===M.value&&T(),p.value&&(p.value.pause(),p.value.src="")}),J(()=>a.musicUrl,()=>{p.value&&p.value.pause(),v.value=!1,t()}),J(M,(_,k)=>{_&&v.value&&P(_)}),(_,k)=>{const f=ee,c=te,L=oe;return s(),r("div",{class:U(["mini-music-player",{"is-loading":e(C),"has-error":e(x)}])},[i("div",{class:U(["player-cover",{"is-playing":e(v)}])},[e(h).cover?(s(),E(f,{key:0,src:e(h).cover,alt:e(h).title||"封面",class:"cover-image",loading:"lazy"},null,8,["src","alt"])):(s(),r("div",pe,[b(c,{name:"mdi:music-note"})]))],2),i("div",ye,[e(C)?(s(),r("span",ge,[b(c,{name:"eos-icons:loading"}),k[0]||(k[0]=i("span",null,"加载中...",-1))])):(s(),r("span",be,[i("span",ke,l(e(h).title||"未知曲目"),1),k[1]||(k[1]=i("span",{class:"player-separator"},"-",-1)),i("span",xe,l(e(h).artist||"未知艺术家"),1)]))]),b(L,null,{default:ne(()=>[i("button",{class:"player-button",disabled:e(C)||e(x)||!e(h).url,title:e(v)?"暂停":"播放",onClick:O},[e(C)?(s(),E(c,{key:0,name:"eos-icons:loading"})):e(x)?(s(),E(c,{key:1,name:"mdi:alert-circle"})):e(v)?(s(),E(c,{key:2,name:"mdi:pause"})):(s(),E(c,{key:3,name:"mdi:play"}))],8,Ce),e(h).url?(s(),r("audio",{key:0,ref_key:"audioElement",ref:p,src:e(h).url,crossorigin:"anonymous",onPlay:q,onPause:S,onEnded:j,onError:F},null,40,we)):u("",!0)]),_:1})],2)}}}),X=Object.assign(ae(Me,[["__scopeId","data-v-f135ecc6"]]),{__name:"MiniMusicPlayer"}),$e=["data-type","data-source"],De={key:1,class:"info-card__image-placeholder"},Ee={class:"info-card__content"},Ie={class:"info-card__main-section"},Ae={class:"info-card__title-section"},Pe={class:"info-card__title"},Te={key:0,class:"info-card__subtitle"},ze={key:0,class:"info-card__description"},Be={key:1,class:"info-card__voice-actors-section"},Le={class:"info-card__voice-actors-header"},Ne={class:"info-card__voice-actors-badges"},Ue={class:"info-card__info-section"},Se={key:0,class:"info-card__tags-container"},je={key:0,class:"info-card__tag-count"},Fe={key:1,class:"info-card__attributes-section"},Ve={key:0,class:"info-card__attribute-item"},Je={class:"info-card__attribute-value"},Oe={key:1,class:"info-card__attribute-item"},qe={class:"info-card__attribute-value"},He={key:2,class:"info-card__attribute-item"},Re={class:"info-card__attribute-value"},We={key:3,class:"info-card__attribute-item"},Ge={class:"info-card__attribute-value"},Ke={key:4,class:"info-card__attribute-item"},Qe={class:"info-card__attribute-value"},Xe={key:5,class:"info-card__attribute-item"},Ye={class:"info-card__attribute-value"},Ze={class:"info-card__footer"},et=["aria-label"],tt={class:"info-card__source-name"},at={key:1,class:"info-card__source-badge"},st={class:"info-card__source-name"},it={class:"info-card__main-section"},nt={class:"info-card__title-section"},ot={class:"info-card__title"},rt={key:0,class:"info-card__subtitle"},ct={key:0,class:"info-card__description"},lt={class:"info-card__info-section"},ut={key:0,class:"info-card__rating-section"},dt={class:"info-card__rating-stars"},_t={class:"info-card__rating-text"},ft={key:1,class:"info-card__tags-container"},mt={key:0,class:"info-card__tag-count"},vt={key:2,class:"info-card__media-info-combined"},ht={class:"info-card__media-info-label"},pt={class:"info-card__media-info-value"},yt={key:0,class:"info-card__date-item"},gt={key:1,class:"info-card__date-item"},bt={class:"info-card__footer"},kt=["aria-label"],xt={class:"info-card__source-name"},Ct={key:1,class:"info-card__source-badge"},wt={class:"info-card__source-name"},Mt={key:1,class:"info-card info-card--error"},$t={class:"info-card__error-content"},Dt={key:2,class:"info-card info-card--loading"},Et=Y({__name:"index",props:{data:{},loading:{type:Boolean},error:{type:Boolean},type:{},id:{},music:{}},setup(n){const a=n,o=g(()=>"type"in a&&"id"in a),d=g(()=>"data"in a&&a.data);Z(()=>{ce(()=>{!o.value&&!d.value&&console.warn("[InfoCard] Invalid props: must provide either (type, id) for load mode or data for data mode")})});const I=new Q(100,1440*60*1e3),h=new Q(100,1440*60*1e3),C=B(!1),v=B(""),x=G(null),p=G(null),t=g(()=>d.value?a.data:x.value),w=g(()=>o.value?a.music:t.value?.music),P=g(()=>t.value?K(t.value):!1),T=g(()=>t.value?R(t.value):!1),A=g(()=>t.value?t.value.source==="bangumi"?"Bangumi":t.value.source:""),M=g(()=>{if(!T.value||!t.value||!R(t.value))return[];const f=t.value,c=[];return f.rank&&c.push({label:"排名",value:`#${f.rank}`}),c}),O=g(()=>P.value?"info-card__layout-vertical":"info-card__layout-horizontal"),q=g(()=>P.value?"info-card__image-portrait":"info-card__image-landscape"),S=g(()=>d.value?a.loading??!1:C.value),j=g(()=>d.value?a.error??!1:v.value!=="");function F(){t.value?.link&&window.open(t.value.link,"_blank")}function _(f){return f?new Date(f).toLocaleDateString("zh-CN"):""}async function k(){if(!o.value)return;const{type:f,id:c}=a;if(!c)return;const L=f==="character"?I:h,y=L.get(c);if(y){x.value=y;return}C.value=!0,v.value="",p.value?.abort(),p.value=new AbortController;try{const $=ue.bangumi?.apiBase;if(!$){v.value="Bangumi API 未配置";return}const D=await fetch(`${$}/api/${f==="character"?"character":"subject"}?id=${c}`,{signal:p.value.signal});if(!D.ok){v.value=`请求失败 (${D.status})`;return}const H=await D.json();if(!H.id){v.value=`获取${f==="character"?"人物":"媒体"}数据失败`;return}const W=f==="character"?ve(H):he(H);x.value=W,L.set(c,W)}catch($){$ instanceof Error&&$.name!=="AbortError"&&(console.error("[InfoCard] Fetch error:",$),v.value=$.message||"未知错误")}finally{C.value=!1}}return J(()=>o.value?a.id:null,f=>{f!=null&&k()},{immediate:!0}),le(()=>{p.value?.abort()}),(f,c)=>{const L=ee,y=te,$=de;return!e(S)&&!e(j)&&e(t)?(s(),r("div",{key:0,class:"info-card","data-type":e(t).type,"data-source":e(t).source},[i("div",{class:U(e(O))},[i("div",{class:U(["info-card__image-wrapper",e(q)])},[e(t).image?(s(),E(L,{key:0,src:e(t).image,alt:e(t).title,class:"info-card__image",loading:"lazy"},null,8,["src","alt"])):(s(),r("div",De,[b(y,{name:e(P)?"ph:user-circle-bold":"ph:image-square-bold",class:"info-card__placeholder-icon"},null,8,["name"])]))],2),i("div",Ee,[e(P)&&e(K)(e(t))?(s(),r(z,{key:0},[i("div",Ie,[i("div",Ae,[i("h3",Pe,l(e(t).title),1),e(t).subtitle?(s(),r("p",Te,l(e(t).subtitle),1)):u("",!0)]),e(t).description?(s(),r("p",ze,l(e(t).description),1)):u("",!0),e(t).voiceActors?.length?(s(),r("div",Be,[i("div",Le,[b(y,{name:"ri:mic-line",class:"info-card__section-icon"}),c[0]||(c[0]=i("span",null,"声优",-1))]),i("div",Ne,[(s(!0),r(z,null,N(e(t).voiceActors,(m,D)=>(s(),E($,{key:D,img:m.image,text:m.name,link:m.link,round:""},null,8,["img","text","link"]))),128))])])):u("",!0),e(w)?(s(),E(X,{key:2,"music-url":e(w)},null,8,["music-url"])):u("",!0)]),i("div",Ue,[e(t).tags?.length?(s(),r("div",Se,[(s(!0),r(z,null,N(e(t).tags,(m,D)=>(s(),r("span",{key:D,class:"info-card__tag"},[V(l(m.name),1),m.count?(s(),r("span",je,l(m.count),1)):u("",!0)]))),128))])):u("",!0),e(t).gender||e(t).birthday||e(t).height||e(t).bloodType||e(t).weight||e(t).bwh?(s(),r("div",Fe,[e(t).gender?(s(),r("div",Ve,[c[1]||(c[1]=i("span",{class:"info-card__attribute-label"},"性别",-1)),i("span",Je,l(e(t).gender),1)])):u("",!0),e(t).birthday?(s(),r("div",Oe,[c[2]||(c[2]=i("span",{class:"info-card__attribute-label"},"生日",-1)),i("span",qe,l(e(t).birthday),1)])):u("",!0),e(t).height?(s(),r("div",He,[c[3]||(c[3]=i("span",{class:"info-card__attribute-label"},"身高",-1)),i("span",Re,l(e(t).height),1)])):u("",!0),e(t).bloodType?(s(),r("div",We,[c[4]||(c[4]=i("span",{class:"info-card__attribute-label"},"血型",-1)),i("span",Ge,l(e(t).bloodType),1)])):u("",!0),e(t).weight?(s(),r("div",Ke,[c[5]||(c[5]=i("span",{class:"info-card__attribute-label"},"体重",-1)),i("span",Qe,l(e(t).weight),1)])):u("",!0),e(t).bwh?(s(),r("div",Xe,[c[6]||(c[6]=i("span",{class:"info-card__attribute-label"},"三围",-1)),i("span",Ye,l(e(t).bwh),1)])):u("",!0)])):u("",!0),i("div",Ze,[e(t).link?(s(),r("button",{key:0,class:"info-card__source-badge info-card__source-link","aria-label":`前往 ${e(A)} 查看 ${e(t).title} 的详情`,onClick:F},[b(y,{name:"ri:bilibili-line",class:"info-card__source-icon"}),i("span",tt,l(e(A)),1)],8,et)):(s(),r("div",at,[b(y,{name:"ri:bilibili-line",class:"info-card__source-icon"}),i("span",st,l(e(A)),1)]))])])],64)):e(T)&&e(R)(e(t))?(s(),r(z,{key:1},[i("div",it,[i("div",nt,[i("h3",ot,l(e(t).title),1),e(t).subtitle?(s(),r("p",rt,l(e(t).subtitle),1)):u("",!0)]),e(t).description?(s(),r("p",ct,l(e(t).description),1)):u("",!0),e(w)?(s(),E(X,{key:1,"music-url":e(w)},null,8,["music-url"])):u("",!0)]),i("div",lt,[e(t).rating?(s(),r("div",ut,[i("div",dt,[(s(),r(z,null,N(5,m=>b(y,{key:m,class:U(["info-card__star-icon",m<=Math.round(e(t).rating/2)?"star-filled":"star-empty"]),name:m<=Math.round(e(t).rating/2)?"ri:star-fill":"ri:star-line"},null,8,["class","name"])),64))]),i("span",_t,l(e(t).rating),1)])):u("",!0),e(t).tags?.length?(s(),r("div",ft,[(s(!0),r(z,null,N(e(t).tags,(m,D)=>(s(),r("span",{key:D,class:"info-card__tag"},[V(l(m.name),1),m.count?(s(),r("span",mt,l(m.count),1)):u("",!0)]))),128))])):u("",!0),e(M).length||e(t).airDate||e(t).endDate?(s(),r("div",vt,[(s(!0),r(z,null,N(e(M),m=>(s(),r("div",{key:m.label,class:"info-card__media-info-item"},[i("span",ht,l(m.label)+":",1),i("span",pt,l(m.value),1)]))),128)),e(t).airDate?(s(),r("span",yt,[b(y,{name:"clarity:date-line",class:"info-card__date-icon"}),V(" "+l(_(e(t).airDate)),1)])):u("",!0),e(t).endDate?(s(),r("span",gt,[b(y,{name:"clarity:date-line",class:"info-card__date-icon"}),V(" "+l(_(e(t).endDate)),1)])):u("",!0)])):u("",!0),i("div",bt,[e(t).link?(s(),r("button",{key:0,class:"info-card__source-badge info-card__source-link","aria-label":`前往 ${e(A)} 查看 ${e(t).title} 的详情`,onClick:F},[b(y,{name:"ri:bilibili-line",class:"info-card__source-icon"}),i("span",xt,l(e(A)),1)],8,kt)):(s(),r("div",Ct,[b(y,{name:"ri:bilibili-line",class:"info-card__source-icon"}),i("span",wt,l(e(A)),1)]))])])],64)):u("",!0)])],2)],8,$e)):e(j)?(s(),r("div",Mt,[i("div",$t,[b(y,{name:"ph:warning-circle-bold",class:"info-card__error-icon"}),c[7]||(c[7]=i("p",null,"加载失败",-1)),c[8]||(c[8]=i("small",null,"请检查 ID 是否正确或稍后重试",-1))])])):e(S)?(s(),r("div",Dt,[...c[9]||(c[9]=[i("div",{class:"info-card__loading-skeleton"},null,-1)])])):u("",!0)}}}),Tt=Object.assign(ae(Et,[["__scopeId","data-v-b28437b8"]]),{__name:"InfoCard"});export{Tt as default};
