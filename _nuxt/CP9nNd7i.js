import{D as R,r as I,o as X,c as se,af as Y,d as o,e as i,n as N,O as e,h as s,g,U as $,W as Z,M as ee,t as u,w as ie,f as c,a4 as ne,K as re,_ as te,y as k,aH as oe,ad as q,ae as le,F as A,S as z,Q as H,J as ce}from"./D4rvfVLF.js";import ue from"./BfUhk82J.js";import"./CB-oUKqG.js";function K(n){return n.type==="character"}function J(n){return n.type==="media"}class G{cache=new Map;maxSize;defaultTTL;constructor(a=100,r=1440*60*1e3){this.maxSize=a,this.defaultTTL=r}get(a){const r=this.cache.get(a);return r?this.isExpired(r)?(this.cache.delete(a),null):r.data:null}set(a,r,d){if(this.cache.size>=this.maxSize){const E=this.cache.keys().next().value;this.cache.delete(E)}this.cache.set(a,{data:r,timestamp:Date.now(),ttl:d??this.defaultTTL})}delete(a){this.cache.delete(a)}clear(){this.cache.clear()}has(a){const r=this.cache.get(a);return r?this.isExpired(r)?(this.cache.delete(a),!1):!0:!1}size(){return this.cache.size}cleanup(){let a=0;for(const[r,d]of this.cache.entries())this.isExpired(d)&&(this.cache.delete(r),a++);return a}isExpired(a){return Date.now()-a.timestamp>a.ttl}getTimeToLive(a){const r=this.cache.get(a);if(!r)return-1;const d=Date.now()-r.timestamp,E=r.ttl-d;return E>0?E:0}}function de(n){if(!Array.isArray(n))return[];const a=new Map;return n.forEach(r=>{a.has(r.name)||a.set(r.name,{name:r.name||"未知声优",image:r.image||r.images?.medium||r.images?.small,link:r.link||(r.id?`https://bangumi.tv/person/${r.id}`:void 0)})}),Array.from(a.values()).slice(0,3)}function me(n){const a=new Map;return Array.isArray(n)&&n.forEach(r=>{typeof r.value=="string"&&a.set(r.key,r.value)}),a}function ve(n){if(!Array.isArray(n))return"";const a=n.find(d=>d.key==="别名");if(!a||!Array.isArray(a.value))return"";const r=a.value.find(d=>d.k==="纯 假名"||d.k==="假名");return r?r.v:""}function pe(n){const a=me(n.infobox),r=ve(n.infobox),d=de(n.voiceActors||[]);return{type:"character",source:"bangumi",title:n.name||"未知角色",subtitle:r||void 0,description:n.summary||void 0,image:n.images?.large||n.images?.medium||void 0,rating:void 0,tags:void 0,link:`https://bangumi.tv/character/${n.id}`,nameJp:r||void 0,nameCn:n.name_cn||void 0,gender:a.get("性别")||a.get("性 别")||void 0,birthday:a.get("生日")||void 0,bloodType:a.get("血型")||void 0,height:a.get("身高")||void 0,weight:a.get("体重")||void 0,bwh:a.get("BWH")||void 0,voiceActors:d.length>0?d:void 0,metadata:{characterId:n.id}}}function he(n){return{type:"media",source:"bangumi",title:n.name_cn||n.name||"未命名作品",subtitle:void 0,description:n.summary||void 0,image:n.images?.large||n.images?.common||void 0,rating:n.rating?.score||void 0,tags:n.tags?.map(a=>a.name).slice(0,5)||void 0,link:`https://bangumi.tv/subject/${n.id}`,episode:n.eps||void 0,status:n.status==="Air"?"on-air":n.status==="End"?"finished":"planned",airDate:n.date||void 0,rank:n.rank||void 0,metadata:{bangumiId:n.id,ratingCount:n.rating?.total||void 0}}}const _e={key:1,class:"cover-placeholder"},fe={class:"player-info"},ye={key:0,class:"player-loading"},ge={key:1,class:"player-text"},be={class:"player-title"},ke={class:"player-artist"},we=["disabled","title"],xe=["src"],Me=R({__name:"MiniMusicPlayer",props:{musicUrl:{}},setup(n){const a=n,{detectMusicSource:r,extractMusicId:d,fetchNeteaseMetadata:E}=re(),_=I({}),x=I(!0),v=I(!1),w=I(!1),p=I();async function t(){if(a.musicUrl){x.value=!0,w.value=!1;try{const b=r(a.musicUrl),f=d(a.musicUrl,b);if(b==="netease"&&f){const M=await E(f);_.value={id:f,source:b,title:M.title||"未知曲目",artist:M.artist||"未知艺术家",cover:M.cover,url:M.url}}else _.value={id:"",source:"url",title:"外部音乐",artist:"未知艺术家",url:a.musicUrl}}catch(b){console.error("[MiniMusicPlayer] Failed to fetch music data:",b),w.value=!0,_.value={id:"",source:"url",title:"加载失败",artist:"请检查链接"}}finally{x.value=!1}}}function T(){!p.value||!_.value.url||(v.value?p.value.pause():p.value.play().catch(b=>{console.warn("[MiniMusicPlayer] Play failed:",b),w.value=!0}))}function P(){v.value=!0}function U(){v.value=!1}function B(){v.value=!1}function j(){w.value=!0,v.value=!1}function S(b){const f=b.target;p.value&&f!==p.value&&f.tagName==="AUDIO"&&v.value&&p.value.pause()}return X(()=>{t(),document.addEventListener("play",S,!0)}),se(()=>{document.removeEventListener("play",S,!0),p.value&&(p.value.pause(),p.value.src="")}),Y(()=>a.musicUrl,()=>{p.value&&p.value.pause(),v.value=!1,t()}),(b,f)=>{const M=Z,C=ee,O=ne;return i(),o("div",{class:N(["mini-music-player",{"is-loading":e(x),"has-error":e(w)}])},[s("div",{class:N(["player-cover",{"is-playing":e(v)}])},[e(_).cover?(i(),$(M,{key:0,src:e(_).cover,alt:e(_).title||"封面",class:"cover-image",loading:"lazy"},null,8,["src","alt"])):(i(),o("div",_e,[g(C,{name:"mdi:music-note"})]))],2),s("div",fe,[e(x)?(i(),o("span",ye,[g(C,{name:"eos-icons:loading"}),f[0]||(f[0]=s("span",null,"加载中...",-1))])):(i(),o("span",ge,[s("span",be,u(e(_).title||"未知曲目"),1),f[1]||(f[1]=s("span",{class:"player-separator"},"-",-1)),s("span",ke,u(e(_).artist||"未知艺术家"),1)]))]),g(O,null,{default:ie(()=>[s("button",{class:"player-button",disabled:e(x)||e(w)||!e(_).url,title:e(v)?"暂停":"播放",onClick:T},[e(x)?(i(),$(C,{key:0,name:"eos-icons:loading"})):e(w)?(i(),$(C,{key:1,name:"mdi:alert-circle"})):e(v)?(i(),$(C,{key:2,name:"mdi:pause"})):(i(),$(C,{key:3,name:"mdi:play"}))],8,we),e(_).url?(i(),o("audio",{key:0,ref_key:"audioElement",ref:p,src:e(_).url,crossorigin:"anonymous",onPlay:P,onPause:U,onEnded:B,onError:j},null,40,xe)):c("",!0)]),_:1})],2)}}}),Q=Object.assign(te(Me,[["__scopeId","data-v-caf2e6cd"]]),{__name:"MiniMusicPlayer"}),Ce=["data-type","data-source"],De={key:1,class:"card-image-placeholder"},$e={class:"card-content"},Ee={class:"card-main-section"},Ae={class:"title-section"},Ie={class:"card-title"},Te={key:0,class:"card-subtitle"},Pe={key:0,class:"card-description"},Be={class:"card-info-section"},Le={key:0,class:"tags-container"},ze={key:1,class:"attributes-section"},Ne={key:0,class:"attribute-item"},Ue={class:"attribute-value"},je={key:1,class:"attribute-item"},Se={class:"attribute-value"},Oe={key:2,class:"attribute-item"},Ve={class:"attribute-value"},Fe={key:3,class:"attribute-item"},Je={class:"attribute-value"},We={key:4,class:"attribute-item"},qe={class:"attribute-value"},He={key:5,class:"attribute-item"},Ke={class:"attribute-value"},Ge={key:2,class:"voice-actors-section"},Qe={class:"voice-actors-header"},Re={class:"voice-actors-badges"},Xe={class:"card-footer"},Ye={class:"source-badge"},Ze={class:"source-name"},et=["aria-label"],tt={class:"card-main-section"},at={class:"title-section"},st={class:"card-title"},it={key:0,class:"card-subtitle"},nt={key:0,class:"card-description"},rt={class:"card-info-section"},ot={key:0,class:"rating-section"},lt={class:"rating-stars"},ct={class:"rating-text"},ut={key:1,class:"tags-container"},dt={key:2,class:"media-info-combined"},mt={class:"media-info-label"},vt={class:"media-info-value"},pt={key:0,class:"date-item"},ht={key:1,class:"date-item"},_t={class:"card-footer"},ft={class:"source-badge"},yt={class:"source-name"},gt=["aria-label"],bt={key:1,class:"info-card info-card-error"},kt={class:"error-content"},wt={key:2,class:"info-card info-card-loading"},xt=R({__name:"index",props:{data:{},loading:{type:Boolean},error:{type:Boolean},type:{},id:{},music:{}},setup(n){const a=n,r=k(()=>"type"in a&&"id"in a),d=k(()=>"data"in a&&a.data);X(()=>{oe(()=>{!r.value&&!d.value&&console.warn("[InfoCard] Invalid props: must provide either (type, id) for load mode or data for data mode")})});const E=new G(100,1440*60*1e3),_=new G(100,1440*60*1e3),x=I(!1),v=I(""),w=q(null),p=q(null),t=k(()=>d.value?a.data:w.value),T=k(()=>r.value?a.music:t.value?.music),P=k(()=>t.value?K(t.value):!1),U=k(()=>t.value?J(t.value):!1),B=k(()=>t.value?t.value.source==="bangumi"?"Bangumi":t.value.source:""),j=k(()=>{if(!U.value||!t.value||!J(t.value))return[];const h=t.value,l=[];return h.episode&&l.push({label:"话数",value:h.episode}),h.rank&&l.push({label:"排名",value:`#${h.rank}`}),l}),S=k(()=>P.value?"card-layout-vertical":"card-layout-horizontal"),b=k(()=>P.value?"card-image-portrait":"card-image-landscape"),f=k(()=>d.value?a.loading??!1:x.value),M=k(()=>d.value?a.error??!1:v.value!=="");function C(){t.value?.link&&window.open(t.value.link,"_blank")}function O(h){return h?new Date(h).toLocaleDateString("zh-CN"):""}async function ae(){if(!r.value)return;const{type:h,id:l}=a;if(!l)return;const V=h==="character"?E:_,y=V.get(l);if(y){w.value=y;return}x.value=!0,v.value="",p.value?.abort(),p.value=new AbortController;try{const D=ce.bangumi?.apiBase;if(!D){v.value="Bangumi API 未配置";return}const L=await fetch(`${D}/api/${h==="character"?"character":"subject"}?id=${l}`,{signal:p.value.signal});if(!L.ok){v.value=`请求失败 (${L.status})`;return}const F=await L.json();if(!F.id){v.value=`获取${h==="character"?"人物":"媒体"}数据失败`;return}const W=h==="character"?pe(F):he(F);w.value=W,V.set(l,W)}catch(D){D instanceof Error&&D.name!=="AbortError"&&(console.error("[InfoCard] Fetch error:",D),v.value=D.message||"未知错误")}finally{x.value=!1}}return Y(()=>r.value?a.id:null,h=>{h!=null&&ae()},{immediate:!0}),le(()=>{p.value?.abort()}),(h,l)=>{const V=Z,y=ee,D=ue;return!e(f)&&!e(M)&&e(t)?(i(),o("div",{key:0,class:"info-card","data-type":e(t).type,"data-source":e(t).source},[s("div",{class:N(e(S))},[s("div",{class:N(["card-image-wrapper",e(b)])},[e(t).image?(i(),$(V,{key:0,src:e(t).image,alt:e(t).title,class:"card-image",loading:"lazy"},null,8,["src","alt"])):(i(),o("div",De,[g(y,{name:e(P)?"ph:user-circle-bold":"ph:image-square-bold",class:"placeholder-icon"},null,8,["name"])]))],2),s("div",$e,[e(P)&&e(K)(e(t))?(i(),o(A,{key:0},[s("div",Ee,[s("div",Ae,[s("h3",Ie,u(e(t).title),1),e(t).subtitle?(i(),o("p",Te,u(e(t).subtitle),1)):c("",!0)]),e(t).description?(i(),o("p",Pe,u(e(t).description),1)):c("",!0),e(T)?(i(),$(Q,{key:1,"music-url":e(T)},null,8,["music-url"])):c("",!0)]),s("div",Be,[e(t).tags?.length?(i(),o("div",Le,[(i(!0),o(A,null,z(e(t).tags,m=>(i(),o("span",{key:m,class:"tag"},u(m),1))),128))])):c("",!0),e(t).gender||e(t).birthday||e(t).height||e(t).bloodType||e(t).weight||e(t).bwh?(i(),o("div",ze,[e(t).gender?(i(),o("div",Ne,[l[0]||(l[0]=s("span",{class:"attribute-label"},"性别",-1)),s("span",Ue,u(e(t).gender),1)])):c("",!0),e(t).birthday?(i(),o("div",je,[l[1]||(l[1]=s("span",{class:"attribute-label"},"生日",-1)),s("span",Se,u(e(t).birthday),1)])):c("",!0),e(t).height?(i(),o("div",Oe,[l[2]||(l[2]=s("span",{class:"attribute-label"},"身高",-1)),s("span",Ve,u(e(t).height),1)])):c("",!0),e(t).bloodType?(i(),o("div",Fe,[l[3]||(l[3]=s("span",{class:"attribute-label"},"血型",-1)),s("span",Je,u(e(t).bloodType),1)])):c("",!0),e(t).weight?(i(),o("div",We,[l[4]||(l[4]=s("span",{class:"attribute-label"},"体重",-1)),s("span",qe,u(e(t).weight),1)])):c("",!0),e(t).bwh?(i(),o("div",He,[l[5]||(l[5]=s("span",{class:"attribute-label"},"三围",-1)),s("span",Ke,u(e(t).bwh),1)])):c("",!0)])):c("",!0),e(t).voiceActors?.length?(i(),o("div",Ge,[s("div",Qe,[g(y,{name:"ri:mic-line",class:"section-icon"}),l[6]||(l[6]=s("span",null,"声优",-1))]),s("div",Re,[(i(!0),o(A,null,z(e(t).voiceActors,(m,L)=>(i(),$(D,{key:L,img:m.image,text:m.name,link:m.link,round:""},null,8,["img","text","link"]))),128))])])):c("",!0),s("div",Xe,[s("div",Ye,[g(y,{name:"ri:bilibili-line",class:"source-icon"}),s("span",Ze,u(e(B)),1)]),e(t).link?(i(),o("button",{key:0,class:"view-button","aria-label":`查看 ${e(B)} 上 ${e(t).title} 的详情`,onClick:C},[l[7]||(l[7]=s("span",null,"查看详情",-1)),g(y,{name:"ri:arrow-right-line",class:"button-icon"})],8,et)):c("",!0)])])],64)):e(U)&&e(J)(e(t))?(i(),o(A,{key:1},[s("div",tt,[s("div",at,[s("h3",st,u(e(t).title),1),e(t).subtitle?(i(),o("p",it,u(e(t).subtitle),1)):c("",!0)]),e(t).description?(i(),o("p",nt,u(e(t).description),1)):c("",!0),e(T)?(i(),$(Q,{key:1,"music-url":e(T)},null,8,["music-url"])):c("",!0)]),s("div",rt,[e(t).rating?(i(),o("div",ot,[s("div",lt,[(i(),o(A,null,z(5,m=>g(y,{key:m,class:N(["star-icon",m<=Math.round(e(t).rating/2)?"star-filled":"star-empty"]),name:m<=Math.round(e(t).rating/2)?"ri:star-fill":"ri:star-line"},null,8,["class","name"])),64))]),s("span",ct,u(e(t).rating),1)])):c("",!0),e(t).tags?.length?(i(),o("div",ut,[(i(!0),o(A,null,z(e(t).tags,m=>(i(),o("span",{key:m,class:"tag"},u(m),1))),128))])):c("",!0),e(j).length||e(t).airDate||e(t).endDate?(i(),o("div",dt,[(i(!0),o(A,null,z(e(j),m=>(i(),o("div",{key:m.label,class:"media-info-item"},[s("span",mt,u(m.label)+":",1),s("span",vt,u(m.value),1)]))),128)),e(t).airDate?(i(),o("span",pt,[g(y,{name:"clarity:date-line",class:"date-icon"}),H(" "+u(O(e(t).airDate)),1)])):c("",!0),e(t).endDate?(i(),o("span",ht,[g(y,{name:"clarity:date-line",class:"date-icon"}),H(" "+u(O(e(t).endDate)),1)])):c("",!0)])):c("",!0),s("div",_t,[s("div",ft,[g(y,{name:"ri:bilibili-line",class:"source-icon"}),s("span",yt,u(e(B)),1)]),e(t).link?(i(),o("button",{key:0,class:"view-button","aria-label":`查看 ${e(B)} 上 ${e(t).title} 的详情`,onClick:C},[l[8]||(l[8]=s("span",null,"查看详情",-1)),g(y,{name:"ri:arrow-right-line",class:"button-icon"})],8,gt)):c("",!0)])])],64)):c("",!0)])],2)],8,Ce)):e(M)?(i(),o("div",bt,[s("div",kt,[g(y,{name:"ph:warning-circle-bold",class:"error-icon"}),l[9]||(l[9]=s("p",null,"加载失败",-1)),l[10]||(l[10]=s("small",null,"请检查 ID 是否正确或稍后重试",-1))])])):e(f)?(i(),o("div",wt,[...l[11]||(l[11]=[s("div",{class:"loading-skeleton"},null,-1)])])):c("",!0)}}}),$t=Object.assign(te(xt,[["__scopeId","data-v-78391a18"]]),{__name:"InfoCard"});export{$t as default};
