import{J as G,r as $,x as u,o as X,S as Y,Q as o,aQ as r,K as e,aN as s,b5 as i,aZ as S,aM as U,br as ee,aR as A,b8 as l,aU as C,aV as M,b7 as W,b4 as ae}from"./D6ajeznB.js";import{_ as te,f as se}from"./CR3_r6pY.js";import"./D-deoX8n.js";const ie=["data-type","data-source","title"],ne={key:1,class:"card-image-placeholder"},oe={key:2,class:"rating-badge"},re={class:"card-content"},le={class:"title-section"},ce={class:"card-title"},de={key:0,class:"card-subtitle"},ue={key:0,class:"card-description"},ve={key:0,class:"attributes-section"},me={key:0,class:"attribute-item"},pe={class:"attribute-value"},ge={key:1,class:"attribute-item"},be={class:"attribute-value"},fe={key:2,class:"attribute-item"},he={class:"attribute-value"},_e={key:3,class:"attribute-item"},ye={class:"attribute-value"},ke={key:4,class:"attribute-item"},we={class:"attribute-value"},Ae={key:5,class:"attribute-item"},Ce={class:"attribute-value"},xe={key:1,class:"voice-actors-section"},De={class:"voice-actors-header"},Ie={class:"voice-actors-list"},Be={key:0,class:"media-info-section"},$e={class:"media-info-label"},Me={class:"media-info-value"},Ee={key:1,class:"date-range"},Ne={key:0,class:"date-item"},je={key:1,class:"date-item"},Le={key:3,class:"tags-container"},Te={class:"card-footer"},Ve={class:"source-badge"},ze={class:"source-name"},Je={key:1,class:"info-card info-card-error"},qe={key:2,class:"info-card info-card-loading"},Fe=G({__name:"index",props:{data:{},loading:{type:Boolean},error:{type:Boolean},type:{},id:{}},setup(H){const g=H,E=new Map,N=new Map,x=$(!1),b=$(!1),D=$(null);let y=null;const j=u(()=>"type"in g&&"id"in g),B=u(()=>"data"in g&&g.data),a=u(()=>B.value?g.data:D.value),I=u(()=>a.value?.type==="character"),L=u(()=>a.value?.type==="media"),T=u(()=>a.value?a.value.source==="bangumi"?"Bangumi":a.value.source:""),V=u(()=>"ri:bilibili-line");function K(){a.value?.link&&window.open(a.value.link,"_blank")}function z(m){return m?new Date(m).toLocaleDateString("zh-CN"):""}const J=u(()=>{if(!L.value||!a.value)return[];const m=a.value,n=[];return m.episode&&n.push({label:"话数",value:m.episode}),m.rank&&n.push({label:"排名",value:`#${m.rank}`}),n}),O=u(()=>I.value?"card-layout-vertical":"card-layout-horizontal"),R=u(()=>I.value?"card-image-portrait":"card-image-landscape"),q=u(()=>B.value?g.loading||!1:x.value),F=u(()=>B.value?g.error||!1:b.value);async function Z(){const m=g,{type:n,id:f}=m;if(!f)return;const h=n==="character"?E:N;if(h.has(f)){D.value=h.get(f)??null,x.value=!1,b.value=!1;return}x.value=!0,b.value=!1,y&&y.abort(),y=new AbortController;try{const c=se.bangumi?.apiBase;if(!c){b.value=!0,console.error("[InfoCard] Bangumi API base not configured");return}let p,t;if(n==="character")if(p=await fetch(`${c}/api/character?id=${f}`,{signal:y.signal}),p.ok)if(t=await p.json(),t.id){let k=[];if(t.voiceActors&&Array.isArray(t.voiceActors)){const v=new Map;t.voiceActors.forEach(d=>{v.has(d.name)||v.set(d.name,{name:d.name||"未知声优",image:d.image||d.images?.medium||d.images?.small,link:d.link||(d.id?`https://bangumi.tv/person/${d.id}`:void 0)})}),k=Array.from(v.values()).slice(0,3)}let w="";if(t.infobox&&Array.isArray(t.infobox)){const v=t.infobox.find(d=>d.key==="别名");if(v&&Array.isArray(v.value)){const d=v.value.find(Q=>Q.k==="纯 假名"||Q.k==="假名");d&&(w=d.v)}}const _=new Map;t.infobox&&Array.isArray(t.infobox)&&t.infobox.forEach(v=>{typeof v.value=="string"&&_.set(v.key,v.value)});const P={type:"character",source:"bangumi",title:t.name||"未知角色",subtitle:w||void 0,description:t.summary||void 0,image:t.images?.large||t.images?.medium||void 0,rating:void 0,tags:void 0,link:`https://bangumi.tv/character/${t.id}`,nameJp:w||void 0,nameCn:t.name_cn||void 0,gender:_.get("性别")||_.get("性 别")||void 0,birthday:_.get("生日")||void 0,bloodType:_.get("血型")||void 0,height:_.get("身高")||void 0,weight:_.get("体重")||void 0,bwh:_.get("BWH")||void 0,voiceActors:k.length>0?k:void 0,metadata:{characterId:t.id}};D.value=P,E.set(f,P)}else b.value=!0;else b.value=!0;else if(n==="media")if(p=await fetch(`${c}/api/subject?id=${f}`,{signal:y.signal}),p.ok)if(t=await p.json(),t.id){const k={type:"media",source:"bangumi",title:t.name||"未命名作品",subtitle:t.name_cn||void 0,description:t.summary||void 0,image:t.images?.large||t.images?.common||void 0,rating:t.rating?.score||void 0,tags:t.tags?.map(w=>w.name).slice(0,5)||void 0,link:`https://bangumi.tv/subject/${t.id}`,episode:t.eps||void 0,status:t.status==="Air"?"on-air":t.status==="End"?"finished":"planned",airDate:t.date||void 0,rank:t.rank||void 0,metadata:{bangumiId:t.id,ratingCount:t.rating?.total||void 0}};D.value=k,N.set(f,k)}else b.value=!0;else b.value=!0}catch(c){c instanceof Error&&c.name!=="AbortError"&&(console.error("[InfoCard] Fetch error:",c),b.value=!0)}finally{x.value=!1}}return X(()=>j.value?g.id:null,()=>{j.value&&Z()},{immediate:!0}),Y(()=>{y&&y.abort()}),(m,n)=>{const f=ee,h=te;return!e(q)&&!e(F)&&e(a)?(s(),o("div",{key:0,class:"info-card","data-type":e(a).type,"data-source":e(a).source,title:`点击查看${e(T)}页面`},[i("div",{class:S(e(O))},[i("div",{class:S(["card-image-wrapper",e(R)])},[e(a).image?(s(),U(f,{key:0,src:e(a).image,alt:e(a).title,class:"card-image",loading:"lazy"},null,8,["src","alt"])):(s(),o("div",ne,[A(h,{name:e(I)?"ph:user-circle-bold":"ph:image-square-bold",class:"placeholder-icon"},null,8,["name"])])),e(a).rating?(s(),o("div",oe," ⭐ "+l(e(a).rating),1)):r("",!0)],2),i("div",re,[i("div",le,[i("h3",ce,l(e(a).title),1),e(a).subtitle?(s(),o("p",de,l(e(a).subtitle),1)):r("",!0)]),e(a).description?(s(),o("p",ue,l(e(a).description),1)):r("",!0),e(I)?(s(),o(C,{key:1},[e(a).gender||e(a).birthday||e(a).height||e(a).bloodType?(s(),o("div",ve,[e(a).gender?(s(),o("div",me,[n[0]||(n[0]=i("span",{class:"attribute-label"},"性别",-1)),i("span",pe,l(e(a).gender),1)])):r("",!0),e(a).birthday?(s(),o("div",ge,[n[1]||(n[1]=i("span",{class:"attribute-label"},"生日",-1)),i("span",be,l(e(a).birthday),1)])):r("",!0),e(a).height?(s(),o("div",fe,[n[2]||(n[2]=i("span",{class:"attribute-label"},"身高",-1)),i("span",he,l(e(a).height),1)])):r("",!0),e(a).bloodType?(s(),o("div",_e,[n[3]||(n[3]=i("span",{class:"attribute-label"},"血型",-1)),i("span",ye,l(e(a).bloodType),1)])):r("",!0),e(a).weight?(s(),o("div",ke,[n[4]||(n[4]=i("span",{class:"attribute-label"},"体重",-1)),i("span",we,l(e(a).weight),1)])):r("",!0),e(a).bwh?(s(),o("div",Ae,[n[5]||(n[5]=i("span",{class:"attribute-label"},"三围",-1)),i("span",Ce,l(e(a).bwh),1)])):r("",!0)])):r("",!0),e(a).voiceActors&&e(a).voiceActors.length>0?(s(),o("div",xe,[i("div",De,[A(h,{name:"ri:mic-line",class:"voice-actors-icon"}),n[6]||(n[6]=i("span",null,"声优",-1))]),i("div",Ie,[(s(!0),o(C,null,M(e(a).voiceActors,(c,p)=>(s(),o("div",{key:p,class:"voice-actor"},l(c.name),1))),128))])])):r("",!0)],64)):r("",!0),e(L)?(s(),o(C,{key:2},[e(J).length>0?(s(),o("div",Be,[(s(!0),o(C,null,M(e(J),(c,p)=>(s(),o("div",{key:`${c.label}-${p}`,class:"media-info-item"},[i("span",$e,l(c.label)+":",1),i("span",Me,l(c.value),1)]))),128))])):r("",!0),e(a).airDate||e(a).endDate?(s(),o("div",Ee,[e(a).airDate?(s(),o("span",Ne,[A(h,{name:"clarity:date-line",class:"date-icon"}),W(" "+l(z(e(a).airDate)),1)])):r("",!0),e(a).endDate?(s(),o("span",je,[A(h,{name:"clarity:date-line",class:"date-icon"}),W(" "+l(z(e(a).endDate)),1)])):r("",!0)])):r("",!0)],64)):r("",!0),e(a).tags&&e(a).tags.length>0?(s(),o("div",Le,[(s(!0),o(C,null,M(e(a).tags,c=>(s(),o("span",{key:c,class:"tag"},l(c),1))),128))])):r("",!0),i("div",Te,[i("div",Ve,[e(V)?(s(),U(h,{key:0,name:e(V),class:"source-icon"},null,8,["name"])):r("",!0),i("span",ze,l(e(T)),1)]),e(a).link?(s(),o("button",{key:0,class:"view-button",onClick:K},[n[7]||(n[7]=i("span",null,"查看详情",-1)),A(h,{name:"ri:arrow-right-line",class:"button-icon"})])):r("",!0)])])],2)],8,ie)):e(F)?(s(),o("div",Je,[...n[8]||(n[8]=[i("div",{class:"error-content"},[i("p",null,"加载失败"),i("small",null,"请检查 ID 是否正确或稍后重试")],-1)])])):e(q)?(s(),o("div",qe,[...n[9]||(n[9]=[i("div",{class:"loading-skeleton"},null,-1)])])):r("",!0)}}}),Ue=Object.assign(ae(Fe,[["__scopeId","data-v-a1600506"]]),{__name:"InfoCard"});export{Ue as default};
