import{J as se,g as ne,r as T,o as ie,N as ae,x as b,Q as h,aO as g,b6 as v,aS as _,aR as w,K as r,bs as ce,aV as F,b9 as M,aU as oe,aN as ue,a_ as N,aW as le,b5 as de}from"./C30-xQm5.js";import{f as L,_ as me,k as fe}from"./Cc1liqSW.js";import{_ as ye}from"./BNAXQ_5p.js";const k=new Map,$=new Map,x=new Map;function ge(s){if(!s)return[];const t=[],i=s.split(`
`);for(const u of i){if(!u.trim()||!u.includes("["))continue;const d=u.match(/\[(\d{2}):(\d{2})\.(\d+)\]/);if(!d)continue;const p=Number.parseInt(d[1]??"0",10),m=Number.parseInt(d[2]??"0",10),l=Number.parseInt(d[3]??"0",10),e=p*60+m+l/1e3;let n=u;n=n.replace(/\[\d{2}:\d{2}\.\d+\]/g,"").trim(),n&&t.push({time:e,text:n})}return t.sort((u,d)=>u.time-d.time)}function j(s){try{let t=s.match(/[?&]id=(\d+)/);return t?.[1]||(t=s.match(/\/song[/?#]*(\d+)/),t?.[1])||(t=s.match(/\/m\/song\/(\d+)/),t?.[1])?t[1]:null}catch{return null}}function O(s){const t=s.toLowerCase();return t.includes("music.163.com")||t.includes("netease")?"netease":t.includes("qq.com")||t.includes("y.qq.com")?"tencent":t.includes("kuwo.cn")?"kuwo":t.includes("xiami.com")?"xiami":t.includes("kugou.com")?"kugou":t.includes("youtube.com")||t.includes("youtu.be")?"youtube":"url"}function B(s,t){switch(t){case"netease":return j(s);case"tencent":return s.match(/(?:song\/|songid=)(\d+)/)?.[1]||null;default:return s.match(/(\d+)/)?.[1]||null}}async function he(s){const t=`netease:${s}`;if($.has(t))return $.get(t);const i=(async()=>{try{if(!L.meting?.apiServer)return console.warn("[MusicParser] Meting API server not configured"),{};const d=`${L.meting.apiServer.endsWith("/")?L.meting.apiServer:`${L.meting.apiServer}/`}?type=song&id=${s}`,p=await fetch(d);if(!p.ok)return console.warn(`[MusicParser] Song API returned status ${p.status}`),{};const m=await p.json();let l=m;if(Array.isArray(m)&&m.length>0&&(l=m[0]),!l||typeof l!="object")return console.warn("[MusicParser] Invalid response format:",m),{};const e=l.pic;let n;return l.url&&(n=l.url),{title:l.name||l.title||"未知曲目",artist:l.artist?Array.isArray(l.artist)?l.artist.map(y=>typeof y=="string"?y:y.name).join(" / "):String(l.artist):"未知艺术家",cover:e||void 0,url:n||void 0}}catch(u){return console.error(`[MusicParser] Failed to fetch netease metadata for id ${s}:`,u),{}}})();return $.set(t,i),i}async function pe(s){const t=`netease:lyrics:${s}`;if(x.has(t))return x.get(t);const i=(async()=>{try{if(!L.meting?.apiServer)return console.warn("[MusicParser] Meting API server not configured"),"";const d=`${L.meting.apiServer.endsWith("/")?L.meting.apiServer:`${L.meting.apiServer}/`}?server=netease&type=lrc&id=${s}`,p=await fetch(d);if(!p.ok)return console.warn(`[MusicParser] Lyric API returned status ${p.status}`),"";const m=await p.text();return!m||m.includes("暂无歌词")?"":m}catch(u){return console.error(`[MusicParser] Failed to fetch lyrics for id ${s}:`,u),""}})();return x.set(t,i),i}function A(){return{id:"",title:"解析失败",artist:"无法解析音乐信息",source:"url"}}function ve(s){if(!s||typeof s!="string")return A();if(k.has(s))return k.get(s);let t;try{if(s.trim().startsWith("{")){const i=JSON.parse(s);if(i&&typeof i=="object")return t={id:(i.id||"").toString(),title:(i.title||"未知曲目").toString(),artist:(i.artist||"未知艺术家").toString(),cover:i.cover?String(i.cover):void 0,url:i.url?String(i.url):void 0,source:i.source||"url",platform:i.platform?String(i.platform):void 0},k.set(s,t),t}if(s.trim().startsWith("http")){const i=s.trim(),u=O(i);return t={id:B(i,u)||"",title:"加载中...",artist:"加载中...",url:i,source:u,cover:void 0},k.set(s,t),t}throw new Error("Invalid format")}catch(i){console.warn("[MusicParser] Failed to parse music extension:",s,i),t=A()}return k.set(s,t),t}function _e(){k.clear(),$.clear(),x.clear()}function Le(s,t){if(!t)return null;switch(s){case"netease":return`https://music.163.com/#/song?id=${t}`;case"tencent":return`https://y.qq.com/n/yqq/song/${t}.html`;case"kuwo":return`https://www.kuwo.cn/play_detail/${t}`;case"xiami":return`https://www.xiami.com/song/${t}`;case"kugou":return`https://www.kugou.com/song/${t}`;case"youtube":return`https://www.youtube.com/watch?v=${t}`;case"url":return null;default:return null}}function we(){return{parseMusicExtension:ve,createEmptyMusic:A,clearCache:_e,detectMusicSource:O,extractMusicId:B,extractNeteaseMusicId:j,fetchNeteaseMetadata:he,fetchNeteaseLyrics:pe,getMusicLink:Le,parseLyrics:ge}}const Me={class:"music-player"},Pe={class:"music-info"},ke={key:0,class:"music-cover"},be={class:"music-details"},Se={key:0,class:"music-loading"},$e={class:"music-title"},xe={class:"music-artist"},Ie=["href","title"],Ee={key:1,class:"music-source-text"},Ce=["src"],Te={class:"music-actions"},Ne=["title"],Ae=["title","disabled"],ze={key:2,class:"lyrics-display"},qe={key:3,class:"music-error"},Fe=se({__name:"MusicPlayer",props:{music:{}},setup(s){const t=s,{fetchNeteaseMetadata:i,fetchNeteaseLyrics:u,detectMusicSource:d,extractMusicId:p,getMusicLink:m,parseLyrics:l}=we(),e=ne({isLoading:!1,hasError:!1,errorMessage:"",isPlaying:!1,currentTime:0,duration:0,isLyricsLoading:!1,currentLyricIndex:0,showLyrics:!1}),n=T(t.music),f=T(),y=T([]),U={netease:"网易云音乐",tencent:"QQ音乐",kuwo:"酷我音乐",xiami:"虾米音乐",kugou:"酷狗音乐",youtube:"YouTube",url:"外部链接"};ie(()=>t.music.id,c=>{c&&(n.value=t.music,R(),z())}),ae(()=>{n.value=t.music,z()});const I=b(()=>({title:n.value.title||"未知曲目",artist:n.value.artist||"未知艺术家",platform:n.value.platform||n.value.source||"音乐"})),E=b(()=>U[n.value.source]||n.value.source),C=b(()=>m(n.value.source,n.value.id)),W=b(()=>!!C.value),D=b(()=>e.duration?e.currentTime/e.duration*100:0);function R(){e.isPlaying&&f.value&&f.value.pause(),e.isPlaying=!1,e.currentTime=0,e.duration=0,e.hasError=!1,e.errorMessage="",e.showLyrics=!1,e.currentLyricIndex=0,e.isLyricsLoading=!1,y.value=[]}async function z(){let c=n.value.source,a=n.value.id;if(n.value.url&&!a&&(c=d(n.value.url),a=p(n.value.url,c)||"",n.value={...n.value,source:c,id:a}),c!=="netease"||!a){e.isLoading=!1;return}try{e.isLoading=!0,e.hasError=!1,e.errorMessage="";const o=await i(a);(o.title||o.artist||o.cover||o.url)&&(n.value={...n.value,title:o.title||n.value.title,artist:o.artist||n.value.artist,cover:o.cover||n.value.cover,url:o.url||n.value.url}),await V(a)}catch(o){console.error("[MusicPlayer] Failed to fetch metadata:",o),e.hasError=!0,o instanceof TypeError?e.errorMessage="网络连接失败，请检查网络设置":o instanceof SyntaxError?e.errorMessage="音乐信息格式错误":e.errorMessage="加载音乐信息失败"}finally{e.isLoading=!1}}async function V(c){try{e.isLyricsLoading=!0;const a=await u(c);a&&(y.value=l(a),e.currentLyricIndex=0,e.showLyrics=!0)}catch(a){console.warn("[MusicPlayer] Failed to fetch lyrics:",a),y.value=[]}finally{e.isLyricsLoading=!1}}function q(c){if(!Number.isFinite(c))return"0:00";const a=Math.floor(c/60),o=Math.floor(c%60);return`${a}:${o<10?"0":""}${o}`}function K(){f.value&&(e.isPlaying?f.value.pause():f.value.play().catch(c=>{console.warn("[MusicPlayer] Failed to play audio:",c),e.hasError=!0}))}function Q(){e.isPlaying=!1}function J(){e.isPlaying=!0}function Y(){e.isPlaying=!1}function Z(){console.error("[MusicPlayer] Audio playback error"),e.isPlaying&&(e.hasError=!0,e.errorMessage="音乐播放失败，可能文件不可用或格式不支持"),e.isPlaying=!1}function G(){if(!f.value)return;const c=f.value.currentTime;Math.abs(c-e.currentTime)>=.1&&(e.currentTime=c),H(c)}function H(c){if(y.value.length!==0)for(let a=y.value.length-1;a>=0;a--){const o=y.value[a];if(o&&o.time<=c){e.currentLyricIndex=a;break}}}function X(){f.value&&(e.duration=f.value.duration)}function ee(c){if(f.value&&e.duration){const a=c/100*e.duration;f.value.currentTime=a,e.currentTime=a}}return(c,a)=>{const o=ce,P=me,te=ye,re=fe;return g(),h("div",Me,[v("div",Pe,[r(n).cover?(g(),h("div",ke,[_(o,{src:r(n).cover,alt:r(I).title,class:"cover-image",loading:"lazy",fit:"cover"},null,8,["src","alt"])])):w("",!0),v("div",be,[r(e).isLoading?(g(),h("div",Se,[_(P,{name:"eos-icons:loading",size:"14"}),a[1]||(a[1]=v("span",null,"加载中...",-1))])):(g(),h(F,{key:1},[v("div",$e,M(r(I).title),1),v("div",xe,M(r(I).artist),1),r(W)&&r(C)?(g(),h("a",{key:0,href:r(C),target:"_blank",rel:"noopener noreferrer",class:"music-source",title:`在 ${r(E)} 中打开`},[_(P,{name:"mdi:music",size:"14"}),v("span",null,M(r(E)),1)],8,Ie)):(g(),h("div",Ee,[_(P,{name:"mdi:music",size:"14"}),v("span",null,M(r(E)),1)]))],64))])]),_(re,null,{default:oe(()=>[r(n).url?(g(),h("audio",{key:0,ref_key:"audioElement",ref:f,src:r(n).url,crossorigin:"anonymous",onEnded:Q,onPlay:J,onPause:Y,onError:Z,onTimeupdate:G,onLoadedmetadata:X},null,40,Ce)):w("",!0),r(e).isPlaying&&r(e).duration>0?(g(),ue(te,{key:1,percent:r(D),"current-time":q(r(e).currentTime),duration:q(r(e).duration),onChange:ee},null,8,["percent","current-time","duration"])):w("",!0),v("div",Te,[r(n).url?(g(),h("button",{key:0,class:N(["play-button",{playing:r(e).isPlaying}]),title:r(e).isPlaying?"暂停":"播放",onClick:K},[_(P,{name:r(e).isPlaying?"mdi:pause-circle":"mdi:play-circle",size:"20"},null,8,["name"]),v("span",null,M(r(e).isPlaying?"暂停":"播放"),1)],10,Ne)):w("",!0),r(y).length>0||r(e).isLyricsLoading?(g(),h("button",{key:1,class:N(["lyrics-toggle-button",{active:r(e).showLyrics,loading:r(e).isLyricsLoading}]),title:r(e).showLyrics?"隐藏歌词":"显示歌词",disabled:r(e).isLyricsLoading,onClick:a[0]||(a[0]=S=>r(e).showLyrics=!r(e).showLyrics)},[_(P,{name:r(e).isLyricsLoading?"eos-icons:loading":"mdi:text-box",size:"18"},null,8,["name"])],10,Ae)):w("",!0)]),r(y).length>0&&r(e).showLyrics&&r(e).isPlaying?(g(),h("div",ze,[(g(),h(F,null,le([-1,0,1],S=>v("div",{key:`${r(e).currentLyricIndex}-${S}`,class:N(["lyric-line",{active:S===0}])},M(r(y)[r(e).currentLyricIndex+S]?.text||""),3)),64))])):w("",!0),r(e).hasError&&r(n).url?(g(),h("div",qe,[_(P,{name:"mdi:alert-circle",size:"16"}),v("span",null,M(r(e).errorMessage||"音乐加载失败"),1)])):w("",!0)]),_:1})])}}}),je=Object.assign(de(Fe,[["__scopeId","data-v-5b8b694c"]]),{__name:"MusicPlayer"}),We=Object.freeze(Object.defineProperty({__proto__:null,default:je},Symbol.toStringTag,{value:"Module"}));export{We as M,je as _,we as u};
