import{g as z,J as D,Q as y,aO as u,aV as O,b6 as g,aR as P,a_ as le,aS as _,b9 as M,b5 as F,r as A,o as ce,N as ue,aE as de,x,K as t,ba as me,aU as fe,aN as U}from"./DeZJN128.js";import{_ as V,t as ye,g as ge,l as he,L as ve,M as _e,N as pe}from"./C9qoQ-7R.js";import"./D-deoX8n.js";function Pe(){const s=z({isLoading:!1,currentIndex:0,lines:[]}),m=new Map;function e(f,E){if(s.lines.length===0)return;let c=0,h=s.lines.length-1,d=0;for(;c<=h;){const l=Math.floor((c+h)/2),v=s.lines[l];v&&v.time<=f?(d=l,c=l+1):h=l-1}d!==s.currentIndex&&(s.currentIndex=d,m.clear())}function L(f,E){if(s.lines.length===0)return 0;const c=s.lines[s.currentIndex],h=s.lines[s.currentIndex+1];if(!c)return 0;let d=0;if(h){const l=h.time-c.time;if(l<=0)d=100;else{const v=f-c.time;d=v>=l?100:Math.max(0,v/l*100)}}else{const l=f-c.time;d=Math.min(100,l/3*100)}return d}function k(){s.currentIndex=0,s.isLoading=!1,s.lines=[],m.clear()}function b(f){s.lines=f,s.currentIndex=0,m.clear()}function p(f){s.isLoading=f}return{lyricsState:s,updateCurrentLyric:e,calculateLyricProgress:L,resetLyrics:k,setLyrics:b,setLoading:p}}const Me={class:"music-actions"},Le=["title"],xe={key:0,class:"music-error"},ke=D({__name:"PlaybackControls",props:{isPlaying:{type:Boolean},isLoading:{type:Boolean},hasError:{type:Boolean},errorMessage:{},musicUrl:{}},emits:["togglePlay"],setup(s,{emit:m}){const e=m;function L(){e("togglePlay")}return(k,b)=>{const p=V;return u(),y(O,null,[g("div",Me,[s.musicUrl?(u(),y("button",{key:0,class:le(["play-button",{playing:s.isPlaying}]),title:s.isPlaying?"暂停":"播放",onClick:L},[_(p,{name:s.isPlaying?"mdi:pause-circle":"mdi:play-circle",size:"20"},null,8,["name"]),g("span",null,M(s.isPlaying?"暂停":"播放"),1)],10,Le)):P("",!0)]),s.hasError&&s.musicUrl?(u(),y("div",xe,[_(p,{name:"mdi:alert-circle",size:"16"}),g("span",null,M(s.errorMessage||"音乐加载失败"),1)])):P("",!0)],64)}}}),be=Object.assign(F(ke,[["__scopeId","data-v-5ad36d7e"]]),{__name:"PlaybackControls"}),Ee={class:"music-player"},Te={class:"music-info"},Ie={key:0,class:"music-cover"},Ce={class:"music-details"},we={key:0,class:"music-loading"},Be={class:"music-title"},Ne={class:"music-artist"},Se=["href","title"],$e={key:1,class:"music-source-text"},Ae=["src"],Ue=D({__name:"MusicPlayer",props:{music:{}},setup(s){const m=s,e=z({isLoading:!1,hasError:!1,errorMessage:"",isPlaying:!1,currentTime:0,duration:0,hasPlayedBefore:!1}),{fetchNeteaseMetadata:L,fetchNeteaseLyrics:k,detectMusicSource:b,extractMusicId:p,getMusicLink:f,parseLyrics:E}=ge(),{lyricsState:c,updateCurrentLyric:h,resetLyrics:d,setLyrics:l,setLoading:v}=Pe(),G=ye(),n=A(m.music),i=A(),Q={netease:"网易云音乐",tencent:"QQ音乐",kuwo:"酷我音乐",xiami:"虾米音乐",kugou:"酷狗音乐",youtube:"YouTube",url:"外部链接"};ce(()=>m.music.id,a=>{a&&(n.value=m.music,J(),B())}),ue(()=>{n.value=m.music,B(),ee()}),de(()=>{K()});const T=x(()=>({title:n.value.title||"未知曲目",artist:n.value.artist||"未知艺术家",platform:n.value.platform||n.value.source||"音乐"})),I=x(()=>Q[n.value.source]||n.value.source),C=x(()=>f(n.value.source,n.value.id)),j=x(()=>!!C.value),R=x(()=>e.duration?e.currentTime/e.duration*100:0);function J(){e.isPlaying&&i.value&&i.value.pause(),e.isPlaying=!1,e.currentTime=0,e.duration=0,e.hasError=!1,e.errorMessage="",e.hasPlayedBefore=!1,d()}function K(){ae(),i.value&&(i.value.pause(),i.value.src=""),d()}async function B(){let a=n.value.source,r=n.value.id;if(n.value.url&&!r&&(a=b(n.value.url),r=p(n.value.url,a)||"",n.value={...n.value,source:a,id:r}),a!=="netease"||!r){e.isLoading=!1;return}try{e.isLoading=!0,e.hasError=!1,e.errorMessage="";const o=await L(r);(o.title||o.artist||o.cover||o.url)&&(n.value={...n.value,title:o.title||n.value.title,artist:o.artist||n.value.artist,cover:o.cover||n.value.cover,url:o.url||n.value.url}),await Z(r)}catch(o){Y(o,"fetchMusicMetadata")}finally{e.isLoading=!1}}function Y(a,r){console.error(`[MusicPlayer] ${r}:`,a),e.hasError=!0,a instanceof TypeError?e.errorMessage="网络连接失败，请检查网络设置":a instanceof SyntaxError?e.errorMessage="音乐信息格式错误":a instanceof Error?e.errorMessage=a.message||"操作失败":e.errorMessage="加载音乐信息失败"}async function Z(a){try{v(!0);const r=await k(a);if(r){const o=E(r);l(o)}}catch(r){console.warn("[MusicPlayer] Failed to fetch lyrics:",r),l([])}finally{v(!1)}}function N(a){if(!Number.isFinite(a))return"0:00";const r=Math.floor(a/60),o=Math.floor(a%60);return`${r}:${o<10?"0":""}${o}`}function S(){i.value&&(e.isPlaying?i.value.pause():i.value.play().catch(a=>{console.warn("[MusicPlayer] Failed to play audio:",a),e.hasError=!0,e.errorMessage="音乐播放失败，可能文件不可用或格式不支持"}))}function q(){e.isPlaying=!1}function H(){e.isPlaying=!0,e.hasPlayedBefore=!0}function W(){e.isPlaying=!1}function X(){console.error("[MusicPlayer] Audio playback error"),e.isPlaying&&(e.hasError=!0,e.errorMessage="音乐播放失败，可能文件不可用或格式不支持"),e.isPlaying=!1}function ee(){document.addEventListener("play",$,!0)}function ae(){document.removeEventListener("play",$,!0)}function $(a){const r=a.target;i.value&&r!==i.value&&r.tagName==="AUDIO"&&e.isPlaying&&S()}const te=pe(a=>{h(a,e.currentTime)},50);function se(){if(!i.value)return;const a=i.value.currentTime;Math.abs(a-e.currentTime)>=.1&&(e.currentTime=a),te(a)}function ne(){i.value&&(e.duration=i.value.duration)}function re(a){if(i.value&&e.duration){const r=a/100*e.duration;i.value.currentTime=r,e.currentTime=r,h(r,e.currentTime)}}return(a,r)=>{const o=me,w=V,ie=ve,oe=he;return u(),y("div",Ee,[g("div",Te,[t(n).cover?(u(),y("div",Ie,[_(o,{src:t(n).cover,alt:t(T).title,class:"cover-image",loading:"lazy",fit:"cover"},null,8,["src","alt"])])):P("",!0),g("div",Ce,[t(e).isLoading?(u(),y("div",we,[_(w,{name:"eos-icons:loading",size:"14"}),r[0]||(r[0]=g("span",null,"加载中...",-1))])):(u(),y(O,{key:1},[g("div",Be,M(t(T).title),1),g("div",Ne,M(t(T).artist),1),t(j)&&t(C)?(u(),y("a",{key:0,href:t(C),target:"_blank",rel:"noopener noreferrer",class:"music-source",title:`在 ${t(I)} 中打开`},[_(w,{name:"mdi:music",size:"14"}),g("span",null,M(t(I)),1)],8,Se)):(u(),y("div",$e,[_(w,{name:"mdi:music",size:"14"}),g("span",null,M(t(I)),1)]))],64))])]),_(oe,null,{default:fe(()=>[t(n).url?(u(),y("audio",{key:0,ref_key:"audioElement",ref:i,src:t(n).url,crossorigin:"anonymous",onEnded:q,onPlay:H,onPause:W,onError:X,onTimeupdate:se,onLoadedmetadata:ne},null,40,Ae)):P("",!0),t(e).isPlaying&&t(e).duration>0?(u(),U(ie,{key:1,percent:t(R),"current-time":N(t(e).currentTime),duration:N(t(e).duration),onChange:re},null,8,["percent","current-time","duration"])):P("",!0),_(be,{"is-playing":t(e).isPlaying,"is-loading":t(e).isLoading,"has-error":t(e).hasError,"error-message":t(e).errorMessage,"music-url":t(n).url,onTogglePlay:S},null,8,["is-playing","is-loading","has-error","error-message","music-url"]),t(c).lines.length>0&&t(G).showMusicLyrics&&t(e).hasPlayedBefore?(u(),U(_e,{key:2,lines:t(c).lines,"current-index":t(c).currentIndex},null,8,["lines","current-index"])):P("",!0)]),_:1})])}}}),Fe=Object.assign(F(Ue,[["__scopeId","data-v-66776212"]]),{__name:"MusicPlayer"});export{Fe as default};
