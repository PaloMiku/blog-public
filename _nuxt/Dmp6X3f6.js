import{y as W,r as v,z as I,o as K,bp as U,V as X,d as n,e as r,f as c,J as t,h as i,I as D,t as y,g as E,C as Y,Q as Z,F as q,R as z,b1 as ee,n as te,aM as B,_ as ae}from"./BwfZDcNc.js";import{s as se}from"./B9d7dgng.js";const ne={class:"galgame-wrapper"},re={key:0,class:"galgame-error"},oe={key:1,class:"md-galgame ai-galgame"},le={class:"ai-galgame-header"},ie={class:"ai-galgame-title"},ce={class:"ai-galgame-label"},ue={class:"ai-galgame-toolbar"},ve=["title"],ge={key:0,class:"galgame-speaker"},de={class:"galgame-text"},me={key:0,class:"typewriter-caret"},fe={key:2,class:"galgame-hint"},he={key:0,class:"galgame-choices"},ye=["onClick"],pe={key:1,class:"galgame-ending"},_e={key:2,class:"galgame-history-panel"},ke={class:"history-header"},be={class:"history-title"},we={class:"history-list"},xe={key:0,class:"history-empty"},Ce=["onClick"],Te={class:"history-index"},Ie={class:"history-content"},Ee={key:0,class:"history-choice"},$e={key:1,class:"history-paragraph"},Se={key:3,class:"galgame-empty"},Ve=W({__name:"Galgame",props:{data:{},showHistory:{type:Boolean,default:!0},showRestart:{type:Boolean,default:!0}},setup(L){const p=L,g=v(null),f=v(""),x=v(""),u=v([]),b=v({}),d=v(!1),h=v(!1),_=v(0),S=v(""),V=v(!1);let C=null;const o=I(()=>g.value?g.value.paragraphs.find(e=>e.id===x.value):null),T=I(()=>o.value?.choices?o.value.choices.filter(e=>e.visible===void 0?!0:typeof e.visible=="boolean"?e.visible:typeof e.visible=="function"?e.visible():!0):[]),F=I(()=>{if(!o.value)return[];const e=o.value.text;return Array.isArray(e)?e:e.split(`
`)}),k=I(()=>_.value<F.value.length-1),N=I(()=>F.value.slice(0,_.value+1));async function O(e){try{const a=e.startsWith("/")?e:`/assets/galgames/${e}`,s=await fetch(a);if(!s.ok)throw new Error(`Failed to load: ${s.statusText}`);return await s.json()}catch(a){return f.value=`加载游戏数据失败: ${a instanceof Error?a.message:String(a)}`,console.error(f.value,a),null}}async function H(){try{f.value="";let e=null;if(p.data&&(typeof p.data=="string"?e=await O(p.data):e=p.data),!e){f.value="未提供有效的游戏数据";return}g.value=e,x.value=e.start,_.value=0,b.value={...e.globalMarks},u.value=[],d.value=!1,h.value=!1,M(e.start)}catch(e){f.value=`初始化失败: ${e instanceof Error?e.message:String(e)}`,console.error(f.value,e)}}function M(e,a){u.value.push({paragraphId:e,choiceText:a,timestamp:Date.now()})}function R(e){M(e.next,e.text),e.mark&&(typeof e.mark=="string"?b.value[e.mark]=!0:Object.assign(b.value,e.mark)),x.value=e.next,_.value=0,o.value?.isEnding&&(d.value=!0),B(()=>{const a=document.querySelector(".galgame-container");a&&a.scrollIntoView({behavior:"smooth",block:"start"})})}function G(){if(o.value){if(k.value){_.value++;return}T.value.length>0||o.value.auto&&(M(o.value.auto),x.value=o.value.auto,_.value=0,o.value?.isEnding&&(d.value=!0),B(()=>{const e=document.querySelector(".galgame-container");e&&e.scrollIntoView({behavior:"smooth",block:"start"})}))}}function A(e){if(!e.target.closest("button")){if(k.value){G();return}if(d.value&&k.value){G();return}!d.value&&T.value.length>0||G()}}function P(){H()}function J(e){if(e<0||e>=u.value.length)return;const a=u.value[e];if(a){x.value=a.paragraphId,_.value=0,u.value.splice(e+1),b.value={...g.value?.globalMarks};for(let s=1;s<=e;s++){const l=u.value[s];if(!l)continue;const m=u.value[s-1];if(!m)continue;const w=g.value?.paragraphs.find(j=>j.id===m.paragraphId);if(!w)continue;const $=w.choices?.find(j=>j.text===l.choiceText);$?.mark&&(typeof $.mark=="string"?b.value[$.mark]=!0:Object.assign(b.value,$.mark))}h.value=!1,B(()=>{const s=document.querySelector(".galgame-container");s&&s.scrollIntoView({behavior:"smooth",block:"start"})})}}K(()=>{H()}),U(()=>{p.data&&H()});function Q(){C&&clearInterval(C);const e=N.value;if(e.length===0)return;const a=e[e.length-1]||"";V.value=!0;const s=e.slice(0,-1).join(`
`);S.value=s+(s?`
`:"");let l=0;C=se(()=>{l<=a.length?(S.value=s+(s?`
`:"")+a.substring(0,l),l++):(C&&clearInterval(C),V.value=!1)},50)}return X(N,()=>{Q()},{immediate:!0}),(e,a)=>{const s=Y;return r(),n("div",ne,[t(f)?(r(),n("div",re,[a[2]||(a[2]=i("strong",null,"错误:",-1)),D(" "+y(t(f)),1)])):c("",!0),t(o)&&t(g)?(r(),n("div",oe,[i("div",le,[i("div",ie,[E(s,{name:"proicons:game",class:"ai-icon-galgame"}),i("span",ce,y(t(g).title||"Galgame"),1)]),i("div",ue,[p.showHistory?(r(),n("button",{key:0,class:"toolbar-btn",title:t(h)?"关闭历史":"打开历史",onClick:a[0]||(a[0]=l=>h.value=!t(h))},[E(s,{name:"material-symbols:history"})],8,ve)):c("",!0),p.showRestart?(r(),n("button",{key:1,class:"toolbar-btn",title:"重新开始",onClick:P},[E(s,{name:"material-symbols:restart-alt"})])):c("",!0)])]),i("div",{class:"ai-galgame-content",onClick:A},[t(o).speaker?(r(),n("div",ge,y(t(o).speaker),1)):c("",!0),t(o).background?(r(),n("div",{key:1,class:"galgame-background",style:Z({backgroundImage:`url(${t(o).background})`})},null,4)):c("",!0),i("div",de,[D(y(t(S)),1),t(V)?(r(),n("span",me,"_")):c("",!0)]),t(k)||t(d)&&t(k)||!t(d)&&t(T).length===0?(r(),n("div",fe," 点击继续 ")):c("",!0)]),!t(d)&&!t(k)&&t(T).length>0?(r(),n("div",he,[(r(!0),n(q,null,z(t(T),(l,m)=>(r(),n("button",{key:m,class:"choice-btn",onClick:ee(w=>R(l),["stop"])},y(l.text),9,ye))),128))])):c("",!0),t(d)&&!t(k)?(r(),n("div",pe,[i("button",{class:"ending-btn",onClick:P}," 重新开始 ")])):c("",!0)])):c("",!0),t(h)?(r(),n("div",_e,[i("div",ke,[i("div",be,[E(s,{name:"material-symbols:history",class:"history-icon"}),a[3]||(a[3]=i("h3",null,"历史回顾",-1))]),i("button",{title:"关闭",class:"history-close",onClick:a[1]||(a[1]=l=>h.value=!1)},[E(s,{name:"yesicon:close"})])]),i("div",we,[t(u).length===0?(r(),n("div",xe," 还没有历史记录 ")):(r(!0),n(q,{key:1},z(t(u),(l,m)=>(r(),n("button",{key:m,class:te(["history-item",{active:m===t(u).length-1}]),onClick:w=>J(m)},[i("span",Te,y(m+1),1),i("span",Ie,[l.choiceText?(r(),n("span",Ee,"→ "+y(l.choiceText),1)):(r(),n("span",$e,y(t(g).paragraphs.find(w=>w.id===l.paragraphId)?.speaker||"开始"),1))])],10,Ce))),128))])])):c("",!0),!t(o)&&!t(g)&&!t(h)?(r(),n("div",Se," 无游戏数据 ")):c("",!0)])}}}),Ge=Object.assign(ae(Ve,[["__scopeId","data-v-788889c8"]]),{__name:"Galgame"});export{Ge as default};
