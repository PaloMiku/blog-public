import{aI as J,z as G,d as f,e as c,F as Y,h as l,f as P,n as Me,g as m,J as Z,t as M,_ as q,al as Le,r as E,ad as j,G as p,aJ as ke,o as H,aC as xe,c as we,H as be,w as $,L as t,$ as Te,R as Ee,Q as K,aK as Ce,O as Ie,aL as Se,aM as $e,a2 as Be,aN as ze}from"./CyAqJ3nm.js";function De(){const n=J({isLoading:!1,currentIndex:0,lines:[]}),g=new Map;function e(h,B){if(n.lines.length===0)return;let u=0,v=n.lines.length-1,y=0;for(;u<=v;){const d=Math.floor((u+v)/2),_=n.lines[d];_&&_.time<=h?(y=d,u=d+1):v=d-1}y!==n.currentIndex&&(n.currentIndex=y,g.clear())}function x(h,B){if(n.lines.length===0)return 0;const u=n.lines[n.currentIndex],v=n.lines[n.currentIndex+1];if(!u)return 0;let y=0;if(v){const d=v.time-u.time;if(d<=0)y=100;else{const _=h-u.time;y=_>=d?100:Math.max(0,_/d*100)}}else{const d=h-u.time;y=Math.min(100,d/3*100)}return y}function C(){n.currentIndex=0,n.isLoading=!1,n.lines=[],g.clear()}function I(h){n.lines=h,n.currentIndex=0,g.clear()}function L(h){n.isLoading=h}return{lyricsState:n,updateCurrentLyric:e,calculateLyricProgress:x,resetLyrics:C,setLyrics:I,setLoading:L}}const Ne={class:"music-actions"},Ae=["title"],Fe={class:"button-text"},Ue={key:0,class:"music-error"},Oe=G({__name:"PlaybackControls",props:{isPlaying:{type:Boolean},isLoading:{type:Boolean},hasError:{type:Boolean},errorMessage:{},musicUrl:{}},emits:["togglePlay"],setup(n,{emit:g}){const e=g;function x(){e("togglePlay")}return(C,I)=>{const L=Z;return c(),f(Y,null,[l("div",Ne,[n.musicUrl?(c(),f("button",{key:0,class:Me(["play-button",{playing:n.isPlaying}]),title:n.isPlaying?"暂停":"播放",onClick:x},[m(L,{name:n.isPlaying?"ph:pause-fill":"ph:play-fill",size:"20"},null,8,["name"]),l("span",Fe,M(n.isPlaying?"暂停":"播放"),1)],10,Ae)):P("",!0)]),n.hasError&&n.musicUrl?(c(),f("div",Ue,[m(L,{name:"mdi:alert-circle",size:"16"}),l("span",null,M(n.errorMessage||"音乐加载失败"),1)])):P("",!0)],64)}}}),Ke=Object.assign(q(Oe,[["__scopeId","data-v-d4b0abc6"]]),{__name:"PlaybackControls"}),Re={class:"music-player"},Qe=["src"],Ve={class:"music-left-column"},We={class:"player-main-content"},je={key:0,class:"music-cover"},He={class:"music-info-text"},Je={key:0,class:"music-loading"},Ge=["title"],Ye=["title"],Ze={class:"music-source-row"},qe=["href","title"],Xe={class:"source-name"},es={key:1,class:"music-source-text"},ss={class:"source-name"},ts={class:"music-control-wrapper"},as={class:"player-progress-bar"},ns={class:"lyrics-container scrollbar-y"},is=["onKeydown"],rs=G({__name:"MusicPlayer",props:{music:{}},setup(n){const g=n,e=J({isLoading:!1,hasError:!1,errorMessage:"",isPlaying:!1,currentTime:0,duration:0,hasPlayedBefore:!1}),{fetchNeteaseMetadata:x,fetchNeteaseLyrics:C,detectMusicSource:I,extractMusicId:L,getMusicLink:h,parseLyrics:B}=be(),{lyricsState:u,updateCurrentLyric:v,resetLyrics:y,setLyrics:d,setLoading:_}=De(),X=Le(),a=E(g.music),o=E(),z=E(null),k=E("original"),D=E(!1),ee={netease:"网易云音乐",tencent:"QQ音乐",kuwo:"酷我音乐",xiami:"虾米音乐",kugou:"酷狗音乐",youtube:"YouTube",url:"外部链接"};j(()=>g.music.id,s=>{s&&(a.value=g.music,re(),R())});const{currentPlayingId:S,setPlaying:se,stop:N}=ke(),te=`music-player-fallback-${Date.now().toString(36)}-${Math.random().toString(36).slice(2)}`,w=p(()=>a.value?.id?`music-player-${a.value.id}`:te);j(S,s=>{o.value&&s!==w.value&&e.isPlaying&&V()}),H(()=>{a.value=g.music,R(),U(),window.addEventListener("resize",U)}),H(()=>{xe(()=>{const s=z.value;s?.getMode&&(k.value=s.getMode())})}),we(()=>{window.removeEventListener("resize",U),oe()});const b=p(()=>({title:a.value.title||"未知曲目",artist:a.value.artist||"未知艺术家",platform:a.value.platform||a.value.source||"音乐"})),A=p(()=>ee[a.value.source]||a.value.source),F=p(()=>h(a.value.source,a.value.id)),ae=p(()=>!!F.value),ne=p(()=>e.duration?e.currentTime/e.duration*100:0),ie=p(()=>u.lines.length===0||!X.showMusicLyrics?!1:D.value||e.hasPlayedBefore);function U(){D.value=window.innerWidth>=600}function re(){e.isPlaying&&o.value&&o.value.pause(),e.isPlaying=!1,e.currentTime=0,e.duration=0,e.hasError=!1,e.errorMessage="",e.hasPlayedBefore=!1,y()}function oe(){o.value&&(o.value.pause(),o.value.src=""),y()}async function R(){let s=a.value.source,i=a.value.id;if(a.value.url&&!i&&(s=I(a.value.url),i=L(a.value.url,s)||"",a.value={...a.value,source:s,id:i}),s!=="netease"||!i){e.isLoading=!1;return}try{e.isLoading=!0,e.hasError=!1,e.errorMessage="";const r=await x(i);(r.title||r.artist||r.cover||r.url)&&(a.value={...a.value,title:r.title||a.value.title,artist:r.artist||a.value.artist,cover:r.cover||a.value.cover,url:r.url||a.value.url}),await ce(i)}catch(r){le(r,"fetchMusicMetadata")}finally{e.isLoading=!1}}function le(s,i){console.error(`[MusicPlayer] ${i}:`,s),e.hasError=!0,s instanceof TypeError?e.errorMessage="网络连接失败，请检查网络设置":s instanceof SyntaxError?e.errorMessage="音乐信息格式错误":s instanceof Error?e.errorMessage=s.message||"操作失败":e.errorMessage="加载音乐信息失败"}async function ce(s){try{_(!0);const i=await C(s);if(i){const r=B(i);d(r)}}catch(i){console.warn("[MusicPlayer] Failed to fetch lyrics:",i),d([])}finally{_(!1)}}function Q(s){if(!Number.isFinite(s))return"0:00";const i=Math.floor(s/60),r=Math.floor(s%60);return`${i}:${r<10?"0":""}${r}`}function V(){o.value&&(e.isPlaying?o.value.pause():o.value.play().catch(s=>{console.warn("[MusicPlayer] Failed to play audio:",s),e.hasError=!0,e.errorMessage="音乐播放失败，可能文件不可用或格式不支持"}))}function ue(){e.isPlaying=!1,S.value===w.value&&N()}function de(){e.isPlaying=!0,e.hasPlayedBefore=!0,se(w.value)}function me(){e.isPlaying=!1,S.value===w.value&&N()}function fe(){console.error("[MusicPlayer] Audio playback error"),e.isPlaying&&(e.hasError=!0,e.errorMessage="音乐播放失败，可能文件不可用或格式不支持"),e.isPlaying=!1,S.value===w.value&&N()}const ye=ze(s=>{v(s,e.currentTime)},50);function ge(){if(!o.value)return;const s=o.value.currentTime;Math.abs(s-e.currentTime)>=.1&&(e.currentTime=s),ye(s)}function he(){o.value&&(e.duration=o.value.duration)}function ve(s){o.value&&(o.value.currentTime=s,e.currentTime=s,v(s,e.currentTime),o.value.play().catch(i=>{console.warn("[MusicPlayer] Play after seek failed:",i)}))}function W(){const s=z.value;s?.cycleLyricDisplayMode&&s.cycleLyricDisplayMode()}function _e(s){if(o.value&&e.duration){const i=s/100*e.duration;o.value.currentTime=i,e.currentTime=i,v(i,e.currentTime)}}return(s,i)=>{const r=Te,pe=Ee,T=Z,Pe=Ce;return c(),f("div",Re,[m(r,null,{default:$(()=>[t(a).url?(c(),f("audio",{key:0,ref_key:"audioElement",ref:o,src:t(a).url,crossorigin:"anonymous",onEnded:ue,onPlay:de,onPause:me,onError:fe,onTimeupdate:ge,onLoadedmetadata:he},null,40,Qe)):P("",!0)]),_:1}),l("div",Ve,[l("div",We,[t(a).cover?(c(),f("div",je,[m(pe,{src:t(a).cover,alt:t(b).title,class:"cover-image",loading:"lazy",fit:"cover"},null,8,["src","alt"])])):P("",!0),l("div",He,[t(e).isLoading?(c(),f("div",Je,[m(T,{name:"eos-icons:loading",size:"14"}),i[1]||(i[1]=l("span",null,"加载中...",-1))])):(c(),f(Y,{key:1},[l("div",{class:"music-title",title:t(b).title},M(t(b).title),9,Ge),l("div",{class:"music-artist",title:t(b).artist},M(t(b).artist),9,Ye),l("div",Ze,[t(ae)&&t(F)?(c(),f("a",{key:0,href:t(F),target:"_blank",rel:"noopener noreferrer",class:"music-source-link",title:`在 ${t(A)} 中打开`},[t(a).source==="netease"?(c(),K(T,{key:0,name:"simple-icons:neteasecloudmusic",size:"12"})):(c(),K(T,{key:1,name:"mdi:music",size:"12"})),l("span",Xe,M(t(A)),1)],8,qe)):(c(),f("div",es,[m(T,{name:"mdi:music",size:"12"}),l("span",ss,M(t(A)),1)]))])],64))]),l("div",ts,[m(r,null,{default:$(()=>[m(Ke,{"is-playing":t(e).isPlaying,"is-loading":t(e).isLoading,"has-error":t(e).hasError,"error-message":t(e).errorMessage,"music-url":t(a).url,onTogglePlay:V},null,8,["is-playing","is-loading","has-error","error-message","music-url"])]),_:1})])]),m(r,null,{default:$(()=>[l("div",as,[t(a).url&&t(e).duration>0?(c(),K(Pe,{key:0,percent:t(ne),"current-time":Q(t(e).currentTime),duration:Q(t(e).duration),onChange:_e},null,8,["percent","current-time","duration"])):P("",!0)])]),_:1})]),m(r,null,{default:$(()=>[t(ie)?(c(),f("div",{key:0,class:"music-right-column",style:Ie({maxHeight:t(D)?"240px":"180px"})},[l("div",ns,[m(Se,{ref_key:"lyricsRef",ref:z,lines:t(u).lines,"current-index":t(u).currentIndex,onSeek:ve,onModeChanged:i[0]||(i[0]=O=>k.value=O)},null,8,["lines","current-index"])]),t(u).lines.some(O=>O.translation)?(c(),f("button",{key:0,class:"lyric-mode-btn",title:"切换歌词显示模式",onClick:W,onKeydown:$e(Be(W,["prevent"]),["enter"])},[m(T,{name:t(k)==="original"?"mdi:text":t(k)==="translation"?"mdi:translate":"mdi:list-box-outline"},null,8,["name"]),l("span",null,M(t(k)==="original"?"原文":t(k)==="translation"?"翻译":"双语"),1)],40,is)):P("",!0)],4)):P("",!0)]),_:1})])}}}),ls=Object.assign(q(rs,[["__scopeId","data-v-86dd9fa2"]]),{__name:"MusicPlayer"});export{ls as default};
