import{G as X,r as z,z as y,ah as O,bm as se,o as Z,c as ie,d as r,e as s,n as N,Q as e,h as i,g as b,W as I,Y as ee,O as te,t as u,w as ne,f as l,a6 as oe,M as re,_ as ae,aK as ce,af as G,ag as le,F as T,V as U,S as F,L as ue}from"./Dy8pk1Vq.js";import de from"./C5uC5VVM.js";import"./DK19-m3i.js";function H(n){return n.type==="character"}function K(n){return n.type==="media"}class Q{cache=new Map;maxSize;defaultTTL;constructor(a=100,o=1440*60*1e3){this.maxSize=a,this.defaultTTL=o}get(a){const o=this.cache.get(a);return o?this.isExpired(o)?(this.cache.delete(a),null):o.data:null}set(a,o,d){if(this.cache.size>=this.maxSize){const A=this.cache.keys().next().value;this.cache.delete(A)}this.cache.set(a,{data:o,timestamp:Date.now(),ttl:d??this.defaultTTL})}delete(a){this.cache.delete(a)}clear(){this.cache.clear()}has(a){const o=this.cache.get(a);return o?this.isExpired(o)?(this.cache.delete(a),!1):!0:!1}size(){return this.cache.size}cleanup(){let a=0;for(const[o,d]of this.cache.entries())this.isExpired(d)&&(this.cache.delete(o),a++);return a}isExpired(a){return Date.now()-a.timestamp>a.ttl}getTimeToLive(a){const o=this.cache.get(a);if(!o)return-1;const d=Date.now()-o.timestamp,A=o.ttl-d;return A>0?A:0}}function _e(n){if(!Array.isArray(n))return[];const a=new Map;return n.forEach(o=>{a.has(o.name)||a.set(o.name,{name:o.name||"未知声优",image:o.image||o.images?.medium||o.images?.small,link:o.link||(o.id?`https://bangumi.tv/person/${o.id}`:void 0)})}),Array.from(a.values()).slice(0,3)}function fe(n){const a=new Map;return Array.isArray(n)&&n.forEach(o=>{typeof o.value=="string"&&a.set(o.key,o.value)}),a}function me(n){if(!Array.isArray(n))return"";const a=n.find(d=>d.key==="别名");if(!a||!Array.isArray(a.value))return"";const o=a.value.find(d=>d.k==="纯 假名"||d.k==="假名");return o?o.v:""}function ve(n){const a=fe(n.infobox),o=me(n.infobox),d=_e(n.voiceActors||[]);return{type:"character",source:"bangumi",title:n.name||"未知角色",subtitle:o||void 0,description:n.summary||void 0,image:n.images?.large||n.images?.medium||void 0,rating:void 0,tags:void 0,link:`https://bangumi.tv/character/${n.id}`,nameJp:o||void 0,nameCn:n.name_cn||void 0,gender:a.get("性别")||a.get("性 别")||void 0,birthday:a.get("生日")||void 0,bloodType:a.get("血型")||void 0,height:a.get("身高")||void 0,weight:a.get("体重")||void 0,bwh:a.get("BWH")||void 0,voiceActors:d.length>0?d:void 0,metadata:{characterId:n.id}}}function pe(n){return{type:"media",source:"bangumi",title:n.name_cn||n.name||"未命名作品",subtitle:void 0,description:n.summary||void 0,image:n.images?.large||n.images?.common||void 0,rating:n.rating?.score||void 0,tags:n.tags?.map(a=>({name:a.name,count:a.count})).slice(0,5)||void 0,link:`https://bangumi.tv/subject/${n.id}`,status:n.status==="Air"?"on-air":n.status==="End"?"finished":"planned",airDate:n.date||void 0,rank:n.rank||void 0,metadata:{bangumiId:n.id,ratingCount:n.rating?.total||void 0}}}const he={key:1,class:"cover-placeholder"},ge={class:"player-info"},ye={key:0,class:"player-loading"},be={key:1,class:"player-text"},ke={class:"player-title"},we={class:"player-artist"},xe=["disabled","title"],Ce=["src"],Me=X({__name:"MiniMusicPlayer",props:{musicUrl:{}},setup(n){const a=n,{detectMusicSource:o,extractMusicId:d,fetchNeteaseMetadata:A}=re(),p=z({}),x=z(!0),v=z(!1),w=z(!1),h=z(null);async function t(){if(a.musicUrl){x.value=!0,w.value=!1;try{const _=o(a.musicUrl),k=d(a.musicUrl,_);if(_==="netease"&&k){const f=await A(k);p.value={id:k,source:_,title:f.title||"未知曲目",artist:f.artist||"未知艺术家",cover:f.cover,url:f.url}}else p.value={id:"",source:"url",title:"外部音乐",artist:"未知艺术家",url:a.musicUrl}}catch(_){console.error("[MiniMusicPlayer] Failed to fetch music data:",_),w.value=!0,p.value={id:"",source:"url",title:"加载失败",artist:"请检查链接"}}finally{x.value=!1}}}const{currentPlayingId:C,setPlaying:E,stop:P}=se(),B=`mini-music-player-${Date.now().toString(36)}-${Math.random().toString(36).slice(2)}`,M=y(()=>{const _=p.value?.id??p.value?.url??a.musicUrl;return _&&String(_).length>0?`mini-music-player-${encodeURIComponent(String(_))}`:B});O(C,_=>{h.value&&_!==M.value&&v.value&&h.value.pause()});function J(){!h.value||!p.value.url||(v.value?h.value.pause():h.value.play().catch(_=>{console.warn("[MiniMusicPlayer] Play failed:",_),w.value=!0}))}function W(){v.value=!0,E(M.value)}function S(){v.value=!1,C.value===M.value&&P()}function j(){v.value=!1,C.value===M.value&&P()}function V(){w.value=!0,v.value=!1,C.value===M.value&&P()}return Z(()=>{t()}),ie(()=>{C.value===M.value&&P(),h.value&&(h.value.pause(),h.value.src="")}),O(()=>a.musicUrl,()=>{h.value&&h.value.pause(),v.value=!1,t()}),O(M,(_,k)=>{_&&v.value&&E(_)}),(_,k)=>{const f=ee,c=te,L=oe;return s(),r("div",{class:N(["mini-music-player",{"is-loading":e(x),"has-error":e(w)}])},[i("div",{class:N(["player-cover",{"is-playing":e(v)}])},[e(p).cover?(s(),I(f,{key:0,src:e(p).cover,alt:e(p).title||"封面",class:"cover-image",loading:"lazy"},null,8,["src","alt"])):(s(),r("div",he,[b(c,{name:"mdi:music-note"})]))],2),i("div",ge,[e(x)?(s(),r("span",ye,[b(c,{name:"eos-icons:loading"}),k[0]||(k[0]=i("span",null,"加载中...",-1))])):(s(),r("span",be,[i("span",ke,u(e(p).title||"未知曲目"),1),k[1]||(k[1]=i("span",{class:"player-separator"},"-",-1)),i("span",we,u(e(p).artist||"未知艺术家"),1)]))]),b(L,null,{default:ne(()=>[i("button",{class:"player-button",disabled:e(x)||e(w)||!e(p).url,title:e(v)?"暂停":"播放",onClick:J},[e(x)?(s(),I(c,{key:0,name:"eos-icons:loading"})):e(w)?(s(),I(c,{key:1,name:"mdi:alert-circle"})):e(v)?(s(),I(c,{key:2,name:"mdi:pause"})):(s(),I(c,{key:3,name:"mdi:play"}))],8,xe),e(p).url?(s(),r("audio",{key:0,ref_key:"audioElement",ref:h,src:e(p).url,crossorigin:"anonymous",onPlay:W,onPause:S,onEnded:j,onError:V},null,40,Ce)):l("",!0)]),_:1})],2)}}}),Y=Object.assign(ae(Me,[["__scopeId","data-v-f135ecc6"]]),{__name:"MiniMusicPlayer"}),$e=["data-type","data-source"],De={key:1,class:"info-card__image-placeholder"},Ie={class:"info-card__content"},Ae={class:"info-card__main-section"},Ee={class:"info-card__title-section"},Pe={class:"info-card__title"},Te={key:0,class:"info-card__subtitle"},ze={key:0,class:"info-card__description"},Be={class:"info-card__info-section"},Le={key:0,class:"info-card__tags-container"},Ue={key:0,class:"info-card__tag-count"},Ne={key:1,class:"info-card__attributes-section"},Se={key:0,class:"info-card__attribute-item"},je={class:"info-card__attribute-value"},Ve={key:1,class:"info-card__attribute-item"},Fe={class:"info-card__attribute-value"},Oe={key:2,class:"info-card__attribute-item"},Je={class:"info-card__attribute-value"},We={key:3,class:"info-card__attribute-item"},qe={class:"info-card__attribute-value"},Ke={key:4,class:"info-card__attribute-item"},Re={class:"info-card__attribute-value"},Ge={key:5,class:"info-card__attribute-item"},He={class:"info-card__attribute-value"},Qe={key:2,class:"info-card__voice-actors-section"},Ye={class:"info-card__voice-actors-header"},Xe={class:"info-card__voice-actors-badges"},Ze={class:"info-card__footer"},et={class:"info-card__source-badge"},tt={class:"info-card__source-name"},at=["aria-label"],st={class:"info-card__main-section"},it={class:"info-card__title-section"},nt={class:"info-card__title"},ot={key:0,class:"info-card__subtitle"},rt={key:0,class:"info-card__description"},ct={class:"info-card__info-section"},lt={key:0,class:"info-card__rating-section"},ut={class:"info-card__rating-stars"},dt={class:"info-card__rating-text"},_t={key:1,class:"info-card__tags-container"},ft={key:0,class:"info-card__tag-count"},mt={key:2,class:"info-card__media-info-combined"},vt={class:"info-card__media-info-label"},pt={class:"info-card__media-info-value"},ht={key:0,class:"info-card__date-item"},gt={key:1,class:"info-card__date-item"},yt={class:"info-card__footer"},bt={class:"info-card__source-badge"},kt={class:"info-card__source-name"},wt=["aria-label"],xt={key:1,class:"info-card info-card--error"},Ct={class:"info-card__error-content"},Mt={key:2,class:"info-card info-card--loading"},$t=X({__name:"index",props:{data:{},loading:{type:Boolean},error:{type:Boolean},type:{},id:{},music:{}},setup(n){const a=n,o=y(()=>"type"in a&&"id"in a),d=y(()=>"data"in a&&a.data);Z(()=>{ce(()=>{!o.value&&!d.value&&console.warn("[InfoCard] Invalid props: must provide either (type, id) for load mode or data for data mode")})});const A=new Q(100,1440*60*1e3),p=new Q(100,1440*60*1e3),x=z(!1),v=z(""),w=G(null),h=G(null),t=y(()=>d.value?a.data:w.value),C=y(()=>o.value?a.music:t.value?.music),E=y(()=>t.value?H(t.value):!1),P=y(()=>t.value?K(t.value):!1),B=y(()=>t.value?t.value.source==="bangumi"?"Bangumi":t.value.source:""),M=y(()=>{if(!P.value||!t.value||!K(t.value))return[];const f=t.value,c=[];return f.rank&&c.push({label:"排名",value:`#${f.rank}`}),c}),J=y(()=>E.value?"info-card__layout-vertical":"info-card__layout-horizontal"),W=y(()=>E.value?"info-card__image-portrait":"info-card__image-landscape"),S=y(()=>d.value?a.loading??!1:x.value),j=y(()=>d.value?a.error??!1:v.value!=="");function V(){t.value?.link&&window.open(t.value.link,"_blank")}function _(f){return f?new Date(f).toLocaleDateString("zh-CN"):""}async function k(){if(!o.value)return;const{type:f,id:c}=a;if(!c)return;const L=f==="character"?A:p,g=L.get(c);if(g){w.value=g;return}x.value=!0,v.value="",h.value?.abort(),h.value=new AbortController;try{const $=ue.bangumi?.apiBase;if(!$){v.value="Bangumi API 未配置";return}const D=await fetch(`${$}/api/${f==="character"?"character":"subject"}?id=${c}`,{signal:h.value.signal});if(!D.ok){v.value=`请求失败 (${D.status})`;return}const q=await D.json();if(!q.id){v.value=`获取${f==="character"?"人物":"媒体"}数据失败`;return}const R=f==="character"?ve(q):pe(q);w.value=R,L.set(c,R)}catch($){$ instanceof Error&&$.name!=="AbortError"&&(console.error("[InfoCard] Fetch error:",$),v.value=$.message||"未知错误")}finally{x.value=!1}}return O(()=>o.value?a.id:null,f=>{f!=null&&k()},{immediate:!0}),le(()=>{h.value?.abort()}),(f,c)=>{const L=ee,g=te,$=de;return!e(S)&&!e(j)&&e(t)?(s(),r("div",{key:0,class:"info-card","data-type":e(t).type,"data-source":e(t).source},[i("div",{class:N(e(J))},[i("div",{class:N(["info-card__image-wrapper",e(W)])},[e(t).image?(s(),I(L,{key:0,src:e(t).image,alt:e(t).title,class:"info-card__image",loading:"lazy"},null,8,["src","alt"])):(s(),r("div",De,[b(g,{name:e(E)?"ph:user-circle-bold":"ph:image-square-bold",class:"info-card__placeholder-icon"},null,8,["name"])]))],2),i("div",Ie,[e(E)&&e(H)(e(t))?(s(),r(T,{key:0},[i("div",Ae,[i("div",Ee,[i("h3",Pe,u(e(t).title),1),e(t).subtitle?(s(),r("p",Te,u(e(t).subtitle),1)):l("",!0)]),e(t).description?(s(),r("p",ze,u(e(t).description),1)):l("",!0),e(C)?(s(),I(Y,{key:1,"music-url":e(C)},null,8,["music-url"])):l("",!0)]),i("div",Be,[e(t).tags?.length?(s(),r("div",Le,[(s(!0),r(T,null,U(e(t).tags,(m,D)=>(s(),r("span",{key:D,class:"info-card__tag"},[F(u(m.name),1),m.count?(s(),r("span",Ue,u(m.count),1)):l("",!0)]))),128))])):l("",!0),e(t).gender||e(t).birthday||e(t).height||e(t).bloodType||e(t).weight||e(t).bwh?(s(),r("div",Ne,[e(t).gender?(s(),r("div",Se,[c[0]||(c[0]=i("span",{class:"info-card__attribute-label"},"性别",-1)),i("span",je,u(e(t).gender),1)])):l("",!0),e(t).birthday?(s(),r("div",Ve,[c[1]||(c[1]=i("span",{class:"info-card__attribute-label"},"生日",-1)),i("span",Fe,u(e(t).birthday),1)])):l("",!0),e(t).height?(s(),r("div",Oe,[c[2]||(c[2]=i("span",{class:"info-card__attribute-label"},"身高",-1)),i("span",Je,u(e(t).height),1)])):l("",!0),e(t).bloodType?(s(),r("div",We,[c[3]||(c[3]=i("span",{class:"info-card__attribute-label"},"血型",-1)),i("span",qe,u(e(t).bloodType),1)])):l("",!0),e(t).weight?(s(),r("div",Ke,[c[4]||(c[4]=i("span",{class:"info-card__attribute-label"},"体重",-1)),i("span",Re,u(e(t).weight),1)])):l("",!0),e(t).bwh?(s(),r("div",Ge,[c[5]||(c[5]=i("span",{class:"info-card__attribute-label"},"三围",-1)),i("span",He,u(e(t).bwh),1)])):l("",!0)])):l("",!0),e(t).voiceActors?.length?(s(),r("div",Qe,[i("div",Ye,[b(g,{name:"ri:mic-line",class:"info-card__section-icon"}),c[6]||(c[6]=i("span",null,"声优",-1))]),i("div",Xe,[(s(!0),r(T,null,U(e(t).voiceActors,(m,D)=>(s(),I($,{key:D,img:m.image,text:m.name,link:m.link,round:""},null,8,["img","text","link"]))),128))])])):l("",!0),i("div",Ze,[i("div",et,[b(g,{name:"ri:bilibili-line",class:"info-card__source-icon"}),i("span",tt,u(e(B)),1)]),e(t).link?(s(),r("button",{key:0,class:"info-card__view-button","aria-label":`查看 ${e(B)} 上 ${e(t).title} 的详情`,onClick:V},[c[7]||(c[7]=i("span",null,"查看详情",-1)),b(g,{name:"ri:arrow-right-line",class:"info-card__button-icon"})],8,at)):l("",!0)])])],64)):e(P)&&e(K)(e(t))?(s(),r(T,{key:1},[i("div",st,[i("div",it,[i("h3",nt,u(e(t).title),1),e(t).subtitle?(s(),r("p",ot,u(e(t).subtitle),1)):l("",!0)]),e(t).description?(s(),r("p",rt,u(e(t).description),1)):l("",!0),e(C)?(s(),I(Y,{key:1,"music-url":e(C)},null,8,["music-url"])):l("",!0)]),i("div",ct,[e(t).rating?(s(),r("div",lt,[i("div",ut,[(s(),r(T,null,U(5,m=>b(g,{key:m,class:N(["info-card__star-icon",m<=Math.round(e(t).rating/2)?"star-filled":"star-empty"]),name:m<=Math.round(e(t).rating/2)?"ri:star-fill":"ri:star-line"},null,8,["class","name"])),64))]),i("span",dt,u(e(t).rating),1)])):l("",!0),e(t).tags?.length?(s(),r("div",_t,[(s(!0),r(T,null,U(e(t).tags,(m,D)=>(s(),r("span",{key:D,class:"info-card__tag"},[F(u(m.name),1),m.count?(s(),r("span",ft,u(m.count),1)):l("",!0)]))),128))])):l("",!0),e(M).length||e(t).airDate||e(t).endDate?(s(),r("div",mt,[(s(!0),r(T,null,U(e(M),m=>(s(),r("div",{key:m.label,class:"info-card__media-info-item"},[i("span",vt,u(m.label)+":",1),i("span",pt,u(m.value),1)]))),128)),e(t).airDate?(s(),r("span",ht,[b(g,{name:"clarity:date-line",class:"info-card__date-icon"}),F(" "+u(_(e(t).airDate)),1)])):l("",!0),e(t).endDate?(s(),r("span",gt,[b(g,{name:"clarity:date-line",class:"info-card__date-icon"}),F(" "+u(_(e(t).endDate)),1)])):l("",!0)])):l("",!0),i("div",yt,[i("div",bt,[b(g,{name:"ri:bilibili-line",class:"info-card__source-icon"}),i("span",kt,u(e(B)),1)]),e(t).link?(s(),r("button",{key:0,class:"info-card__view-button","aria-label":`查看 ${e(B)} 上 ${e(t).title} 的详情`,onClick:V},[c[8]||(c[8]=i("span",null,"查看详情",-1)),b(g,{name:"ri:arrow-right-line",class:"info-card__button-icon"})],8,wt)):l("",!0)])])],64)):l("",!0)])],2)],8,$e)):e(j)?(s(),r("div",xt,[i("div",Ct,[b(g,{name:"ph:warning-circle-bold",class:"info-card__error-icon"}),c[9]||(c[9]=i("p",null,"加载失败",-1)),c[10]||(c[10]=i("small",null,"请检查 ID 是否正确或稍后重试",-1))])])):e(S)?(s(),r("div",Mt,[...c[11]||(c[11]=[i("div",{class:"info-card__loading-skeleton"},null,-1)])])):l("",!0)}}}),Et=Object.assign(ae($t,[["__scopeId","data-v-b175eef4"]]),{__name:"InfoCard"});export{Et as default};
