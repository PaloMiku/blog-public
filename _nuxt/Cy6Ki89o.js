import{D as R,r as I,o as se,c as ae,ae as X,d as o,e as i,n as N,O as e,h as a,g as y,U as E,W as Y,M as Z,t as u,w as ie,f as c,bq as ne,K as re,_ as ee,ac as W,y as k,ad as oe,F as A,S as z,Q as K,J as le}from"./8UKJzVtz.js";import ce from"./Cx6oRslV.js";import"./Cq81GAKJ.js";function G(n){return n.type==="character"}function J(n){return n.type==="media"}class H{cache=new Map;maxSize;defaultTTL;constructor(s=100,r=1440*60*1e3){this.maxSize=s,this.defaultTTL=r}get(s){const r=this.cache.get(s);return r?this.isExpired(r)?(this.cache.delete(s),null):r.data:null}set(s,r,v){if(this.cache.size>=this.maxSize){const x=this.cache.keys().next().value;this.cache.delete(x)}this.cache.set(s,{data:r,timestamp:Date.now(),ttl:v??this.defaultTTL})}delete(s){this.cache.delete(s)}clear(){this.cache.clear()}has(s){const r=this.cache.get(s);return r?this.isExpired(r)?(this.cache.delete(s),!1):!0:!1}size(){return this.cache.size}cleanup(){let s=0;for(const[r,v]of this.cache.entries())this.isExpired(v)&&(this.cache.delete(r),s++);return s}isExpired(s){return Date.now()-s.timestamp>s.ttl}getTimeToLive(s){const r=this.cache.get(s);if(!r)return-1;const v=Date.now()-r.timestamp,x=r.ttl-v;return x>0?x:0}}function ue(n){if(!Array.isArray(n))return[];const s=new Map;return n.forEach(r=>{s.has(r.name)||s.set(r.name,{name:r.name||"未知声优",image:r.image||r.images?.medium||r.images?.small,link:r.link||(r.id?`https://bangumi.tv/person/${r.id}`:void 0)})}),Array.from(s.values()).slice(0,3)}function de(n){const s=new Map;return Array.isArray(n)&&n.forEach(r=>{typeof r.value=="string"&&s.set(r.key,r.value)}),s}function me(n){if(!Array.isArray(n))return"";const s=n.find(v=>v.key==="别名");if(!s||!Array.isArray(s.value))return"";const r=s.value.find(v=>v.k==="纯 假名"||v.k==="假名");return r?r.v:""}function ve(n){const s=de(n.infobox),r=me(n.infobox),v=ue(n.voiceActors||[]);return{type:"character",source:"bangumi",title:n.name||"未知角色",subtitle:r||void 0,description:n.summary||void 0,image:n.images?.large||n.images?.medium||void 0,rating:void 0,tags:void 0,link:`https://bangumi.tv/character/${n.id}`,nameJp:r||void 0,nameCn:n.name_cn||void 0,gender:s.get("性别")||s.get("性 别")||void 0,birthday:s.get("生日")||void 0,bloodType:s.get("血型")||void 0,height:s.get("身高")||void 0,weight:s.get("体重")||void 0,bwh:s.get("BWH")||void 0,voiceActors:v.length>0?v:void 0,metadata:{characterId:n.id}}}function pe(n){return{type:"media",source:"bangumi",title:n.name_cn||n.name||"未命名作品",subtitle:void 0,description:n.summary||void 0,image:n.images?.large||n.images?.common||void 0,rating:n.rating?.score||void 0,tags:n.tags?.map(s=>s.name).slice(0,5)||void 0,link:`https://bangumi.tv/subject/${n.id}`,episode:n.eps||void 0,status:n.status==="Air"?"on-air":n.status==="End"?"finished":"planned",airDate:n.date||void 0,rank:n.rank||void 0,metadata:{bangumiId:n.id,ratingCount:n.rating?.total||void 0}}}const he={key:1,class:"cover-placeholder"},_e={class:"player-info"},fe={key:0,class:"player-loading"},ge={key:1,class:"player-text"},ye={class:"player-title"},be={class:"player-artist"},ke=["disabled","title"],we=["src"],xe=R({__name:"MiniMusicPlayer",props:{musicUrl:{}},setup(n){const s=n,{detectMusicSource:r,extractMusicId:v,fetchNeteaseMetadata:x}=re(),d=I({}),M=I(!0),h=I(!1),w=I(!1),p=I();async function t(){if(s.musicUrl){M.value=!0,w.value=!1;try{const b=r(s.musicUrl),f=v(s.musicUrl,b);if(b==="netease"&&f){const C=await x(f);d.value={id:f,source:b,title:C.title||"未知曲目",artist:C.artist||"未知艺术家",cover:C.cover,url:C.url}}else d.value={id:"",source:"url",title:"外部音乐",artist:"未知艺术家",url:s.musicUrl}}catch(b){console.error("[MiniMusicPlayer] Failed to fetch music data:",b),w.value=!0,d.value={id:"",source:"url",title:"加载失败",artist:"请检查链接"}}finally{M.value=!1}}}function P(){!p.value||!d.value.url||(h.value?p.value.pause():p.value.play().catch(b=>{console.warn("[MiniMusicPlayer] Play failed:",b),w.value=!0}))}function T(){h.value=!0}function U(){h.value=!1}function B(){h.value=!1}function j(){w.value=!0,h.value=!1}function S(b){const f=b.target;p.value&&f!==p.value&&f.tagName==="AUDIO"&&h.value&&p.value.pause()}return se(()=>{t(),document.addEventListener("play",S,!0)}),ae(()=>{document.removeEventListener("play",S,!0),p.value&&(p.value.pause(),p.value.src="")}),X(()=>s.musicUrl,()=>{p.value&&p.value.pause(),h.value=!1,t()}),(b,f)=>{const C=Y,D=Z,O=ne;return i(),o("div",{class:N(["mini-music-player",{"is-loading":e(M),"has-error":e(w)}])},[a("div",{class:N(["player-cover",{"is-playing":e(h)}])},[e(d).cover?(i(),E(C,{key:0,src:e(d).cover,alt:e(d).title||"封面",class:"cover-image",loading:"lazy"},null,8,["src","alt"])):(i(),o("div",he,[y(D,{name:"mdi:music-note"})]))],2),a("div",_e,[e(M)?(i(),o("span",fe,[y(D,{name:"eos-icons:loading"}),f[0]||(f[0]=a("span",null,"加载中...",-1))])):(i(),o("span",ge,[a("span",ye,u(e(d).title||"未知曲目"),1),f[1]||(f[1]=a("span",{class:"player-separator"},"-",-1)),a("span",be,u(e(d).artist||"未知艺术家"),1)]))]),y(O,null,{default:ie(()=>[a("button",{class:"player-button",disabled:e(M)||e(w)||!e(d).url,title:e(h)?"暂停":"播放",onClick:P},[e(M)?(i(),E(D,{key:0,name:"eos-icons:loading"})):e(w)?(i(),E(D,{key:1,name:"mdi:alert-circle"})):e(h)?(i(),E(D,{key:2,name:"mdi:pause"})):(i(),E(D,{key:3,name:"mdi:play"}))],8,ke),e(d).url?(i(),o("audio",{key:0,ref_key:"audioElement",ref:p,src:e(d).url,crossorigin:"anonymous",onPlay:T,onPause:U,onEnded:B,onError:j},null,40,we)):c("",!0)]),_:1})],2)}}}),Q=Object.assign(ee(xe,[["__scopeId","data-v-c93c1b59"]]),{__name:"MiniMusicPlayer"}),Me=["data-type","data-source"],Ce={key:1,class:"card-image-placeholder"},De={class:"card-content"},$e={class:"card-main-section"},Ee={class:"title-section"},Ae={class:"card-title"},Ie={key:0,class:"card-subtitle"},Pe={key:0,class:"card-description"},Te={class:"card-info-section"},Be={key:0,class:"tags-container"},Le={key:1,class:"attributes-section"},ze={key:0,class:"attribute-item"},Ne={class:"attribute-value"},Ue={key:1,class:"attribute-item"},je={class:"attribute-value"},Se={key:2,class:"attribute-item"},Oe={class:"attribute-value"},Ve={key:3,class:"attribute-item"},Fe={class:"attribute-value"},Je={key:4,class:"attribute-item"},qe={class:"attribute-value"},We={key:5,class:"attribute-item"},Ke={class:"attribute-value"},Ge={key:2,class:"voice-actors-section"},He={class:"voice-actors-header"},Qe={class:"voice-actors-badges"},Re={class:"card-footer"},Xe={class:"source-badge"},Ye={class:"source-name"},Ze=["aria-label"],et={class:"card-main-section"},tt={class:"title-section"},st={class:"card-title"},at={key:0,class:"card-subtitle"},it={key:0,class:"card-description"},nt={class:"card-info-section"},rt={key:0,class:"rating-section"},ot={class:"rating-stars"},lt={class:"rating-text"},ct={key:1,class:"tags-container"},ut={key:2,class:"media-info-combined"},dt={class:"media-info-label"},mt={class:"media-info-value"},vt={key:0,class:"date-item"},pt={key:1,class:"date-item"},ht={class:"card-footer"},_t={class:"source-badge"},ft={class:"source-name"},gt=["aria-label"],yt={key:1,class:"info-card info-card-error"},bt={class:"error-content"},kt={key:2,class:"info-card info-card-loading"},wt=R({__name:"index",props:{data:{},loading:{type:Boolean},error:{type:Boolean},type:{},id:{},music:{}},setup(n){const s=n,r=new H(100,1440*60*1e3),v=new H(100,1440*60*1e3),x=I(!1),d=I(""),M=W(null),h=W(null),w=k(()=>"type"in s&&"id"in s),p=k(()=>"data"in s&&s.data),t=k(()=>p.value?s.data:M.value),P=k(()=>w.value?s.music:t.value?.music),T=k(()=>t.value?G(t.value):!1),U=k(()=>t.value?J(t.value):!1),B=k(()=>t.value?t.value.source==="bangumi"?"Bangumi":t.value.source:""),j=k(()=>{if(!U.value||!t.value||!J(t.value))return[];const _=t.value,l=[];return _.episode&&l.push({label:"话数",value:_.episode}),_.rank&&l.push({label:"排名",value:`#${_.rank}`}),l}),S=k(()=>T.value?"card-layout-vertical":"card-layout-horizontal"),b=k(()=>T.value?"card-image-portrait":"card-image-landscape"),f=k(()=>p.value?s.loading??!1:x.value),C=k(()=>p.value?s.error??!1:d.value!=="");function D(){t.value?.link&&window.open(t.value.link,"_blank")}function O(_){return _?new Date(_).toLocaleDateString("zh-CN"):""}async function te(){if(!w.value)return;const{type:_,id:l}=s;if(!l)return;const V=_==="character"?r:v,g=V.get(l);if(g){M.value=g;return}x.value=!0,d.value="",h.value?.abort(),h.value=new AbortController;try{const $=le.bangumi?.apiBase;if(!$){d.value="Bangumi API 未配置";return}const L=await fetch(`${$}/api/${_==="character"?"character":"subject"}?id=${l}`,{signal:h.value.signal});if(!L.ok){d.value=`请求失败 (${L.status})`;return}const F=await L.json();if(!F.id){d.value=`获取${_==="character"?"人物":"媒体"}数据失败`;return}const q=_==="character"?ve(F):pe(F);M.value=q,V.set(l,q)}catch($){$ instanceof Error&&$.name!=="AbortError"&&(console.error("[InfoCard] Fetch error:",$),d.value=$.message||"未知错误")}finally{x.value=!1}}return X(()=>w.value?s.id:null,_=>{_!=null&&te()},{immediate:!0}),oe(()=>{h.value?.abort()}),(_,l)=>{const V=Y,g=Z,$=ce;return!e(f)&&!e(C)&&e(t)?(i(),o("div",{key:0,class:"info-card","data-type":e(t).type,"data-source":e(t).source},[a("div",{class:N(e(S))},[a("div",{class:N(["card-image-wrapper",e(b)])},[e(t).image?(i(),E(V,{key:0,src:e(t).image,alt:e(t).title,class:"card-image",loading:"lazy"},null,8,["src","alt"])):(i(),o("div",Ce,[y(g,{name:e(T)?"ph:user-circle-bold":"ph:image-square-bold",class:"placeholder-icon"},null,8,["name"])]))],2),a("div",De,[e(T)&&e(G)(e(t))?(i(),o(A,{key:0},[a("div",$e,[a("div",Ee,[a("h3",Ae,u(e(t).title),1),e(t).subtitle?(i(),o("p",Ie,u(e(t).subtitle),1)):c("",!0)]),e(t).description?(i(),o("p",Pe,u(e(t).description),1)):c("",!0),e(P)?(i(),E(Q,{key:1,"music-url":e(P)},null,8,["music-url"])):c("",!0)]),a("div",Te,[e(t).tags?.length?(i(),o("div",Be,[(i(!0),o(A,null,z(e(t).tags,m=>(i(),o("span",{key:m,class:"tag"},u(m),1))),128))])):c("",!0),e(t).gender||e(t).birthday||e(t).height||e(t).bloodType||e(t).weight||e(t).bwh?(i(),o("div",Le,[e(t).gender?(i(),o("div",ze,[l[0]||(l[0]=a("span",{class:"attribute-label"},"性别",-1)),a("span",Ne,u(e(t).gender),1)])):c("",!0),e(t).birthday?(i(),o("div",Ue,[l[1]||(l[1]=a("span",{class:"attribute-label"},"生日",-1)),a("span",je,u(e(t).birthday),1)])):c("",!0),e(t).height?(i(),o("div",Se,[l[2]||(l[2]=a("span",{class:"attribute-label"},"身高",-1)),a("span",Oe,u(e(t).height),1)])):c("",!0),e(t).bloodType?(i(),o("div",Ve,[l[3]||(l[3]=a("span",{class:"attribute-label"},"血型",-1)),a("span",Fe,u(e(t).bloodType),1)])):c("",!0),e(t).weight?(i(),o("div",Je,[l[4]||(l[4]=a("span",{class:"attribute-label"},"体重",-1)),a("span",qe,u(e(t).weight),1)])):c("",!0),e(t).bwh?(i(),o("div",We,[l[5]||(l[5]=a("span",{class:"attribute-label"},"三围",-1)),a("span",Ke,u(e(t).bwh),1)])):c("",!0)])):c("",!0),e(t).voiceActors?.length?(i(),o("div",Ge,[a("div",He,[y(g,{name:"ri:mic-line",class:"section-icon"}),l[6]||(l[6]=a("span",null,"声优",-1))]),a("div",Qe,[(i(!0),o(A,null,z(e(t).voiceActors,(m,L)=>(i(),E($,{key:L,img:m.image,text:m.name,link:m.link,round:""},null,8,["img","text","link"]))),128))])])):c("",!0),a("div",Re,[a("div",Xe,[y(g,{name:"ri:bilibili-line",class:"source-icon"}),a("span",Ye,u(e(B)),1)]),e(t).link?(i(),o("button",{key:0,class:"view-button","aria-label":`查看 ${e(B)} 上 ${e(t).title} 的详情`,onClick:D},[l[7]||(l[7]=a("span",null,"查看详情",-1)),y(g,{name:"ri:arrow-right-line",class:"button-icon"})],8,Ze)):c("",!0)])])],64)):e(U)&&e(J)(e(t))?(i(),o(A,{key:1},[a("div",et,[a("div",tt,[a("h3",st,u(e(t).title),1),e(t).subtitle?(i(),o("p",at,u(e(t).subtitle),1)):c("",!0)]),e(t).description?(i(),o("p",it,u(e(t).description),1)):c("",!0),e(P)?(i(),E(Q,{key:1,"music-url":e(P)},null,8,["music-url"])):c("",!0)]),a("div",nt,[e(t).rating?(i(),o("div",rt,[a("div",ot,[(i(),o(A,null,z(5,m=>y(g,{key:m,class:N(["star-icon",m<=Math.round(e(t).rating/2)?"star-filled":"star-empty"]),name:m<=Math.round(e(t).rating/2)?"ri:star-fill":"ri:star-line"},null,8,["class","name"])),64))]),a("span",lt,u(e(t).rating),1)])):c("",!0),e(t).tags?.length?(i(),o("div",ct,[(i(!0),o(A,null,z(e(t).tags,m=>(i(),o("span",{key:m,class:"tag"},u(m),1))),128))])):c("",!0),e(j).length||e(t).airDate||e(t).endDate?(i(),o("div",ut,[(i(!0),o(A,null,z(e(j),m=>(i(),o("div",{key:m.label,class:"media-info-item"},[a("span",dt,u(m.label)+":",1),a("span",mt,u(m.value),1)]))),128)),e(t).airDate?(i(),o("span",vt,[y(g,{name:"clarity:date-line",class:"date-icon"}),K(" "+u(O(e(t).airDate)),1)])):c("",!0),e(t).endDate?(i(),o("span",pt,[y(g,{name:"clarity:date-line",class:"date-icon"}),K(" "+u(O(e(t).endDate)),1)])):c("",!0)])):c("",!0),a("div",ht,[a("div",_t,[y(g,{name:"ri:bilibili-line",class:"source-icon"}),a("span",ft,u(e(B)),1)]),e(t).link?(i(),o("button",{key:0,class:"view-button","aria-label":`查看 ${e(B)} 上 ${e(t).title} 的详情`,onClick:D},[l[8]||(l[8]=a("span",null,"查看详情",-1)),y(g,{name:"ri:arrow-right-line",class:"button-icon"})],8,gt)):c("",!0)])])],64)):c("",!0)])],2)],8,Me)):e(C)?(i(),o("div",yt,[a("div",bt,[y(g,{name:"ph:warning-circle-bold",class:"error-icon"}),l[9]||(l[9]=a("p",null,"加载失败",-1)),l[10]||(l[10]=a("small",null,"请检查 ID 是否正确或稍后重试",-1))])])):e(f)?(i(),o("div",kt,[...l[11]||(l[11]=[a("div",{class:"loading-skeleton"},null,-1)])])):c("",!0)}}}),Dt=Object.assign(ee(wt,[["__scopeId","data-v-3768b5dd"]]),{__name:"InfoCard"});export{Dt as default};
