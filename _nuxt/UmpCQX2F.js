import{J,r as g,N as K,x as A,Q as v,aN as p,b5 as o,aQ as b,K as s,aR as S,br as X,aU as Y,b8 as y,a_ as Z,aZ as G,b4 as H}from"./D6ajeznB.js";import{f as w,_ as ee}from"./BjF52ptR.js";const M=new Map,C=new Map;function z(r){try{let t=r.match(/[?&]id=(\d+)/);return t?.[1]||(t=r.match(/\/song[/?#]*(\d+)/),t?.[1])||(t=r.match(/\/m\/song\/(\d+)/),t?.[1])?t[1]:null}catch{return null}}function j(r){const t=r.toLowerCase();return t.includes("music.163.com")||t.includes("netease")?"netease":t.includes("qq.com")||t.includes("y.qq.com")?"tencent":t.includes("kuwo.cn")?"kuwo":t.includes("xiami.com")?"xiami":t.includes("kugou.com")?"kugou":t.includes("youtube.com")||t.includes("youtu.be")?"youtube":"url"}function x(r,t){switch(t){case"netease":return z(r);case"tencent":return r.match(/(?:song\/|songid=)(\d+)/)?.[1]||null;default:return r.match(/(\d+)/)?.[1]||null}}async function te(r){const t=`netease:${r}`;if(C.has(t))return C.get(t);const a=(async()=>{try{if(!w.meting?.apiServer)return console.warn("[MusicParser] Meting API server not configured"),{};const k=`${w.meting.apiServer.endsWith("/")?w.meting.apiServer:`${w.meting.apiServer}/`}?type=song&id=${r}`,f=await fetch(k);if(!f.ok)return console.warn(`[MusicParser] Song API returned status ${f.status}`),{};const m=await f.json();let e=m;if(Array.isArray(m)&&m.length>0&&(e=m[0]),!e||typeof e!="object")return console.warn("[MusicParser] Invalid response format:",m),{};const c=e.pic;let u;return e.url&&(u=e.url),{title:e.name||e.title||"未知曲目",artist:e.artist?Array.isArray(e.artist)?e.artist.map(d=>typeof d=="string"?d:d.name).join(" / "):String(e.artist):"未知艺术家",cover:c||void 0,url:u||void 0}}catch(h){return console.error(`[MusicParser] Failed to fetch netease metadata for id ${r}:`,h),{}}})();return C.set(t,a),a}function I(){return{id:"",title:"解析失败",artist:"无法解析音乐信息",source:"url"}}function re(r){if(!r||typeof r!="string")return I();if(M.has(r))return M.get(r);let t;try{if(r.trim().startsWith("{")){const a=JSON.parse(r);if(a&&typeof a=="object")return t={id:(a.id||"").toString(),title:(a.title||"未知曲目").toString(),artist:(a.artist||"未知艺术家").toString(),cover:a.cover?String(a.cover):void 0,url:a.url?String(a.url):void 0,source:a.source||"url",platform:a.platform?String(a.platform):void 0},M.set(r,t),t}if(r.trim().startsWith("http")){const a=r.trim(),h=j(a);return t={id:x(a,h)||"",title:"加载中...",artist:"加载中...",url:a,source:h,cover:void 0},M.set(r,t),t}throw new Error("Invalid format")}catch(a){console.warn("[MusicParser] Failed to parse music extension:",r,a),t=I()}return M.set(r,t),t}function ae(){M.clear(),C.clear()}function se(){return{parseMusicExtension:re,createEmptyMusic:I,clearCache:ae,detectMusicSource:j,extractMusicId:x,extractNeteaseMusicId:z,fetchNeteaseMetadata:te}}const ne={class:"music-player"},oe={class:"music-info"},ie={key:0,class:"music-cover"},ce={class:"music-details"},ue={key:0,class:"music-loading"},le={class:"music-title"},de={class:"music-artist"},me=["href","title"],fe=["src"],ve={key:1,class:"music-progress-section"},pe={class:"music-time"},he={class:"current-time"},ge={class:"duration"},_e={class:"music-actions"},ye=["title"],Me={key:2,class:"music-error"},Pe=J({__name:"MusicPlayer",props:{music:{}},setup(r){const t=r,{fetchNeteaseMetadata:a,detectMusicSource:h,extractMusicId:k}=se(),f=g(!0),m=g(!1),e=g(t.music),c=g(!1),u=g(),P=g(0),d=g(0),B={netease:"网易云音乐",tencent:"QQ音乐",kuwo:"酷我音乐",xiami:"虾米音乐",kugou:"酷狗音乐",youtube:"YouTube",url:"外部链接"};async function F(){let i=e.value.source,l=e.value.id;if(e.value.url&&!l&&(i=h(e.value.url),l=k(e.value.url,i)||"",e.value={...e.value,source:i,id:l}),i!=="netease"||!l){f.value=!1;return}try{f.value=!0;const n=await a(l);(n.title||n.artist||n.cover||n.url)&&(e.value={...e.value,title:n.title||e.value.title,artist:n.artist||e.value.artist,cover:n.cover||e.value.cover,url:n.url||e.value.url})}catch(n){console.error("[MusicPlayer] Failed to fetch metadata:",n),m.value=!0}finally{f.value=!1}}K(F);const E=A(()=>({title:e.value.title||"未知曲目",artist:e.value.artist||"未知艺术家",platform:e.value.platform||e.value.source||"音乐"})),$=A(()=>B[e.value.source]||e.value.source);function N(i){if(!Number.isFinite(i))return"0:00";const l=Math.floor(i/60),n=Math.floor(i%60);return`${l}:${n<10?"0":""}${n}`}const L=A(()=>d.value?P.value/d.value*100:0);function O(){u.value&&(c.value?u.value.pause():u.value.play().catch(i=>{console.warn("[MusicPlayer] Failed to play audio:",i),m.value=!0}))}function U(){c.value=!1}function q(){c.value=!0}function D(){c.value=!1}function Q(){console.error("[MusicPlayer] Audio playback error"),c.value&&(m.value=!0),c.value=!1}function R(){u.value&&(P.value=u.value.currentTime)}function V(){u.value&&(d.value=u.value.duration)}function W(i){const n=i.currentTarget.getBoundingClientRect(),_=(i.clientX-n.left)/n.width;if(u.value&&d.value){const T=_*d.value;u.value.currentTime=Math.max(0,Math.min(T,d.value)),P.value=T}}return(i,l)=>{const n=X,_=ee;return p(),v("div",ne,[o("div",oe,[s(e).cover?(p(),v("div",ie,[S(n,{src:s(e).cover,alt:s(E).title,class:"cover-image",loading:"lazy",fit:"cover"},null,8,["src","alt"])])):b("",!0),o("div",ce,[s(f)?(p(),v("div",ue,[S(_,{name:"eos-icons:loading",size:"14"}),l[0]||(l[0]=o("span",null,"加载中...",-1))])):(p(),v(Y,{key:1},[o("div",le,y(s(E).title),1),o("div",de,y(s(E).artist),1),o("a",{href:`https://music.163.com/#/song?id=${s(e).id}`,target:"_blank",rel:"noopener noreferrer",class:"music-source",title:`在 ${s($)} 中打开`},[S(_,{name:"mdi:music",size:"14"}),o("span",null,y(s($)),1)],8,me)],64))])]),s(e).url?(p(),v("audio",{key:0,ref_key:"audioElement",ref:u,src:s(e).url,crossorigin:"anonymous",onEnded:U,onPlay:q,onPause:D,onError:Q,onTimeupdate:R,onLoadedmetadata:V},null,40,fe)):b("",!0),s(c)&&s(d)>0?(p(),v("div",ve,[o("div",{class:"music-progress-container",onClick:W},[o("div",{class:"music-progress-bar",style:Z({width:`${s(L)}%`})},null,4)]),o("div",pe,[o("span",he,y(N(s(P))),1),o("span",ge,y(N(s(d))),1)])])):b("",!0),o("div",_e,[s(e).url?(p(),v("button",{key:0,class:G(["play-button",{playing:s(c)}]),title:s(c)?"暂停":"播放",onClick:O},[S(_,{name:s(c)?"mdi:pause-circle":"mdi:play-circle",size:"20"},null,8,["name"]),o("span",null,y(s(c)?"暂停":"播放"),1)],10,ye)):b("",!0)]),s(m)&&s(e).url?(p(),v("div",Me,[S(_,{name:"mdi:alert-circle",size:"16"}),l[1]||(l[1]=o("span",null,"音乐加载失败",-1))])):b("",!0)])}}}),be=Object.assign(H(Pe,[["__scopeId","data-v-1d49a7ea"]]),{__name:"MusicPlayer"}),we=Object.freeze(Object.defineProperty({__proto__:null,default:be},Symbol.toStringTag,{value:"Module"}));export{we as M,be as _,se as u};
