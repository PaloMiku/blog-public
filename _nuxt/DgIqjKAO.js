import{y as Q,r as W,al as X,z as p,bp as Y,am as Z,d as o,f as u,J as e,e as r,h as i,n as z,a5 as E,a6 as ee,g as y,C as te,F as k,t as d,R as D,I as q,a2 as se,_ as ae}from"./yvtkdOf-.js";import ie from"./jtsyYy4G.js";import"./CPx3FLF-.js";function R(a){return a.type==="character"}function L(a){return a.type==="media"}class H{cache=new Map;maxSize;defaultTTL;constructor(s=100,n=1440*60*1e3){this.maxSize=s,this.defaultTTL=n}get(s){const n=this.cache.get(s);return n?this.isExpired(n)?(this.cache.delete(s),null):n.data:null}set(s,n,m){if(this.cache.size>=this.maxSize){const w=this.cache.keys().next().value;this.cache.delete(w)}this.cache.set(s,{data:n,timestamp:Date.now(),ttl:m??this.defaultTTL})}delete(s){this.cache.delete(s)}clear(){this.cache.clear()}has(s){const n=this.cache.get(s);return n?this.isExpired(n)?(this.cache.delete(s),!1):!0:!1}size(){return this.cache.size}cleanup(){let s=0;for(const[n,m]of this.cache.entries())this.isExpired(m)&&(this.cache.delete(n),s++);return s}isExpired(s){return Date.now()-s.timestamp>s.ttl}getTimeToLive(s){const n=this.cache.get(s);if(!n)return-1;const m=Date.now()-n.timestamp,w=n.ttl-m;return w>0?w:0}}function ne(a){if(!Array.isArray(a))return[];const s=new Map;return a.forEach(n=>{s.has(n.name)||s.set(n.name,{name:n.name||"未知声优",image:n.image||n.images?.medium||n.images?.small,link:n.link||(n.id?`https://bangumi.tv/person/${n.id}`:void 0)})}),Array.from(s.values()).slice(0,3)}function re(a){const s=new Map;return Array.isArray(a)&&a.forEach(n=>{typeof n.value=="string"&&s.set(n.key,n.value)}),s}function oe(a){if(!Array.isArray(a))return"";const s=a.find(m=>m.key==="别名");if(!s||!Array.isArray(s.value))return"";const n=s.value.find(m=>m.k==="纯 假名"||m.k==="假名");return n?n.v:""}function le(a){const s=re(a.infobox),n=oe(a.infobox),m=ne(a.voiceActors||[]);return{type:"character",source:"bangumi",title:a.name||"未知角色",subtitle:n||void 0,description:a.summary||void 0,image:a.images?.large||a.images?.medium||void 0,rating:void 0,tags:void 0,link:`https://bangumi.tv/character/${a.id}`,nameJp:n||void 0,nameCn:a.name_cn||void 0,gender:s.get("性别")||s.get("性 别")||void 0,birthday:s.get("生日")||void 0,bloodType:s.get("血型")||void 0,height:s.get("身高")||void 0,weight:s.get("体重")||void 0,bwh:s.get("BWH")||void 0,voiceActors:m.length>0?m:void 0,metadata:{characterId:a.id}}}function ce(a){return{type:"media",source:"bangumi",title:a.name||"未命名作品",subtitle:a.name_cn||void 0,description:a.summary||void 0,image:a.images?.large||a.images?.common||void 0,rating:a.rating?.score||void 0,tags:a.tags?.map(s=>s.name).slice(0,5)||void 0,link:`https://bangumi.tv/subject/${a.id}`,episode:a.eps||void 0,status:a.status==="Air"?"on-air":a.status==="End"?"finished":"planned",airDate:a.date||void 0,rank:a.rank||void 0,metadata:{bangumiId:a.id,ratingCount:a.rating?.total||void 0}}}const ue=["data-type","data-source"],de={key:1,class:"card-image-placeholder"},me={class:"card-content"},he={class:"character-main-section"},ve={class:"title-section"},pe={class:"card-title"},ge={key:0,class:"card-subtitle"},_e={key:0,class:"card-description"},fe={class:"character-info-section"},be={key:0,class:"tags-container"},ye={key:1,class:"attributes-section"},ke={key:0,class:"attribute-item"},we={class:"attribute-value"},Ce={key:1,class:"attribute-item"},xe={class:"attribute-value"},De={key:2,class:"attribute-item"},Ae={class:"attribute-value"},Ie={key:3,class:"attribute-item"},$e={class:"attribute-value"},Te={key:4,class:"attribute-item"},Be={class:"attribute-value"},Ee={key:5,class:"attribute-item"},Me={class:"attribute-value"},ze={key:2,class:"voice-actors-section"},Le={class:"voice-actors-header"},Ne={class:"voice-actors-badges"},je={class:"card-footer"},Ve={class:"source-badge"},Je={class:"source-name"},Se=["aria-label"],Fe={class:"media-main-section"},Pe={class:"title-section"},We={class:"card-title"},qe={key:0,class:"card-subtitle"},Re={key:0,class:"card-description"},He={class:"media-info-section"},Ke={key:0,class:"rating-stars-section"},Oe={class:"rating-stars"},Ue={class:"rating-text"},Ge={key:1,class:"tags-container"},Qe={key:2,class:"media-info-combined"},Xe={class:"media-info-label"},Ye={class:"media-info-value"},Ze={key:0,class:"date-item"},et={key:1,class:"date-item"},tt={class:"card-footer"},st={class:"source-badge"},at={class:"source-name"},it=["aria-label"],nt={key:1,class:"info-card info-card-error"},rt={key:2,class:"info-card info-card-loading"},ot=Q({__name:"index",props:{data:{},loading:{type:Boolean},error:{type:Boolean},type:{},id:{}},setup(a){const s=a,n=R,m=L,w=new H(100,1440*60*1e3),K=new H(100,1440*60*1e3),A=W(!1),_=W(""),C=X(null);let b=null;const N=p(()=>"type"in s&&"id"in s),M=p(()=>"data"in s&&s.data),t=p(()=>M.value?s.data:C.value),I=p(()=>t.value?R(t.value):!1),j=p(()=>t.value?L(t.value):!1),$=p(()=>t.value?t.value.source==="bangumi"?"Bangumi":t.value.source:""),T=p(()=>"ri:bilibili-line");function V(){t.value?.link&&window.open(t.value.link,"_blank")}function J(g){return g?new Date(g).toLocaleDateString("zh-CN"):""}const S=p(()=>{if(!j.value||!t.value||!L(t.value))return[];const g=t.value,l=[];return g.episode&&l.push({label:"话数",value:g.episode}),g.rank&&l.push({label:"排名",value:`#${g.rank}`}),l}),O=p(()=>I.value?"card-layout-vertical":"card-layout-horizontal"),U=p(()=>I.value?"card-image-portrait":"card-image-landscape"),F=p(()=>M.value?s.loading||!1:A.value),P=p(()=>M.value?s.error||!1:_.value!=="");async function G(){if(!N.value)return;const g=s,{type:l,id:f}=g;if(!f)return;const h=l==="character"?w:K,B=h.get(f);if(B){C.value=B,A.value=!1,_.value="";return}A.value=!0,_.value="",b&&b.abort(),b=new AbortController;try{const c=se.bangumi?.apiBase;if(!c){_.value="Bangumi API 未配置",console.error("[InfoCard] Bangumi API base not configured");return}let v,x;l==="character"?(v=await fetch(`${c}/api/character?id=${f}`,{signal:b.signal}),v.ok?(x=await v.json(),x.id?(C.value=le(x),h.set(f,C.value)):_.value="获取人物数据失败"):_.value=`请求失败 (${v.status})`):l==="media"&&(v=await fetch(`${c}/api/subject?id=${f}`,{signal:b.signal}),v.ok?(x=await v.json(),x.id?(C.value=ce(x),h.set(f,C.value)):_.value="获取媒体数据失败"):_.value=`请求失败 (${v.status})`)}catch(c){c instanceof Error&&c.name!=="AbortError"&&(console.error("[InfoCard] Fetch error:",c),_.value=c.message||"未知错误")}finally{A.value=!1}}return Y(async()=>{N.value&&await G()}),Z(()=>{b&&b.abort()}),(g,l)=>{const f=ee,h=te,B=ie;return!e(F)&&!e(P)&&e(t)?(r(),o("div",{key:0,class:"info-card","data-type":e(t).type,"data-source":e(t).source},[i("div",{class:z(e(O))},[i("div",{class:z(["card-image-wrapper",e(U)])},[e(t).image?(r(),E(f,{key:0,src:e(t).image,alt:e(t).title,class:"card-image",loading:"lazy"},null,8,["src","alt"])):(r(),o("div",de,[y(h,{name:e(I)?"ph:user-circle-bold":"ph:image-square-bold",class:"placeholder-icon"},null,8,["name"])]))],2),i("div",me,[e(I)&&e(n)(e(t))?(r(),o(k,{key:0},[i("div",he,[i("div",ve,[i("h3",pe,d(e(t).title),1),e(t).subtitle?(r(),o("p",ge,d(e(t).subtitle),1)):u("",!0)]),e(t).description?(r(),o("p",_e,d(e(t).description),1)):u("",!0)]),i("div",fe,[e(t).tags&&e(t).tags.length>0?(r(),o("div",be,[(r(!0),o(k,null,D(e(t).tags,c=>(r(),o("span",{key:c,class:"tag"},d(c),1))),128))])):u("",!0),e(t).gender||e(t).birthday||e(t).height||e(t).bloodType||e(t).weight||e(t).bwh?(r(),o("div",ye,[e(t).gender?(r(),o("div",ke,[l[0]||(l[0]=i("span",{class:"attribute-label"},"性别",-1)),i("span",we,d(e(t).gender),1)])):u("",!0),e(t).birthday?(r(),o("div",Ce,[l[1]||(l[1]=i("span",{class:"attribute-label"},"生日",-1)),i("span",xe,d(e(t).birthday),1)])):u("",!0),e(t).height?(r(),o("div",De,[l[2]||(l[2]=i("span",{class:"attribute-label"},"身高",-1)),i("span",Ae,d(e(t).height),1)])):u("",!0),e(t).bloodType?(r(),o("div",Ie,[l[3]||(l[3]=i("span",{class:"attribute-label"},"血型",-1)),i("span",$e,d(e(t).bloodType),1)])):u("",!0),e(t).weight?(r(),o("div",Te,[l[4]||(l[4]=i("span",{class:"attribute-label"},"体重",-1)),i("span",Be,d(e(t).weight),1)])):u("",!0),e(t).bwh?(r(),o("div",Ee,[l[5]||(l[5]=i("span",{class:"attribute-label"},"三围",-1)),i("span",Me,d(e(t).bwh),1)])):u("",!0)])):u("",!0),e(t).voiceActors&&e(t).voiceActors.length>0?(r(),o("div",ze,[i("div",Le,[y(h,{name:"ri:mic-line",class:"voice-actors-icon"}),l[6]||(l[6]=i("span",null,"声优",-1))]),i("div",Ne,[(r(!0),o(k,null,D(e(t).voiceActors,(c,v)=>(r(),E(B,{key:v,img:c.image,text:c.name,link:c.link,round:""},null,8,["img","text","link"]))),128))])])):u("",!0),i("div",je,[i("div",Ve,[e(T)?(r(),E(h,{key:0,name:e(T),class:"source-icon"},null,8,["name"])):u("",!0),i("span",Je,d(e($)),1)]),e(t).link?(r(),o("button",{key:0,class:"view-button","aria-label":`查看 ${e($)} 上 ${e(t).title} 的详情`,onClick:V},[l[7]||(l[7]=i("span",null,"查看详情",-1)),y(h,{name:"ri:arrow-right-line",class:"button-icon"})],8,Se)):u("",!0)])])],64)):e(j)&&e(m)(e(t))?(r(),o(k,{key:1},[i("div",Fe,[i("div",Pe,[i("h3",We,d(e(t).title),1),e(t).subtitle?(r(),o("p",qe,d(e(t).subtitle),1)):u("",!0)]),e(t).description?(r(),o("p",Re,d(e(t).description),1)):u("",!0)]),i("div",He,[e(t).rating?(r(),o("div",Ke,[i("div",Oe,[(r(),o(k,null,D(5,c=>y(h,{key:c,class:z(["star-icon",c<=Math.round(e(t).rating/2)?"star-filled":"star-empty"]),name:c<=Math.round(e(t).rating/2)?"ri:star-fill":"ri:star-line"},null,8,["class","name"])),64))]),i("span",Ue,d(e(t).rating),1)])):u("",!0),e(t).tags&&e(t).tags.length>0?(r(),o("div",Ge,[(r(!0),o(k,null,D(e(t).tags,c=>(r(),o("span",{key:c,class:"tag"},d(c),1))),128))])):u("",!0),e(S).length>0||e(t).airDate||e(t).endDate?(r(),o("div",Qe,[(r(!0),o(k,null,D(e(S),(c,v)=>(r(),o("div",{key:`${c.label}-${v}`,class:"media-info-item"},[i("span",Xe,d(c.label)+":",1),i("span",Ye,d(c.value),1)]))),128)),e(t).airDate?(r(),o("span",Ze,[y(h,{name:"clarity:date-line",class:"date-icon"}),q(" "+d(J(e(t).airDate)),1)])):u("",!0),e(t).endDate?(r(),o("span",et,[y(h,{name:"clarity:date-line",class:"date-icon"}),q(" "+d(J(e(t).endDate)),1)])):u("",!0)])):u("",!0),i("div",tt,[i("div",st,[e(T)?(r(),E(h,{key:0,name:e(T),class:"source-icon"},null,8,["name"])):u("",!0),i("span",at,d(e($)),1)]),e(t).link?(r(),o("button",{key:0,class:"view-button","aria-label":`查看 ${e($)} 上 ${e(t).title} 的详情`,onClick:V},[l[8]||(l[8]=i("span",null,"查看详情",-1)),y(h,{name:"ri:arrow-right-line",class:"button-icon"})],8,it)):u("",!0)])])],64)):u("",!0)])],2)],8,ue)):e(P)?(r(),o("div",nt,[...l[9]||(l[9]=[i("div",{class:"error-content"},[i("p",null,"加载失败"),i("small",null,"请检查 ID 是否正确或稍后重试")],-1)])])):e(F)?(r(),o("div",rt,[...l[10]||(l[10]=[i("div",{class:"loading-skeleton"},null,-1)])])):u("",!0)}}}),dt=Object.assign(ae(ot,[["__scopeId","data-v-9e9bd9dc"]]),{__name:"InfoCard"});export{dt as default};
