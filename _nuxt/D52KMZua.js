import{D as Q,r as g,y as I,o as J,bp as K,ae as X,d as s,e as r,f as u,O as t,h as i,Q as N,t as y,g as $,M as Y,R as Z,F as O,S as q,aW as ee,n as te,aG as j,_ as ae}from"./CDkZ9lWR.js";import{s as se}from"./vh-gqUA6.js";const re={class:"galgame-wrapper"},ne={key:0,class:"galgame-error"},oe={key:1,class:"md-galgame ai-galgame"},le={class:"ai-galgame-header"},ie={class:"ai-galgame-title"},ce={class:"ai-galgame-label"},ue={class:"ai-galgame-toolbar"},ve=["title"],ge={key:0,class:"galgame-speaker"},de={class:"galgame-text"},fe={key:0,class:"typewriter-caret"},me={key:2,class:"galgame-hint"},he={key:0,class:"galgame-choices"},ye=["onClick"],pe={key:1,class:"galgame-ending"},_e={key:2,class:"galgame-history-panel"},ke={class:"history-header"},be={class:"history-title"},we={class:"history-list"},xe={key:0,class:"history-empty"},Te=["onClick"],Ce={class:"history-index"},Ie={class:"history-content"},$e={key:0,class:"history-choice"},Ee={key:1,class:"history-paragraph"},Se={key:3,class:"galgame-empty"},Ge=Q({__name:"Galgame",props:{data:{},showHistory:{type:Boolean,default:!0},showRestart:{type:Boolean,default:!0}},setup(L){const p=L,d=g(null),m=g(""),x=g(""),v=g([]),w=g({}),f=g(!1),h=g(!1),_=g(0),S=g(""),G=g(!1);let T=null;const l=I(()=>d.value?d.value.paragraphs.find(e=>e.id===x.value):null),C=I(()=>l.value?.choices?l.value.choices.filter(e=>e.visible===void 0?!0:typeof e.visible=="boolean"?e.visible:typeof e.visible=="function"?e.visible():!0):[]),B=I(()=>{if(!l.value)return[];const e=l.value.text;return Array.isArray(e)?e:e.split(`
`)}),k=I(()=>_.value<B.value.length-1),D=I(()=>B.value.slice(0,_.value+1));async function R(e){try{const o=`${e.startsWith("/")?e:`/assets/galgames/${e}`}`,c=await fetch(o);if(!c.ok)throw new Error(`Failed to load: ${c.statusText}`);return await c.json()}catch(a){return m.value=`加载游戏数据失败: ${a instanceof Error?a.message:String(a)}`,console.error(m.value,a),null}}async function H(){try{m.value="";let e=null;if(p.data&&(typeof p.data=="string"?e=await R(p.data):e=p.data),!e){m.value="未提供有效的游戏数据";return}d.value=e,x.value=e.start,_.value=0,w.value={...e.globalMarks},v.value=[],f.value=!1,h.value=!1,M(e.start)}catch(e){m.value=`初始化失败: ${e instanceof Error?e.message:String(e)}`,console.error(m.value,e)}}function M(e,a){v.value.push({paragraphId:e,choiceText:a,timestamp:Date.now()})}function U(e){M(e.next,e.text),e.mark&&(typeof e.mark=="string"?w.value[e.mark]=!0:Object.assign(w.value,e.mark)),x.value=e.next,_.value=0,l.value?.isEnding&&(f.value=!0),j(()=>{const a=document.querySelector(".galgame-container");a&&a.scrollIntoView({behavior:"smooth",block:"start"})})}function V(){if(l.value){if(k.value){_.value++;return}C.value.length>0||l.value.auto&&(M(l.value.auto),x.value=l.value.auto,_.value=0,l.value?.isEnding&&(f.value=!0),j(()=>{const e=document.querySelector(".galgame-container");e&&e.scrollIntoView({behavior:"smooth",block:"start"})}))}}function z(e){if(!e.target.closest("button")){if(k.value){V();return}if(f.value&&k.value){V();return}!f.value&&C.value.length>0||V()}}function F(){H()}function A(e){if(e<0||e>=v.value.length)return;const a=v.value[e];if(a){x.value=a.paragraphId,_.value=0,v.value.splice(e+1),w.value={...d.value?.globalMarks};for(let n=1;n<=e;n++){const o=v.value[n];if(!o)continue;const c=v.value[n-1];if(!c)continue;const b=d.value?.paragraphs.find(P=>P.id===c.paragraphId);if(!b)continue;const E=b.choices?.find(P=>P.text===o.choiceText);E?.mark&&(typeof E.mark=="string"?w.value[E.mark]=!0:Object.assign(w.value,E.mark))}h.value=!1,j(()=>{const n=document.querySelector(".galgame-container");n&&n.scrollIntoView({behavior:"smooth",block:"start"})})}}J(()=>{H()}),K(()=>{p.data&&H()});function W(){T&&clearInterval(T);const e=D.value;if(e.length===0)return;const a=e[e.length-1]||"";G.value=!0;const n=e.slice(0,-1).join(`
`);S.value=n+(n?`
`:"");let o=0;T=se(()=>{o<=a.length?(S.value=n+(n?`
`:"")+a.substring(0,o),o++):(T&&clearInterval(T),G.value=!1)},50)}return X(D,()=>{W()},{immediate:!0}),(e,a)=>{const n=Y;return r(),s("div",re,[t(m)?(r(),s("div",ne,[a[2]||(a[2]=i("strong",null,"错误:",-1)),N(" "+y(t(m)),1)])):u("",!0),t(l)&&t(d)?(r(),s("div",oe,[i("div",le,[i("div",ie,[$(n,{name:"proicons:game",class:"ai-icon-galgame"}),i("span",ce,y(t(d).title||"Galgame"),1)]),i("div",ue,[p.showHistory?(r(),s("button",{key:0,class:"toolbar-btn",title:t(h)?"关闭历史":"打开历史",onClick:a[0]||(a[0]=o=>h.value=!t(h))},[$(n,{name:"material-symbols:history"})],8,ve)):u("",!0),p.showRestart?(r(),s("button",{key:1,class:"toolbar-btn",title:"重新开始",onClick:F},[$(n,{name:"material-symbols:restart-alt"})])):u("",!0)])]),i("div",{class:"ai-galgame-content",onClick:z},[t(l).speaker?(r(),s("div",ge,y(t(l).speaker),1)):u("",!0),t(l).background?(r(),s("div",{key:1,class:"galgame-background",style:Z({backgroundImage:`url(${t(l).background})`})},null,4)):u("",!0),i("div",de,[N(y(t(S)),1),t(G)?(r(),s("span",fe,"_")):u("",!0)]),t(k)||t(f)&&t(k)||!t(f)&&t(C).length===0?(r(),s("div",me," 点击继续 ")):u("",!0)]),!t(f)&&!t(k)&&t(C).length>0?(r(),s("div",he,[(r(!0),s(O,null,q(t(C),(o,c)=>(r(),s("button",{key:c,class:"choice-btn",onClick:ee(b=>U(o),["stop"])},y(o.text),9,ye))),128))])):u("",!0),t(f)&&!t(k)?(r(),s("div",pe,[i("button",{class:"ending-btn",onClick:F}," 重新开始 ")])):u("",!0)])):u("",!0),t(h)?(r(),s("div",_e,[i("div",ke,[i("div",be,[$(n,{name:"material-symbols:history",class:"history-icon"}),a[3]||(a[3]=i("h3",null,"历史回顾",-1))]),i("button",{title:"关闭",class:"history-close",onClick:a[1]||(a[1]=o=>h.value=!1)},[$(n,{name:"yesicon:close"})])]),i("div",we,[t(v).length===0?(r(),s("div",xe," 还没有历史记录 ")):(r(!0),s(O,{key:1},q(t(v),(o,c)=>(r(),s("button",{key:c,class:te(["history-item",{active:c===t(v).length-1}]),onClick:b=>A(c)},[i("span",Ce,y(c+1),1),i("span",Ie,[o.choiceText?(r(),s("span",$e,"→ "+y(o.choiceText),1)):(r(),s("span",Ee,y(t(d).paragraphs.find(b=>b.id===o.paragraphId)?.speaker||"开始"),1))])],10,Te))),128))])])):u("",!0),!t(l)&&!t(d)&&!t(h)?(r(),s("div",Se," 无游戏数据 ")):u("",!0)])}}}),Ve=Object.assign(ae(Ge,[["__scopeId","data-v-c12eb012"]]),{__name:"Galgame"});export{Ve as default};
