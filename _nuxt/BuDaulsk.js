import{J as V,r as g,N as W,x as E,Q as m,aN as v,b5 as i,aQ as P,K as o,aR as b,br as J,aU as K,b8 as y,a_ as X,aZ as Y,b4 as Z}from"./D6ajeznB.js";import{f as w,_ as G}from"./D_HPzWS8.js";const M=new Map,C=new Map,z=t=>{try{let e=t.match(/[?&]id=(\d+)/);return e?.[1]||(e=t.match(/\/song[/?#]*(\d+)/),e?.[1])||(e=t.match(/\/m\/song\/(\d+)/),e?.[1])?e[1]:null}catch{return null}},F=t=>{const e=t.toLowerCase();return e.includes("music.163.com")||e.includes("netease")?"netease":e.includes("qq.com")||e.includes("y.qq.com")?"tencent":e.includes("kuwo.cn")?"kuwo":e.includes("xiami.com")?"xiami":e.includes("kugou.com")?"kugou":e.includes("youtube.com")||e.includes("youtu.be")?"youtube":"url"},j=(t,e)=>{switch(e){case"netease":return z(t);case"tencent":return t.match(/(?:song\/|songid=)(\d+)/)?.[1]||null;default:return t.match(/(\d+)/)?.[1]||null}},H=async t=>{const e=`netease:${t}`;if(C.has(e))return C.get(e);const s=(async()=>{try{if(!w.meting?.apiServer)return console.warn("[MusicParser] Meting API server not configured"),{};const d=`${w.meting.apiServer.endsWith("/")?w.meting.apiServer:`${w.meting.apiServer}/`}?type=song&id=${t}`;console.log("[MusicParser] Fetching song metadata from:",d);const a=await fetch(d);if(!a.ok)return console.warn(`[MusicParser] Song API returned status ${a.status}`),{};const c=await a.json();console.log("[MusicParser] Song API response:",c);let r=c;if(Array.isArray(c)&&c.length>0&&(r=c[0]),!r||typeof r!="object")return console.warn("[MusicParser] Invalid response format:",c),{};let h=r.pic,l;r.url&&(console.log("[MusicParser] Found audio URL:",r.url),l=r.url);const S={title:r.name||r.title||"未知曲目",artist:r.artist?Array.isArray(r.artist)?r.artist.map(k=>typeof k=="string"?k:k.name).join(" / "):String(r.artist):"未知艺术家",cover:h||void 0,url:l||void 0};return console.log("[MusicParser] Parsed result:",S),S}catch(u){return console.error(`[MusicParser] Failed to fetch netease metadata for id ${t}:`,u),{}}})();return C.set(e,s),s},I=()=>({id:"",title:"解析失败",artist:"无法解析音乐信息",source:"url"}),ee=t=>{if(!t||typeof t!="string")return I();if(M.has(t))return M.get(t);let e;try{if(t.trim().startsWith("{")){const s=JSON.parse(t);if(s&&typeof s=="object")return e={id:(s.id||"").toString(),title:(s.title||"未知曲目").toString(),artist:(s.artist||"未知艺术家").toString(),cover:s.cover?String(s.cover):void 0,url:s.url?String(s.url):void 0,source:s.source||"url",platform:s.platform?String(s.platform):void 0},M.set(t,e),e}if(t.trim().startsWith("http")){const s=t.trim(),u=F(s);return e={id:j(s,u)||"",title:"加载中...",artist:"加载中...",url:s,source:u,cover:void 0},M.set(t,e),e}throw new Error("Invalid format")}catch(s){console.warn("[MusicParser] Failed to parse music extension:",t,s),e=I()}return M.set(t,e),e},te=()=>{M.clear(),C.clear()},se=()=>({parseMusicExtension:ee,createEmptyMusic:I,clearCache:te,detectMusicSource:F,extractMusicId:j,extractNeteaseMusicId:z,fetchNeteaseMetadata:H}),re={class:"music-player"},ae={class:"music-info"},oe={key:0,class:"music-cover"},ne={class:"music-details"},ce={key:0,class:"music-loading"},ie={class:"music-title"},ue={class:"music-artist"},le=["href","title"],de=["src"],me={key:1,class:"music-progress-section"},ve={class:"music-time"},fe={class:"current-time"},pe={class:"duration"},ge={class:"music-actions"},he=["title"],_e={key:2,class:"music-error"},ye=V({__name:"MusicPlayer",props:{music:{}},setup(t){const e=t,{fetchNeteaseMetadata:s}=se(),u=g(!0),d=g(!1),a=g(e.music),c=g(!1),r=g(),h=g(0),l=g(0),S={netease:"网易云音乐",tencent:"QQ音乐",kuwo:"酷我音乐",xiami:"虾米音乐",kugou:"酷狗音乐",youtube:"YouTube",url:"外部链接"};W(async()=>{if(e.music.source!=="netease"||!e.music.id){u.value=!1;return}try{u.value=!0;const n=await s(e.music.id);(n.title||n.artist||n.cover||n.url)&&(a.value={...a.value,title:n.title||a.value.title,artist:n.artist||a.value.artist,cover:n.cover||a.value.cover,url:n.url||a.value.url})}catch(n){console.error("[MusicPlayer] Failed to fetch metadata:",n),d.value=!0}finally{u.value=!1}});const A=E(()=>({title:a.value.title||"未知曲目",artist:a.value.artist||"未知艺术家",platform:a.value.platform||a.value.source||"音乐"})),$=E(()=>S[a.value.source]||a.value.source),N=n=>{if(!isFinite(n))return"0:00";const f=Math.floor(n/60),p=Math.floor(n%60);return`${f}:${p<10?"0":""}${p}`},L=E(()=>l.value?h.value/l.value*100:0),B=()=>{r.value&&(c.value?r.value.pause():r.value.play().catch(n=>{console.warn("[MusicPlayer] Failed to play audio:",n),d.value=!0}))},U=()=>{c.value=!1},x=()=>{c.value=!0},O=()=>{c.value=!1},R=()=>{console.error("[MusicPlayer] Audio playback error"),c.value&&(d.value=!0),c.value=!1},q=()=>{r.value&&(h.value=r.value.currentTime)},D=()=>{r.value&&(l.value=r.value.duration)},Q=n=>{const p=n.currentTarget.getBoundingClientRect(),_=(n.clientX-p.left)/p.width;if(r.value&&l.value){const T=_*l.value;r.value.currentTime=Math.max(0,Math.min(T,l.value)),h.value=T}};return(n,f)=>{const p=J,_=G;return v(),m("div",re,[i("div",ae,[o(a).cover?(v(),m("div",oe,[b(p,{src:o(a).cover,alt:o(A).title,class:"cover-image",loading:"lazy",fit:"cover"},null,8,["src","alt"])])):P("",!0),i("div",ne,[o(u)?(v(),m("div",ce,[b(_,{name:"eos-icons:loading",size:"14"}),f[0]||(f[0]=i("span",null,"加载中...",-1))])):(v(),m(K,{key:1},[i("div",ie,y(o(A).title),1),i("div",ue,y(o(A).artist),1),i("a",{href:`https://music.163.com/#/song?id=${o(a).id}`,target:"_blank",rel:"noopener noreferrer",class:"music-source",title:`在 ${o($)} 中打开`},[b(_,{name:"mdi:music",size:"14"}),i("span",null,y(o($)),1)],8,le)],64))])]),o(a).url?(v(),m("audio",{key:0,ref_key:"audioElement",ref:r,src:o(a).url,crossorigin:"anonymous",onEnded:U,onPlay:x,onPause:O,onError:R,onTimeupdate:q,onLoadedmetadata:D},null,40,de)):P("",!0),o(c)&&o(l)>0?(v(),m("div",me,[i("div",{class:"music-progress-container",onClick:Q},[i("div",{class:"music-progress-bar",style:X({width:`${o(L)}%`})},null,4)]),i("div",ve,[i("span",fe,y(N(o(h))),1),i("span",pe,y(N(o(l))),1)])])):P("",!0),i("div",ge,[o(a).url?(v(),m("button",{key:0,class:Y(["play-button",{playing:o(c)}]),title:o(c)?"暂停":"播放",onClick:B},[b(_,{name:o(c)?"mdi:pause-circle":"mdi:play-circle",size:"20"},null,8,["name"]),i("span",null,y(o(c)?"暂停":"播放"),1)],10,he)):P("",!0)]),o(d)&&o(a).url?(v(),m("div",_e,[b(_,{name:"mdi:alert-circle",size:"16"}),f[1]||(f[1]=i("span",null,"音乐加载失败",-1))])):P("",!0)])}}}),Me=Object.assign(Z(ye,[["__scopeId","data-v-b491502a"]]),{__name:"MusicPlayer"}),Se=Object.freeze(Object.defineProperty({__proto__:null,default:Me},Symbol.toStringTag,{value:"Module"}));export{Se as M,Me as _,se as u};
