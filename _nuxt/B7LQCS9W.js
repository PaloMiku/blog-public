import{J as de,r as v,o as me,N as fe,x as T,Q as h,aO as p,b6 as _,aS as P,aR as x,K as t,bs as ve,aV as K,b9 as C,aU as pe,aN as ye,a_ as W,aW as he,b5 as ge}from"./C30-xQm5.js";import{f as S,_ as _e,k as we}from"./BcHDEQLf.js";import{_ as Me}from"./BNAXQ_5p.js";const N=new Map,q=new Map,F=new Map;function ke(r){if(!r)return[];const e=[],s=r.split(`
`);for(const u of s){if(!u.trim()||!u.includes("["))continue;const m=u.match(/\[(\d{2}):(\d{2})\.(\d+)\]/);if(!m)continue;const g=Number.parseInt(m[1]??"0",10),f=Number.parseInt(m[2]??"0",10),o=Number.parseInt(m[3]??"0",10),M=g*60+f+o/1e3;let l=u;l=l.replace(/\[\d{2}:\d{2}\.\d+\]/g,"").trim(),l&&e.push({time:M,text:l})}return e.sort((u,m)=>u.time-m.time)}function Q(r){try{let e=r.match(/[?&]id=(\d+)/);return e?.[1]||(e=r.match(/\/song[/?#]*(\d+)/),e?.[1])||(e=r.match(/\/m\/song\/(\d+)/),e?.[1])?e[1]:null}catch{return null}}function J(r){const e=r.toLowerCase();return e.includes("music.163.com")||e.includes("netease")?"netease":e.includes("qq.com")||e.includes("y.qq.com")?"tencent":e.includes("kuwo.cn")?"kuwo":e.includes("xiami.com")?"xiami":e.includes("kugou.com")?"kugou":e.includes("youtube.com")||e.includes("youtu.be")?"youtube":"url"}function Y(r,e){switch(e){case"netease":return Q(r);case"tencent":return r.match(/(?:song\/|songid=)(\d+)/)?.[1]||null;default:return r.match(/(\d+)/)?.[1]||null}}async function be(r){const e=`netease:${r}`;if(q.has(e))return q.get(e);const s=(async()=>{try{if(!S.meting?.apiServer)return console.warn("[MusicParser] Meting API server not configured"),{};const m=`${S.meting.apiServer.endsWith("/")?S.meting.apiServer:`${S.meting.apiServer}/`}?type=song&id=${r}`,g=await fetch(m);if(!g.ok)return console.warn(`[MusicParser] Song API returned status ${g.status}`),{};const f=await g.json();let o=f;if(Array.isArray(f)&&f.length>0&&(o=f[0]),!o||typeof o!="object")return console.warn("[MusicParser] Invalid response format:",f),{};const M=o.pic;let l;return o.url&&(l=o.url),{title:o.name||o.title||"未知曲目",artist:o.artist?Array.isArray(o.artist)?o.artist.map(a=>typeof a=="string"?a:a.name).join(" / "):String(o.artist):"未知艺术家",cover:M||void 0,url:l||void 0}}catch(u){return console.error(`[MusicParser] Failed to fetch netease metadata for id ${r}:`,u),{}}})();return q.set(e,s),s}async function Pe(r){const e=`netease:lyrics:${r}`;if(F.has(e))return F.get(e);const s=(async()=>{try{if(!S.meting?.apiServer)return console.warn("[MusicParser] Meting API server not configured"),"";const m=`${S.meting.apiServer.endsWith("/")?S.meting.apiServer:`${S.meting.apiServer}/`}?server=netease&type=lrc&id=${r}`,g=await fetch(m);if(!g.ok)return console.warn(`[MusicParser] Lyric API returned status ${g.status}`),"";const f=await g.text();return!f||f.includes("暂无歌词")?"":f}catch(u){return console.error(`[MusicParser] Failed to fetch lyrics for id ${r}:`,u),""}})();return F.set(e,s),s}function D(){return{id:"",title:"解析失败",artist:"无法解析音乐信息",source:"url"}}function Se(r){if(!r||typeof r!="string")return D();if(N.has(r))return N.get(r);let e;try{if(r.trim().startsWith("{")){const s=JSON.parse(r);if(s&&typeof s=="object")return e={id:(s.id||"").toString(),title:(s.title||"未知曲目").toString(),artist:(s.artist||"未知艺术家").toString(),cover:s.cover?String(s.cover):void 0,url:s.url?String(s.url):void 0,source:s.source||"url",platform:s.platform?String(s.platform):void 0},N.set(r,e),e}if(r.trim().startsWith("http")){const s=r.trim(),u=J(s);return e={id:Y(s,u)||"",title:"加载中...",artist:"加载中...",url:s,source:u,cover:void 0},N.set(r,e),e}throw new Error("Invalid format")}catch(s){console.warn("[MusicParser] Failed to parse music extension:",r,s),e=D()}return N.set(r,e),e}function $e(){N.clear(),q.clear(),F.clear()}function Le(r,e){if(!e)return null;switch(r){case"netease":return`https://music.163.com/#/song?id=${e}`;case"tencent":return`https://y.qq.com/n/yqq/song/${e}.html`;case"kuwo":return`https://www.kuwo.cn/play_detail/${e}`;case"xiami":return`https://www.xiami.com/song/${e}`;case"kugou":return`https://www.kugou.com/song/${e}`;case"youtube":return`https://www.youtube.com/watch?v=${e}`;case"url":return null;default:return null}}function xe(){return{parseMusicExtension:Se,createEmptyMusic:D,clearCache:$e,detectMusicSource:J,extractMusicId:Y,extractNeteaseMusicId:Q,fetchNeteaseMetadata:be,fetchNeteaseLyrics:Pe,getMusicLink:Le,parseLyrics:ke}}const Ce={class:"music-player"},Ie={class:"music-info"},Ee={key:0,class:"music-cover"},Ne={class:"music-details"},Ae={key:0,class:"music-loading"},Te={class:"music-title"},ze={class:"music-artist"},qe=["href","title"],Fe={key:1,class:"music-source-text"},je=["src"],Oe={class:"music-actions"},Be=["title"],Ue=["title","disabled"],We={key:2,class:"lyrics-display"},De={key:3,class:"music-error"},Re=de({__name:"MusicPlayer",props:{music:{}},setup(r){const e=r,{fetchNeteaseMetadata:s,fetchNeteaseLyrics:u,detectMusicSource:m,extractMusicId:g,getMusicLink:f,parseLyrics:o}=xe(),M=v(!1),l=v(!1),k=v(""),a=v(e.music),d=v(!1),y=v(),I=v(0),b=v(0),j=v(""),$=v(!1),w=v([]),A=v(0),L=v(!1),Z={netease:"网易云音乐",tencent:"QQ音乐",kuwo:"酷我音乐",xiami:"虾米音乐",kugou:"酷狗音乐",youtube:"YouTube",url:"外部链接"};me(()=>e.music.id,i=>{i&&(a.value=e.music,d.value&&y.value&&y.value.pause(),d.value=!1,I.value=0,b.value=0,l.value=!1,k.value="",L.value=!1,j.value="",w.value=[],A.value=0,$.value=!1,R())}),fe(()=>{a.value=e.music,R()});const O=T(()=>({title:a.value.title||"未知曲目",artist:a.value.artist||"未知艺术家",platform:a.value.platform||a.value.source||"音乐"})),B=T(()=>Z[a.value.source]||a.value.source),U=T(()=>f(a.value.source,a.value.id)),G=T(()=>!!U.value),H=T(()=>b.value?I.value/b.value*100:0);async function R(){let i=a.value.source,n=a.value.id;if(a.value.url&&!n&&(i=m(a.value.url),n=g(a.value.url,i)||"",a.value={...a.value,source:i,id:n}),i!=="netease"||!n){M.value=!1;return}try{M.value=!0,l.value=!1,k.value="";const c=await s(n);(c.title||c.artist||c.cover||c.url)&&(a.value={...a.value,title:c.title||a.value.title,artist:c.artist||a.value.artist,cover:c.cover||a.value.cover,url:c.url||a.value.url}),await X(n)}catch(c){console.error("[MusicPlayer] Failed to fetch metadata:",c),l.value=!0,c instanceof TypeError?k.value="网络连接失败，请检查网络设置":c instanceof SyntaxError?k.value="音乐信息格式错误":k.value="加载音乐信息失败"}finally{M.value=!1}}async function X(i){try{$.value=!0;const n=await u(i);n&&(j.value=n,w.value=o(n),A.value=0,L.value=!0)}catch(n){console.warn("[MusicPlayer] Failed to fetch lyrics:",n),j.value="",w.value=[]}finally{$.value=!1}}function V(i){if(!Number.isFinite(i))return"0:00";const n=Math.floor(i/60),c=Math.floor(i%60);return`${n}:${c<10?"0":""}${c}`}function ee(){y.value&&(d.value?y.value.pause():y.value.play().catch(i=>{console.warn("[MusicPlayer] Failed to play audio:",i),l.value=!0}))}function te(){d.value=!1}function re(){d.value=!0}function ae(){d.value=!1}function se(){console.error("[MusicPlayer] Audio playback error"),d.value&&(l.value=!0,k.value="音乐播放失败，可能文件不可用或格式不支持"),d.value=!1}function ne(){if(!y.value)return;const i=y.value.currentTime;Math.abs(i-I.value)>=.1&&(I.value=i),ie(i)}function ie(i){if(w.value.length!==0)for(let n=w.value.length-1;n>=0;n--){const c=w.value[n];if(c&&c.time<=i){A.value=n;break}}}function ce(){y.value&&(b.value=y.value.duration)}function ue(i){if(y.value&&b.value){const n=i/100*b.value;y.value.currentTime=n,I.value=n}}return(i,n)=>{const c=ve,E=_e,oe=Me,le=we;return p(),h("div",Ce,[_("div",Ie,[t(a).cover?(p(),h("div",Ee,[P(c,{src:t(a).cover,alt:t(O).title,class:"cover-image",loading:"lazy",fit:"cover"},null,8,["src","alt"])])):x("",!0),_("div",Ne,[t(M)?(p(),h("div",Ae,[P(E,{name:"eos-icons:loading",size:"14"}),n[1]||(n[1]=_("span",null,"加载中...",-1))])):(p(),h(K,{key:1},[_("div",Te,C(t(O).title),1),_("div",ze,C(t(O).artist),1),t(G)&&t(U)?(p(),h("a",{key:0,href:t(U),target:"_blank",rel:"noopener noreferrer",class:"music-source",title:`在 ${t(B)} 中打开`},[P(E,{name:"mdi:music",size:"14"}),_("span",null,C(t(B)),1)],8,qe)):(p(),h("div",Fe,[P(E,{name:"mdi:music",size:"14"}),_("span",null,C(t(B)),1)]))],64))])]),P(le,null,{default:pe(()=>[t(a).url?(p(),h("audio",{key:0,ref_key:"audioElement",ref:y,src:t(a).url,crossorigin:"anonymous",onEnded:te,onPlay:re,onPause:ae,onError:se,onTimeupdate:ne,onLoadedmetadata:ce},null,40,je)):x("",!0),t(d)&&t(b)>0?(p(),ye(oe,{key:1,percent:t(H),"current-time":V(t(I)),duration:V(t(b)),onChange:ue},null,8,["percent","current-time","duration"])):x("",!0),_("div",Oe,[t(a).url?(p(),h("button",{key:0,class:W(["play-button",{playing:t(d)}]),title:t(d)?"暂停":"播放",onClick:ee},[P(E,{name:t(d)?"mdi:pause-circle":"mdi:play-circle",size:"20"},null,8,["name"]),_("span",null,C(t(d)?"暂停":"播放"),1)],10,Be)):x("",!0),t(w).length>0||t($)?(p(),h("button",{key:1,class:W(["lyrics-toggle-button",{active:t(L),loading:t($)}]),title:t(L)?"隐藏歌词":"显示歌词",disabled:t($),onClick:n[0]||(n[0]=z=>L.value=!t(L))},[P(E,{name:t($)?"eos-icons:loading":"mdi:text-box",size:"18"},null,8,["name"])],10,Ue)):x("",!0)]),t(w).length>0&&t(L)&&t(d)?(p(),h("div",We,[(p(),h(K,null,he([-1,0,1],z=>_("div",{key:`${t(A)}-${z}`,class:W(["lyric-line",{active:z===0}])},C(t(w)[t(A)+z]?.text||""),3)),64))])):x("",!0),t(l)&&t(a).url?(p(),h("div",De,[P(E,{name:"mdi:alert-circle",size:"16"}),_("span",null,C(t(k)||"音乐加载失败"),1)])):x("",!0)]),_:1})])}}}),Ve=Object.assign(ge(Re,[["__scopeId","data-v-f42c85db"]]),{__name:"MusicPlayer"}),Ye=Object.freeze(Object.defineProperty({__proto__:null,default:Ve},Symbol.toStringTag,{value:"Module"}));export{Ye as M,Ve as _,xe as u};
