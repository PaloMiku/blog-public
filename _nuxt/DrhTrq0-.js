import{J as j,Q as f,aN as l,aZ as q,b5 as v,aQ as M,a_ as z,b8 as w,b4 as F,r as _,o as te,N as ae,x as C,aM as re,K as s,aR as P,br as se,aU as ne}from"./D6ajeznB.js";import{f as T,_ as ue}from"./DFr_1crl.js";const oe={key:0,class:"progress-time"},ce={key:0,class:"current-time"},ie={key:1,class:"duration"},le=j({__name:"ProgressBar",props:{percent:{default:0},currentTime:{default:""},duration:{default:""},showTime:{type:Boolean,default:!0},height:{default:"3px"},customClass:{}},emits:["change"],setup(t,{emit:e}){const r=e;function h(p){const d=p.currentTarget.getBoundingClientRect(),n=(p.clientX-d.left)/d.width*100;r("change",Math.max(0,Math.min(100,n)))}return(p,k)=>(l(),f("div",{class:q(["progress-section",t.customClass])},[v("div",{class:"progress-container",style:z({height:t.height}),onClick:h},[v("div",{class:"progress-bar",style:z({width:`${t.percent}%`})},null,4)],4),t.showTime&&(t.currentTime||t.duration)?(l(),f("div",oe,[t.currentTime?(l(),f("span",ce,w(t.currentTime),1)):M("",!0),t.duration?(l(),f("span",ie,w(t.duration),1)):M("",!0)])):M("",!0)],2))}}),de=Object.assign(F(le,[["__scopeId","data-v-de8435a9"]]),{__name:"ZProgressBar"}),S=new Map,E=new Map;function O(t){try{let e=t.match(/[?&]id=(\d+)/);return e?.[1]||(e=t.match(/\/song[/?#]*(\d+)/),e?.[1])||(e=t.match(/\/m\/song\/(\d+)/),e?.[1])?e[1]:null}catch{return null}}function U(t){const e=t.toLowerCase();return e.includes("music.163.com")||e.includes("netease")?"netease":e.includes("qq.com")||e.includes("y.qq.com")?"tencent":e.includes("kuwo.cn")?"kuwo":e.includes("xiami.com")?"xiami":e.includes("kugou.com")?"kugou":e.includes("youtube.com")||e.includes("youtu.be")?"youtube":"url"}function D(t,e){switch(e){case"netease":return O(t);case"tencent":return t.match(/(?:song\/|songid=)(\d+)/)?.[1]||null;default:return t.match(/(\d+)/)?.[1]||null}}async function me(t){const e=`netease:${t}`;if(E.has(e))return E.get(e);const r=(async()=>{try{if(!T.meting?.apiServer)return console.warn("[MusicParser] Meting API server not configured"),{};const p=`${T.meting.apiServer.endsWith("/")?T.meting.apiServer:`${T.meting.apiServer}/`}?type=song&id=${t}`,k=await fetch(p);if(!k.ok)return console.warn(`[MusicParser] Song API returned status ${k.status}`),{};const d=await k.json();let n=d;if(Array.isArray(d)&&d.length>0&&(n=d[0]),!n||typeof n!="object")return console.warn("[MusicParser] Invalid response format:",d),{};const g=n.pic;let a;return n.url&&(a=n.url),{title:n.name||n.title||"未知曲目",artist:n.artist?Array.isArray(n.artist)?n.artist.map(c=>typeof c=="string"?c:c.name).join(" / "):String(n.artist):"未知艺术家",cover:g||void 0,url:a||void 0}}catch(h){return console.error(`[MusicParser] Failed to fetch netease metadata for id ${t}:`,h),{}}})();return E.set(e,r),r}function B(){return{id:"",title:"解析失败",artist:"无法解析音乐信息",source:"url"}}function fe(t){if(!t||typeof t!="string")return B();if(S.has(t))return S.get(t);let e;try{if(t.trim().startsWith("{")){const r=JSON.parse(t);if(r&&typeof r=="object")return e={id:(r.id||"").toString(),title:(r.title||"未知曲目").toString(),artist:(r.artist||"未知艺术家").toString(),cover:r.cover?String(r.cover):void 0,url:r.url?String(r.url):void 0,source:r.source||"url",platform:r.platform?String(r.platform):void 0},S.set(t,e),e}if(t.trim().startsWith("http")){const r=t.trim(),h=U(r);return e={id:D(r,h)||"",title:"加载中...",artist:"加载中...",url:r,source:h,cover:void 0},S.set(t,e),e}throw new Error("Invalid format")}catch(r){console.warn("[MusicParser] Failed to parse music extension:",t,r),e=B()}return S.set(t,e),e}function ve(){S.clear(),E.clear()}function he(t,e){if(!e)return null;switch(t){case"netease":return`https://music.163.com/#/song?id=${e}`;case"tencent":return`https://y.qq.com/n/yqq/song/${e}.html`;case"kuwo":return`https://www.kuwo.cn/play_detail/${e}`;case"xiami":return`https://www.xiami.com/song/${e}`;case"kugou":return`https://www.kugou.com/song/${e}`;case"youtube":return`https://www.youtube.com/watch?v=${e}`;case"url":return null;default:return null}}function ge(){return{parseMusicExtension:fe,createEmptyMusic:B,clearCache:ve,detectMusicSource:U,extractMusicId:D,extractNeteaseMusicId:O,fetchNeteaseMetadata:me,getMusicLink:he}}const pe={class:"music-player"},ye={class:"music-info"},_e={key:0,class:"music-cover"},we={class:"music-details"},Me={key:0,class:"music-loading"},ke={class:"music-title"},be={class:"music-artist"},Pe=["href","title"],Se={key:1,class:"music-source-text"},$e=["src"],Ce={class:"music-actions"},Te=["title"],Ee={key:2,class:"music-error"},xe=j({__name:"MusicPlayer",props:{music:{}},setup(t){const e=t,{fetchNeteaseMetadata:r,detectMusicSource:h,extractMusicId:p,getMusicLink:k}=ge(),d=_(!1),n=_(!1),g=_(""),a=_(e.music),i=_(!1),c=_(),b=_(0),y=_(0),Q={netease:"网易云音乐",tencent:"QQ音乐",kuwo:"酷我音乐",xiami:"虾米音乐",kugou:"酷狗音乐",youtube:"YouTube",url:"外部链接"};te(()=>e.music,u=>{a.value=u,i.value&&c.value&&c.value.pause(),i.value=!1,b.value=0,y.value=0,n.value=!1,g.value="",N()},{deep:!0}),ae(N);const x=C(()=>({title:a.value.title||"未知曲目",artist:a.value.artist||"未知艺术家",platform:a.value.platform||a.value.source||"音乐"})),I=C(()=>Q[a.value.source]||a.value.source),A=C(()=>k(a.value.source,a.value.id)),R=C(()=>!!A.value),V=C(()=>y.value?b.value/y.value*100:0);async function N(){let u=a.value.source,m=a.value.id;if(a.value.url&&!m&&(u=h(a.value.url),m=p(a.value.url,u)||"",a.value={...a.value,source:u,id:m}),u!=="netease"||!m){d.value=!1;return}try{d.value=!0,n.value=!1,g.value="";const o=await r(m);(o.title||o.artist||o.cover||o.url)&&(a.value={...a.value,title:o.title||a.value.title,artist:o.artist||a.value.artist,cover:o.cover||a.value.cover,url:o.url||a.value.url})}catch(o){console.error("[MusicPlayer] Failed to fetch metadata:",o),n.value=!0,o instanceof TypeError?g.value="网络连接失败，请检查网络设置":o instanceof SyntaxError?g.value="音乐信息格式错误":g.value="加载音乐信息失败"}finally{d.value=!1}}function L(u){if(!Number.isFinite(u))return"0:00";const m=Math.floor(u/60),o=Math.floor(u%60);return`${m}:${o<10?"0":""}${o}`}function W(){c.value&&(i.value?c.value.pause():c.value.play().catch(u=>{console.warn("[MusicPlayer] Failed to play audio:",u),n.value=!0}))}function Z(){i.value=!1}function J(){i.value=!0}function K(){i.value=!1}function X(){console.error("[MusicPlayer] Audio playback error"),i.value&&(n.value=!0,g.value="音乐播放失败，可能文件不可用或格式不支持"),i.value=!1}function Y(){if(!c.value)return;const u=c.value.currentTime;Math.abs(u-b.value)>=.1&&(b.value=u)}function G(){c.value&&(y.value=c.value.duration)}function H(u){if(c.value&&y.value){const m=u/100*y.value;c.value.currentTime=m,b.value=m}}return(u,m)=>{const o=se,$=ue,ee=de;return l(),f("div",pe,[v("div",ye,[s(a).cover?(l(),f("div",_e,[P(o,{src:s(a).cover,alt:s(x).title,class:"cover-image",loading:"lazy",fit:"cover"},null,8,["src","alt"])])):M("",!0),v("div",we,[s(d)?(l(),f("div",Me,[P($,{name:"eos-icons:loading",size:"14"}),m[0]||(m[0]=v("span",null,"加载中...",-1))])):(l(),f(ne,{key:1},[v("div",ke,w(s(x).title),1),v("div",be,w(s(x).artist),1),s(R)&&s(A)?(l(),f("a",{key:0,href:s(A),target:"_blank",rel:"noopener noreferrer",class:"music-source",title:`在 ${s(I)} 中打开`},[P($,{name:"mdi:music",size:"14"}),v("span",null,w(s(I)),1)],8,Pe)):(l(),f("div",Se,[P($,{name:"mdi:music",size:"14"}),v("span",null,w(s(I)),1)]))],64))])]),s(a).url?(l(),f("audio",{key:0,ref_key:"audioElement",ref:c,src:s(a).url,crossorigin:"anonymous",onEnded:Z,onPlay:J,onPause:K,onError:X,onTimeupdate:Y,onLoadedmetadata:G},null,40,$e)):M("",!0),s(i)&&s(y)>0?(l(),re(ee,{key:1,percent:s(V),"current-time":L(s(b)),duration:L(s(y)),onChange:H},null,8,["percent","current-time","duration"])):M("",!0),v("div",Ce,[s(a).url?(l(),f("button",{key:0,class:q(["play-button",{playing:s(i)}]),title:s(i)?"暂停":"播放",onClick:W},[P($,{name:s(i)?"mdi:pause-circle":"mdi:play-circle",size:"20"},null,8,["name"]),v("span",null,w(s(i)?"暂停":"播放"),1)],10,Te)):M("",!0)]),s(n)&&s(a).url?(l(),f("div",Ee,[P($,{name:"mdi:alert-circle",size:"16"}),v("span",null,w(s(g)||"音乐加载失败"),1)])):M("",!0)])}}}),Ie=Object.assign(F(xe,[["__scopeId","data-v-bd0e98c4"]]),{__name:"MusicPlayer"}),Ne=Object.freeze(Object.defineProperty({__proto__:null,default:Ie},Symbol.toStringTag,{value:"Module"}));export{Ne as M,Ie as _,ge as u};
