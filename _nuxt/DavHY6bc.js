import{D as R,r as F,ac as W,y as p,ae as G,ad as X,d as o,f as c,O as e,e as r,h as i,n as B,U as q,W as Y,g as _,M as Z,F as b,t as d,S as w,Q as O,J as ee,_ as te}from"./CDkZ9lWR.js";import se from"./Be1EKvo-.js";import"./FEHFT8hC.js";function U(a){return a.type==="character"}function E(a){return a.type==="media"}class H{cache=new Map;maxSize;defaultTTL;constructor(s=100,n=1440*60*1e3){this.maxSize=s,this.defaultTTL=n}get(s){const n=this.cache.get(s);return n?this.isExpired(n)?(this.cache.delete(s),null):n.data:null}set(s,n,m){if(this.cache.size>=this.maxSize){const f=this.cache.keys().next().value;this.cache.delete(f)}this.cache.set(s,{data:n,timestamp:Date.now(),ttl:m??this.defaultTTL})}delete(s){this.cache.delete(s)}clear(){this.cache.clear()}has(s){const n=this.cache.get(s);return n?this.isExpired(n)?(this.cache.delete(s),!1):!0:!1}size(){return this.cache.size}cleanup(){let s=0;for(const[n,m]of this.cache.entries())this.isExpired(m)&&(this.cache.delete(n),s++);return s}isExpired(s){return Date.now()-s.timestamp>s.ttl}getTimeToLive(s){const n=this.cache.get(s);if(!n)return-1;const m=Date.now()-n.timestamp,f=n.ttl-m;return f>0?f:0}}function ae(a){if(!Array.isArray(a))return[];const s=new Map;return a.forEach(n=>{s.has(n.name)||s.set(n.name,{name:n.name||"未知声优",image:n.image||n.images?.medium||n.images?.small,link:n.link||(n.id?`https://bangumi.tv/person/${n.id}`:void 0)})}),Array.from(s.values()).slice(0,3)}function ie(a){const s=new Map;return Array.isArray(a)&&a.forEach(n=>{typeof n.value=="string"&&s.set(n.key,n.value)}),s}function ne(a){if(!Array.isArray(a))return"";const s=a.find(m=>m.key==="别名");if(!s||!Array.isArray(s.value))return"";const n=s.value.find(m=>m.k==="纯 假名"||m.k==="假名");return n?n.v:""}function re(a){const s=ie(a.infobox),n=ne(a.infobox),m=ae(a.voiceActors||[]);return{type:"character",source:"bangumi",title:a.name||"未知角色",subtitle:n||void 0,description:a.summary||void 0,image:a.images?.large||a.images?.medium||void 0,rating:void 0,tags:void 0,link:`https://bangumi.tv/character/${a.id}`,nameJp:n||void 0,nameCn:a.name_cn||void 0,gender:s.get("性别")||s.get("性 别")||void 0,birthday:s.get("生日")||void 0,bloodType:s.get("血型")||void 0,height:s.get("身高")||void 0,weight:s.get("体重")||void 0,bwh:s.get("BWH")||void 0,voiceActors:m.length>0?m:void 0,metadata:{characterId:a.id}}}function oe(a){return{type:"media",source:"bangumi",title:a.name_cn||a.name||"未命名作品",subtitle:void 0,description:a.summary||void 0,image:a.images?.large||a.images?.common||void 0,rating:a.rating?.score||void 0,tags:a.tags?.map(s=>s.name).slice(0,5)||void 0,link:`https://bangumi.tv/subject/${a.id}`,episode:a.eps||void 0,status:a.status==="Air"?"on-air":a.status==="End"?"finished":"planned",airDate:a.date||void 0,rank:a.rank||void 0,metadata:{bangumiId:a.id,ratingCount:a.rating?.total||void 0}}}const le=["data-type","data-source"],ce={key:1,class:"card-image-placeholder"},de={class:"card-content"},ue={class:"card-main-section"},me={class:"title-section"},he={class:"card-title"},ve={key:0,class:"card-subtitle"},pe={key:0,class:"card-description"},_e={class:"card-info-section"},ge={key:0,class:"tags-container"},fe={key:1,class:"attributes-section"},be={key:0,class:"attribute-item"},ye={class:"attribute-value"},ke={key:1,class:"attribute-item"},we={class:"attribute-value"},xe={key:2,class:"attribute-item"},Ce={class:"attribute-value"},De={key:3,class:"attribute-item"},Ae={class:"attribute-value"},Te={key:4,class:"attribute-item"},Me={class:"attribute-value"},$e={key:5,class:"attribute-item"},Be={class:"attribute-value"},Ee={key:2,class:"voice-actors-section"},Ie={class:"voice-actors-header"},ze={class:"voice-actors-badges"},Le={class:"card-footer"},Ne={class:"source-badge"},je={class:"source-name"},Se=["aria-label"],Ve={class:"card-main-section"},Je={class:"title-section"},Fe={class:"card-title"},We={key:0,class:"card-subtitle"},qe={key:0,class:"card-description"},Oe={class:"card-info-section"},Ue={key:0,class:"rating-section"},He={class:"rating-stars"},Ke={class:"rating-text"},Pe={key:1,class:"tags-container"},Qe={key:2,class:"media-info-combined"},Re={class:"media-info-label"},Ge={class:"media-info-value"},Xe={key:0,class:"date-item"},Ye={key:1,class:"date-item"},Ze={class:"card-footer"},et={class:"source-badge"},tt={class:"source-name"},st=["aria-label"],at={key:1,class:"info-card info-card-error"},it={class:"error-content"},nt={key:2,class:"info-card info-card-loading"},rt=R({__name:"index",props:{data:{},loading:{type:Boolean},error:{type:Boolean},type:{},id:{}},setup(a){const s=a,n=new H(100,1440*60*1e3),m=new H(100,1440*60*1e3),f=F(!1),y=F(""),T=W(null),x=W(null),I=p(()=>"type"in s&&"id"in s),M=p(()=>"data"in s&&s.data),t=p(()=>M.value?s.data:T.value),C=p(()=>t.value?U(t.value):!1),z=p(()=>t.value?E(t.value):!1),D=p(()=>t.value?t.value.source==="bangumi"?"Bangumi":t.value.source:""),L=p(()=>{if(!z.value||!t.value||!E(t.value))return[];const h=t.value,l=[];return h.episode&&l.push({label:"话数",value:h.episode}),h.rank&&l.push({label:"排名",value:`#${h.rank}`}),l}),K=p(()=>C.value?"card-layout-vertical":"card-layout-horizontal"),P=p(()=>C.value?"card-image-portrait":"card-image-landscape"),N=p(()=>M.value?s.loading??!1:f.value),j=p(()=>M.value?s.error??!1:y.value!=="");function S(){t.value?.link&&window.open(t.value.link,"_blank")}function V(h){return h?new Date(h).toLocaleDateString("zh-CN"):""}async function Q(){if(!I.value)return;const{type:h,id:l}=s;if(!l)return;const A=h==="character"?n:m,v=A.get(l);if(v){T.value=v;return}f.value=!0,y.value="",x.value?.abort(),x.value=new AbortController;try{const g=ee.bangumi?.apiBase;if(!g){y.value="Bangumi API 未配置";return}const k=await fetch(`${g}/api/${h==="character"?"character":"subject"}?id=${l}`,{signal:x.value.signal});if(!k.ok){y.value=`请求失败 (${k.status})`;return}const $=await k.json();if(!$.id){y.value=`获取${h==="character"?"人物":"媒体"}数据失败`;return}const J=h==="character"?re($):oe($);T.value=J,A.set(l,J)}catch(g){g instanceof Error&&g.name!=="AbortError"&&(console.error("[InfoCard] Fetch error:",g),y.value=g.message||"未知错误")}finally{f.value=!1}}return G(()=>I.value?s.id:null,h=>{h!=null&&Q()},{immediate:!0}),X(()=>{x.value?.abort()}),(h,l)=>{const A=Y,v=Z,g=se;return!e(N)&&!e(j)&&e(t)?(r(),o("div",{key:0,class:"info-card","data-type":e(t).type,"data-source":e(t).source},[i("div",{class:B(e(K))},[i("div",{class:B(["card-image-wrapper",e(P)])},[e(t).image?(r(),q(A,{key:0,src:e(t).image,alt:e(t).title,class:"card-image",loading:"lazy"},null,8,["src","alt"])):(r(),o("div",ce,[_(v,{name:e(C)?"ph:user-circle-bold":"ph:image-square-bold",class:"placeholder-icon"},null,8,["name"])]))],2),i("div",de,[e(C)&&e(U)(e(t))?(r(),o(b,{key:0},[i("div",ue,[i("div",me,[i("h3",he,d(e(t).title),1),e(t).subtitle?(r(),o("p",ve,d(e(t).subtitle),1)):c("",!0)]),e(t).description?(r(),o("p",pe,d(e(t).description),1)):c("",!0)]),i("div",_e,[e(t).tags?.length?(r(),o("div",ge,[(r(!0),o(b,null,w(e(t).tags,u=>(r(),o("span",{key:u,class:"tag"},d(u),1))),128))])):c("",!0),e(t).gender||e(t).birthday||e(t).height||e(t).bloodType||e(t).weight||e(t).bwh?(r(),o("div",fe,[e(t).gender?(r(),o("div",be,[l[0]||(l[0]=i("span",{class:"attribute-label"},"性别",-1)),i("span",ye,d(e(t).gender),1)])):c("",!0),e(t).birthday?(r(),o("div",ke,[l[1]||(l[1]=i("span",{class:"attribute-label"},"生日",-1)),i("span",we,d(e(t).birthday),1)])):c("",!0),e(t).height?(r(),o("div",xe,[l[2]||(l[2]=i("span",{class:"attribute-label"},"身高",-1)),i("span",Ce,d(e(t).height),1)])):c("",!0),e(t).bloodType?(r(),o("div",De,[l[3]||(l[3]=i("span",{class:"attribute-label"},"血型",-1)),i("span",Ae,d(e(t).bloodType),1)])):c("",!0),e(t).weight?(r(),o("div",Te,[l[4]||(l[4]=i("span",{class:"attribute-label"},"体重",-1)),i("span",Me,d(e(t).weight),1)])):c("",!0),e(t).bwh?(r(),o("div",$e,[l[5]||(l[5]=i("span",{class:"attribute-label"},"三围",-1)),i("span",Be,d(e(t).bwh),1)])):c("",!0)])):c("",!0),e(t).voiceActors?.length?(r(),o("div",Ee,[i("div",Ie,[_(v,{name:"ri:mic-line",class:"section-icon"}),l[6]||(l[6]=i("span",null,"声优",-1))]),i("div",ze,[(r(!0),o(b,null,w(e(t).voiceActors,(u,k)=>(r(),q(g,{key:k,img:u.image,text:u.name,link:u.link,round:""},null,8,["img","text","link"]))),128))])])):c("",!0),i("div",Le,[i("div",Ne,[_(v,{name:"ri:bilibili-line",class:"source-icon"}),i("span",je,d(e(D)),1)]),e(t).link?(r(),o("button",{key:0,class:"view-button","aria-label":`查看 ${e(D)} 上 ${e(t).title} 的详情`,onClick:S},[l[7]||(l[7]=i("span",null,"查看详情",-1)),_(v,{name:"ri:arrow-right-line",class:"button-icon"})],8,Se)):c("",!0)])])],64)):e(z)&&e(E)(e(t))?(r(),o(b,{key:1},[i("div",Ve,[i("div",Je,[i("h3",Fe,d(e(t).title),1),e(t).subtitle?(r(),o("p",We,d(e(t).subtitle),1)):c("",!0)]),e(t).description?(r(),o("p",qe,d(e(t).description),1)):c("",!0)]),i("div",Oe,[e(t).rating?(r(),o("div",Ue,[i("div",He,[(r(),o(b,null,w(5,u=>_(v,{key:u,class:B(["star-icon",u<=Math.round(e(t).rating/2)?"star-filled":"star-empty"]),name:u<=Math.round(e(t).rating/2)?"ri:star-fill":"ri:star-line"},null,8,["class","name"])),64))]),i("span",Ke,d(e(t).rating),1)])):c("",!0),e(t).tags?.length?(r(),o("div",Pe,[(r(!0),o(b,null,w(e(t).tags,u=>(r(),o("span",{key:u,class:"tag"},d(u),1))),128))])):c("",!0),e(L).length||e(t).airDate||e(t).endDate?(r(),o("div",Qe,[(r(!0),o(b,null,w(e(L),u=>(r(),o("div",{key:u.label,class:"media-info-item"},[i("span",Re,d(u.label)+":",1),i("span",Ge,d(u.value),1)]))),128)),e(t).airDate?(r(),o("span",Xe,[_(v,{name:"clarity:date-line",class:"date-icon"}),O(" "+d(V(e(t).airDate)),1)])):c("",!0),e(t).endDate?(r(),o("span",Ye,[_(v,{name:"clarity:date-line",class:"date-icon"}),O(" "+d(V(e(t).endDate)),1)])):c("",!0)])):c("",!0),i("div",Ze,[i("div",et,[_(v,{name:"ri:bilibili-line",class:"source-icon"}),i("span",tt,d(e(D)),1)]),e(t).link?(r(),o("button",{key:0,class:"view-button","aria-label":`查看 ${e(D)} 上 ${e(t).title} 的详情`,onClick:S},[l[8]||(l[8]=i("span",null,"查看详情",-1)),_(v,{name:"ri:arrow-right-line",class:"button-icon"})],8,st)):c("",!0)])])],64)):c("",!0)])],2)],8,le)):e(j)?(r(),o("div",at,[i("div",it,[_(v,{name:"ph:warning-circle-bold",class:"error-icon"}),l[9]||(l[9]=i("p",null,"加载失败",-1)),l[10]||(l[10]=i("small",null,"请检查 ID 是否正确或稍后重试",-1))])])):e(N)?(r(),o("div",nt,[...l[11]||(l[11]=[i("div",{class:"loading-skeleton"},null,-1)])])):c("",!0)}}}),dt=Object.assign(te(rt,[["__scopeId","data-v-e1937f88"]]),{__name:"InfoCard"});export{dt as default};
