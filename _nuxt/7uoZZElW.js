import{G as X,r as T,z as y,ah as F,bm as ie,o as Z,c as se,d as l,e as s,n as N,Q as e,h as i,g as b,W as D,Y as ee,O as te,t as u,w as ne,f as c,a6 as oe,M as re,_ as ae,aK as le,af as R,ag as ce,F as P,V as U,S as G,L as ue}from"./Bs0C97mX.js";import de from"./PCC42dpY.js";import"./C6YQ21Fm.js";function H(n){return n.type==="character"}function q(n){return n.type==="media"}class Q{cache=new Map;maxSize;defaultTTL;constructor(a=100,o=1440*60*1e3){this.maxSize=a,this.defaultTTL=o}get(a){const o=this.cache.get(a);return o?this.isExpired(o)?(this.cache.delete(a),null):o.data:null}set(a,o,_){if(this.cache.size>=this.maxSize){const I=this.cache.keys().next().value;this.cache.delete(I)}this.cache.set(a,{data:o,timestamp:Date.now(),ttl:_??this.defaultTTL})}delete(a){this.cache.delete(a)}clear(){this.cache.clear()}has(a){const o=this.cache.get(a);return o?this.isExpired(o)?(this.cache.delete(a),!1):!0:!1}size(){return this.cache.size}cleanup(){let a=0;for(const[o,_]of this.cache.entries())this.isExpired(_)&&(this.cache.delete(o),a++);return a}isExpired(a){return Date.now()-a.timestamp>a.ttl}getTimeToLive(a){const o=this.cache.get(a);if(!o)return-1;const _=Date.now()-o.timestamp,I=o.ttl-_;return I>0?I:0}}function _e(n){if(!Array.isArray(n))return[];const a=new Map;return n.forEach(o=>{a.has(o.name)||a.set(o.name,{name:o.name||"未知声优",image:o.image||o.images?.medium||o.images?.small,link:o.link||(o.id?`https://bangumi.tv/person/${o.id}`:void 0)})}),Array.from(a.values()).slice(0,3)}function fe(n){const a=new Map;return Array.isArray(n)&&n.forEach(o=>{typeof o.value=="string"&&a.set(o.key,o.value)}),a}function me(n){if(!Array.isArray(n))return"";const a=n.find(_=>_.key==="别名");if(!a||!Array.isArray(a.value))return"";const o=a.value.find(_=>_.k==="纯 假名"||_.k==="假名");return o?o.v:""}function ve(n){const a=fe(n.infobox),o=me(n.infobox),_=_e(n.voiceActors||[]);return{type:"character",source:"bangumi",title:n.name||"未知角色",subtitle:o||void 0,description:n.summary||void 0,image:n.images?.large||n.images?.medium||void 0,rating:void 0,tags:void 0,link:`https://bangumi.tv/character/${n.id}`,nameJp:o||void 0,nameCn:n.name_cn||void 0,gender:a.get("性别")||a.get("性 别")||void 0,birthday:a.get("生日")||void 0,bloodType:a.get("血型")||void 0,height:a.get("身高")||void 0,weight:a.get("体重")||void 0,bwh:a.get("BWH")||void 0,voiceActors:_.length>0?_:void 0,metadata:{characterId:n.id}}}function pe(n){return{type:"media",source:"bangumi",title:n.name_cn||n.name||"未命名作品",subtitle:void 0,description:n.summary||void 0,image:n.images?.large||n.images?.common||void 0,rating:n.rating?.score||void 0,tags:n.tags?.map(a=>a.name).slice(0,5)||void 0,link:`https://bangumi.tv/subject/${n.id}`,episode:n.eps||void 0,status:n.status==="Air"?"on-air":n.status==="End"?"finished":"planned",airDate:n.date||void 0,rank:n.rank||void 0,metadata:{bangumiId:n.id,ratingCount:n.rating?.total||void 0}}}const he={key:1,class:"cover-placeholder"},ge={class:"player-info"},ye={key:0,class:"player-loading"},be={key:1,class:"player-text"},ke={class:"player-title"},we={class:"player-artist"},xe=["disabled","title"],Ce=["src"],Me=X({__name:"MiniMusicPlayer",props:{musicUrl:{}},setup(n){const a=n,{detectMusicSource:o,extractMusicId:_,fetchNeteaseMetadata:I}=re(),p=T({}),x=T(!0),m=T(!1),w=T(!1),h=T(null);async function t(){if(a.musicUrl){x.value=!0,w.value=!1;try{const f=o(a.musicUrl),k=_(a.musicUrl,f);if(f==="netease"&&k){const d=await I(k);p.value={id:k,source:f,title:d.title||"未知曲目",artist:d.artist||"未知艺术家",cover:d.cover,url:d.url}}else p.value={id:"",source:"url",title:"外部音乐",artist:"未知艺术家",url:a.musicUrl}}catch(f){console.error("[MiniMusicPlayer] Failed to fetch music data:",f),w.value=!0,p.value={id:"",source:"url",title:"加载失败",artist:"请检查链接"}}finally{x.value=!1}}}const{currentPlayingId:C,setPlaying:A,stop:E}=ie(),z=`mini-music-player-${Date.now().toString(36)}-${Math.random().toString(36).slice(2)}`,M=y(()=>{const f=p.value?.id??p.value?.url??a.musicUrl;return f&&String(f).length>0?`mini-music-player-${encodeURIComponent(String(f))}`:z});F(C,f=>{h.value&&f!==M.value&&m.value&&h.value.pause()});function O(){!h.value||!p.value.url||(m.value?h.value.pause():h.value.play().catch(f=>{console.warn("[MiniMusicPlayer] Play failed:",f),w.value=!0}))}function J(){m.value=!0,A(M.value)}function S(){m.value=!1,C.value===M.value&&E()}function j(){m.value=!1,C.value===M.value&&E()}function V(){w.value=!0,m.value=!1,C.value===M.value&&E()}return Z(()=>{t()}),se(()=>{C.value===M.value&&E(),h.value&&(h.value.pause(),h.value.src="")}),F(()=>a.musicUrl,()=>{h.value&&h.value.pause(),m.value=!1,t()}),F(M,(f,k)=>{f&&m.value&&A(f)}),(f,k)=>{const d=ee,r=te,B=oe;return s(),l("div",{class:N(["mini-music-player",{"is-loading":e(x),"has-error":e(w)}])},[i("div",{class:N(["player-cover",{"is-playing":e(m)}])},[e(p).cover?(s(),D(d,{key:0,src:e(p).cover,alt:e(p).title||"封面",class:"cover-image",loading:"lazy"},null,8,["src","alt"])):(s(),l("div",he,[b(r,{name:"mdi:music-note"})]))],2),i("div",ge,[e(x)?(s(),l("span",ye,[b(r,{name:"eos-icons:loading"}),k[0]||(k[0]=i("span",null,"加载中...",-1))])):(s(),l("span",be,[i("span",ke,u(e(p).title||"未知曲目"),1),k[1]||(k[1]=i("span",{class:"player-separator"},"-",-1)),i("span",we,u(e(p).artist||"未知艺术家"),1)]))]),b(B,null,{default:ne(()=>[i("button",{class:"player-button",disabled:e(x)||e(w)||!e(p).url,title:e(m)?"暂停":"播放",onClick:O},[e(x)?(s(),D(r,{key:0,name:"eos-icons:loading"})):e(w)?(s(),D(r,{key:1,name:"mdi:alert-circle"})):e(m)?(s(),D(r,{key:2,name:"mdi:pause"})):(s(),D(r,{key:3,name:"mdi:play"}))],8,xe),e(p).url?(s(),l("audio",{key:0,ref_key:"audioElement",ref:h,src:e(p).url,crossorigin:"anonymous",onPlay:J,onPause:S,onEnded:j,onError:V},null,40,Ce)):c("",!0)]),_:1})],2)}}}),Y=Object.assign(ae(Me,[["__scopeId","data-v-f135ecc6"]]),{__name:"MiniMusicPlayer"}),$e=["data-type","data-source"],De={key:1,class:"info-card__image-placeholder"},Ie={class:"info-card__content"},Ae={class:"info-card__main-section"},Ee={class:"info-card__title-section"},Pe={class:"info-card__title"},Te={key:0,class:"info-card__subtitle"},ze={key:0,class:"info-card__description"},Be={class:"info-card__info-section"},Le={key:0,class:"info-card__tags-container"},Ue={key:1,class:"info-card__attributes-section"},Ne={key:0,class:"info-card__attribute-item"},Se={class:"info-card__attribute-value"},je={key:1,class:"info-card__attribute-item"},Ve={class:"info-card__attribute-value"},Fe={key:2,class:"info-card__attribute-item"},Oe={class:"info-card__attribute-value"},Je={key:3,class:"info-card__attribute-item"},We={class:"info-card__attribute-value"},qe={key:4,class:"info-card__attribute-item"},Ke={class:"info-card__attribute-value"},Re={key:5,class:"info-card__attribute-item"},Ge={class:"info-card__attribute-value"},He={key:2,class:"info-card__voice-actors-section"},Qe={class:"info-card__voice-actors-header"},Ye={class:"info-card__voice-actors-badges"},Xe={class:"info-card__footer"},Ze={class:"info-card__source-badge"},et={class:"info-card__source-name"},tt=["aria-label"],at={class:"info-card__main-section"},it={class:"info-card__title-section"},st={class:"info-card__title"},nt={key:0,class:"info-card__subtitle"},ot={key:0,class:"info-card__description"},rt={class:"info-card__info-section"},lt={key:0,class:"info-card__rating-section"},ct={class:"info-card__rating-stars"},ut={class:"info-card__rating-text"},dt={key:1,class:"info-card__tags-container"},_t={key:2,class:"info-card__media-info-combined"},ft={class:"info-card__media-info-label"},mt={class:"info-card__media-info-value"},vt={key:0,class:"info-card__date-item"},pt={key:1,class:"info-card__date-item"},ht={class:"info-card__footer"},gt={class:"info-card__source-badge"},yt={class:"info-card__source-name"},bt=["aria-label"],kt={key:1,class:"info-card info-card--error"},wt={class:"info-card__error-content"},xt={key:2,class:"info-card info-card--loading"},Ct=X({__name:"index",props:{data:{},loading:{type:Boolean},error:{type:Boolean},type:{},id:{},music:{}},setup(n){const a=n,o=y(()=>"type"in a&&"id"in a),_=y(()=>"data"in a&&a.data);Z(()=>{le(()=>{!o.value&&!_.value&&console.warn("[InfoCard] Invalid props: must provide either (type, id) for load mode or data for data mode")})});const I=new Q(100,1440*60*1e3),p=new Q(100,1440*60*1e3),x=T(!1),m=T(""),w=R(null),h=R(null),t=y(()=>_.value?a.data:w.value),C=y(()=>o.value?a.music:t.value?.music),A=y(()=>t.value?H(t.value):!1),E=y(()=>t.value?q(t.value):!1),z=y(()=>t.value?t.value.source==="bangumi"?"Bangumi":t.value.source:""),M=y(()=>{if(!E.value||!t.value||!q(t.value))return[];const d=t.value,r=[];return d.episode&&r.push({label:"话数",value:d.episode}),d.rank&&r.push({label:"排名",value:`#${d.rank}`}),r}),O=y(()=>A.value?"info-card__layout-vertical":"info-card__layout-horizontal"),J=y(()=>A.value?"info-card__image-portrait":"info-card__image-landscape"),S=y(()=>_.value?a.loading??!1:x.value),j=y(()=>_.value?a.error??!1:m.value!=="");function V(){t.value?.link&&window.open(t.value.link,"_blank")}function f(d){return d?new Date(d).toLocaleDateString("zh-CN"):""}async function k(){if(!o.value)return;const{type:d,id:r}=a;if(!r)return;const B=d==="character"?I:p,g=B.get(r);if(g){w.value=g;return}x.value=!0,m.value="",h.value?.abort(),h.value=new AbortController;try{const $=ue.bangumi?.apiBase;if(!$){m.value="Bangumi API 未配置";return}const L=await fetch(`${$}/api/${d==="character"?"character":"subject"}?id=${r}`,{signal:h.value.signal});if(!L.ok){m.value=`请求失败 (${L.status})`;return}const W=await L.json();if(!W.id){m.value=`获取${d==="character"?"人物":"媒体"}数据失败`;return}const K=d==="character"?ve(W):pe(W);w.value=K,B.set(r,K)}catch($){$ instanceof Error&&$.name!=="AbortError"&&(console.error("[InfoCard] Fetch error:",$),m.value=$.message||"未知错误")}finally{x.value=!1}}return F(()=>o.value?a.id:null,d=>{d!=null&&k()},{immediate:!0}),ce(()=>{h.value?.abort()}),(d,r)=>{const B=ee,g=te,$=de;return!e(S)&&!e(j)&&e(t)?(s(),l("div",{key:0,class:"info-card","data-type":e(t).type,"data-source":e(t).source},[i("div",{class:N(e(O))},[i("div",{class:N(["info-card__image-wrapper",e(J)])},[e(t).image?(s(),D(B,{key:0,src:e(t).image,alt:e(t).title,class:"info-card__image",loading:"lazy"},null,8,["src","alt"])):(s(),l("div",De,[b(g,{name:e(A)?"ph:user-circle-bold":"ph:image-square-bold",class:"info-card__placeholder-icon"},null,8,["name"])]))],2),i("div",Ie,[e(A)&&e(H)(e(t))?(s(),l(P,{key:0},[i("div",Ae,[i("div",Ee,[i("h3",Pe,u(e(t).title),1),e(t).subtitle?(s(),l("p",Te,u(e(t).subtitle),1)):c("",!0)]),e(t).description?(s(),l("p",ze,u(e(t).description),1)):c("",!0),e(C)?(s(),D(Y,{key:1,"music-url":e(C)},null,8,["music-url"])):c("",!0)]),i("div",Be,[e(t).tags?.length?(s(),l("div",Le,[(s(!0),l(P,null,U(e(t).tags,v=>(s(),l("span",{key:v,class:"info-card__tag"},u(v),1))),128))])):c("",!0),e(t).gender||e(t).birthday||e(t).height||e(t).bloodType||e(t).weight||e(t).bwh?(s(),l("div",Ue,[e(t).gender?(s(),l("div",Ne,[r[0]||(r[0]=i("span",{class:"info-card__attribute-label"},"性别",-1)),i("span",Se,u(e(t).gender),1)])):c("",!0),e(t).birthday?(s(),l("div",je,[r[1]||(r[1]=i("span",{class:"info-card__attribute-label"},"生日",-1)),i("span",Ve,u(e(t).birthday),1)])):c("",!0),e(t).height?(s(),l("div",Fe,[r[2]||(r[2]=i("span",{class:"info-card__attribute-label"},"身高",-1)),i("span",Oe,u(e(t).height),1)])):c("",!0),e(t).bloodType?(s(),l("div",Je,[r[3]||(r[3]=i("span",{class:"info-card__attribute-label"},"血型",-1)),i("span",We,u(e(t).bloodType),1)])):c("",!0),e(t).weight?(s(),l("div",qe,[r[4]||(r[4]=i("span",{class:"info-card__attribute-label"},"体重",-1)),i("span",Ke,u(e(t).weight),1)])):c("",!0),e(t).bwh?(s(),l("div",Re,[r[5]||(r[5]=i("span",{class:"info-card__attribute-label"},"三围",-1)),i("span",Ge,u(e(t).bwh),1)])):c("",!0)])):c("",!0),e(t).voiceActors?.length?(s(),l("div",He,[i("div",Qe,[b(g,{name:"ri:mic-line",class:"info-card__section-icon"}),r[6]||(r[6]=i("span",null,"声优",-1))]),i("div",Ye,[(s(!0),l(P,null,U(e(t).voiceActors,(v,L)=>(s(),D($,{key:L,img:v.image,text:v.name,link:v.link,round:""},null,8,["img","text","link"]))),128))])])):c("",!0),i("div",Xe,[i("div",Ze,[b(g,{name:"ri:bilibili-line",class:"info-card__source-icon"}),i("span",et,u(e(z)),1)]),e(t).link?(s(),l("button",{key:0,class:"info-card__view-button","aria-label":`查看 ${e(z)} 上 ${e(t).title} 的详情`,onClick:V},[r[7]||(r[7]=i("span",null,"查看详情",-1)),b(g,{name:"ri:arrow-right-line",class:"info-card__button-icon"})],8,tt)):c("",!0)])])],64)):e(E)&&e(q)(e(t))?(s(),l(P,{key:1},[i("div",at,[i("div",it,[i("h3",st,u(e(t).title),1),e(t).subtitle?(s(),l("p",nt,u(e(t).subtitle),1)):c("",!0)]),e(t).description?(s(),l("p",ot,u(e(t).description),1)):c("",!0),e(C)?(s(),D(Y,{key:1,"music-url":e(C)},null,8,["music-url"])):c("",!0)]),i("div",rt,[e(t).rating?(s(),l("div",lt,[i("div",ct,[(s(),l(P,null,U(5,v=>b(g,{key:v,class:N(["info-card__star-icon",v<=Math.round(e(t).rating/2)?"star-filled":"star-empty"]),name:v<=Math.round(e(t).rating/2)?"ri:star-fill":"ri:star-line"},null,8,["class","name"])),64))]),i("span",ut,u(e(t).rating),1)])):c("",!0),e(t).tags?.length?(s(),l("div",dt,[(s(!0),l(P,null,U(e(t).tags,v=>(s(),l("span",{key:v,class:"info-card__tag"},u(v),1))),128))])):c("",!0),e(M).length||e(t).airDate||e(t).endDate?(s(),l("div",_t,[(s(!0),l(P,null,U(e(M),v=>(s(),l("div",{key:v.label,class:"info-card__media-info-item"},[i("span",ft,u(v.label)+":",1),i("span",mt,u(v.value),1)]))),128)),e(t).airDate?(s(),l("span",vt,[b(g,{name:"clarity:date-line",class:"info-card__date-icon"}),G(" "+u(f(e(t).airDate)),1)])):c("",!0),e(t).endDate?(s(),l("span",pt,[b(g,{name:"clarity:date-line",class:"info-card__date-icon"}),G(" "+u(f(e(t).endDate)),1)])):c("",!0)])):c("",!0),i("div",ht,[i("div",gt,[b(g,{name:"ri:bilibili-line",class:"info-card__source-icon"}),i("span",yt,u(e(z)),1)]),e(t).link?(s(),l("button",{key:0,class:"info-card__view-button","aria-label":`查看 ${e(z)} 上 ${e(t).title} 的详情`,onClick:V},[r[8]||(r[8]=i("span",null,"查看详情",-1)),b(g,{name:"ri:arrow-right-line",class:"info-card__button-icon"})],8,bt)):c("",!0)])])],64)):c("",!0)])],2)],8,$e)):e(j)?(s(),l("div",kt,[i("div",wt,[b(g,{name:"ph:warning-circle-bold",class:"info-card__error-icon"}),r[9]||(r[9]=i("p",null,"加载失败",-1)),r[10]||(r[10]=i("small",null,"请检查 ID 是否正确或稍后重试",-1))])])):e(S)?(s(),l("div",xt,[...r[11]||(r[11]=[i("div",{class:"info-card__loading-skeleton"},null,-1)])])):c("",!0)}}}),It=Object.assign(ae(Ct,[["__scopeId","data-v-29846666"]]),{__name:"InfoCard"});export{It as default};
