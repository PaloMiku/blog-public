import{g as V,J as G,Q as m,aO as u,aV as Q,b6 as f,aR as p,a_ as ye,aS as v,b9 as M,b5 as j,r as C,o as ge,N as K,q as he,aE as ve,x as b,K as a,ba as _e,aU as pe,aN as R,bb as Me,b7 as Pe}from"./uFNG57UN.js";import{_ as q,t as Le,g as ke,l as be,L as xe,M as Te,N as Ee}from"./DtSPr9JS.js";import"./D-deoX8n.js";function Ce(){const s=V({isLoading:!1,currentIndex:0,lines:[]}),y=new Map;function e(g,w){if(s.lines.length===0)return;let l=0,h=s.lines.length-1,d=0;for(;l<=h;){const c=Math.floor((l+h)/2),_=s.lines[c];_&&_.time<=g?(d=c,l=c+1):h=c-1}d!==s.currentIndex&&(s.currentIndex=d,y.clear())}function k(g,w){if(s.lines.length===0)return 0;const l=s.lines[s.currentIndex],h=s.lines[s.currentIndex+1];if(!l)return 0;let d=0;if(h){const c=h.time-l.time;if(c<=0)d=100;else{const _=g-l.time;d=_>=c?100:Math.max(0,_/c*100)}}else{const c=g-l.time;d=Math.min(100,c/3*100)}return d}function x(){s.currentIndex=0,s.isLoading=!1,s.lines=[],y.clear()}function T(g){s.lines=g,s.currentIndex=0,y.clear()}function P(g){s.isLoading=g}return{lyricsState:s,updateCurrentLyric:e,calculateLyricProgress:k,resetLyrics:x,setLyrics:T,setLoading:P}}const we={class:"music-actions"},Ie=["title"],Be={key:0,class:"music-error"},Se=G({__name:"PlaybackControls",props:{isPlaying:{type:Boolean},isLoading:{type:Boolean},hasError:{type:Boolean},errorMessage:{},musicUrl:{}},emits:["togglePlay"],setup(s,{emit:y}){const e=y;function k(){e("togglePlay")}return(x,T)=>{const P=q;return u(),m(Q,null,[f("div",we,[s.musicUrl?(u(),m("button",{key:0,class:ye(["play-button",{playing:s.isPlaying}]),title:s.isPlaying?"暂停":"播放",onClick:k},[v(P,{name:s.isPlaying?"mdi:pause-circle":"mdi:play-circle",size:"20"},null,8,["name"]),f("span",null,M(s.isPlaying?"暂停":"播放"),1)],10,Ie)):p("",!0)]),s.hasError&&s.musicUrl?(u(),m("div",Be,[v(P,{name:"mdi:alert-circle",size:"16"}),f("span",null,M(s.errorMessage||"音乐加载失败"),1)])):p("",!0)],64)}}}),Ne=Object.assign(j(Se,[["__scopeId","data-v-5ad36d7e"]]),{__name:"PlaybackControls"}),$e={class:"music-player"},Ae={class:"music-info"},Ue={key:0,class:"music-cover"},ze={class:"music-details"},De={key:0,class:"music-loading"},Oe={class:"music-title"},Fe={class:"music-artist"},Ke=["href","title"],Re={key:1,class:"music-source-text"},Ve=["src"],Ge=["onKeydown"],Qe=G({__name:"MusicPlayer",props:{music:{}},setup(s){const y=s,e=V({isLoading:!1,hasError:!1,errorMessage:"",isPlaying:!1,currentTime:0,duration:0,hasPlayedBefore:!1}),{fetchNeteaseMetadata:k,fetchNeteaseLyrics:x,detectMusicSource:T,extractMusicId:P,getMusicLink:g,parseLyrics:w}=ke(),{lyricsState:l,updateCurrentLyric:h,resetLyrics:d,setLyrics:c,setLoading:_}=Ce(),A=Le(),r=C(y.music),i=C(),I=C(null),L=C("original"),J={netease:"网易云音乐",tencent:"QQ音乐",kuwo:"酷我音乐",xiami:"虾米音乐",kugou:"酷狗音乐",youtube:"YouTube",url:"外部链接"};ge(()=>y.music.id,n=>{n&&(r.value=y.music,H(),U())}),K(()=>{r.value=y.music,U(),re()}),K(()=>{he(()=>{const n=I.value;n?.getMode&&(L.value=n.getMode())})}),ve(()=>{W()});const B=b(()=>({title:r.value.title||"未知曲目",artist:r.value.artist||"未知艺术家",platform:r.value.platform||r.value.source||"音乐"})),S=b(()=>J[r.value.source]||r.value.source),N=b(()=>g(r.value.source,r.value.id)),Y=b(()=>!!N.value),Z=b(()=>e.duration?e.currentTime/e.duration*100:0);function H(){e.isPlaying&&i.value&&i.value.pause(),e.isPlaying=!1,e.currentTime=0,e.duration=0,e.hasError=!1,e.errorMessage="",e.hasPlayedBefore=!1,d()}function W(){ie(),i.value&&(i.value.pause(),i.value.src=""),d()}async function U(){let n=r.value.source,t=r.value.id;if(r.value.url&&!t&&(n=T(r.value.url),t=P(r.value.url,n)||"",r.value={...r.value,source:n,id:t}),n!=="netease"||!t){e.isLoading=!1;return}try{e.isLoading=!0,e.hasError=!1,e.errorMessage="";const o=await k(t);(o.title||o.artist||o.cover||o.url)&&(r.value={...r.value,title:o.title||r.value.title,artist:o.artist||r.value.artist,cover:o.cover||r.value.cover,url:o.url||r.value.url}),await ee(t)}catch(o){X(o,"fetchMusicMetadata")}finally{e.isLoading=!1}}function X(n,t){console.error(`[MusicPlayer] ${t}:`,n),e.hasError=!0,n instanceof TypeError?e.errorMessage="网络连接失败，请检查网络设置":n instanceof SyntaxError?e.errorMessage="音乐信息格式错误":n instanceof Error?e.errorMessage=n.message||"操作失败":e.errorMessage="加载音乐信息失败"}async function ee(n){try{_(!0);const t=await x(n);if(t){const o=w(t);c(o)}}catch(t){console.warn("[MusicPlayer] Failed to fetch lyrics:",t),c([])}finally{_(!1)}}function z(n){if(!Number.isFinite(n))return"0:00";const t=Math.floor(n/60),o=Math.floor(n%60);return`${t}:${o<10?"0":""}${o}`}function D(){i.value&&(e.isPlaying?i.value.pause():i.value.play().catch(n=>{console.warn("[MusicPlayer] Failed to play audio:",n),e.hasError=!0,e.errorMessage="音乐播放失败，可能文件不可用或格式不支持"}))}function ne(){e.isPlaying=!1}function ae(){e.isPlaying=!0,e.hasPlayedBefore=!0}function te(){e.isPlaying=!1}function se(){console.error("[MusicPlayer] Audio playback error"),e.isPlaying&&(e.hasError=!0,e.errorMessage="音乐播放失败，可能文件不可用或格式不支持"),e.isPlaying=!1}function re(){document.addEventListener("play",O,!0)}function ie(){document.removeEventListener("play",O,!0)}function O(n){const t=n.target;i.value&&t!==i.value&&t.tagName==="AUDIO"&&e.isPlaying&&D()}const oe=Ee(n=>{h(n,e.currentTime)},50);function le(){if(!i.value)return;const n=i.value.currentTime;Math.abs(n-e.currentTime)>=.1&&(e.currentTime=n),oe(n)}function ce(){i.value&&(e.duration=i.value.duration)}function ue(n){i.value&&(i.value.currentTime=n,e.currentTime=n,h(n,e.currentTime),i.value.play().catch(t=>{console.warn("[MusicPlayer] Play after seek failed:",t)}))}function F(){const n=I.value;n?.cycleLyricDisplayMode&&n.cycleLyricDisplayMode()}function de(n){if(i.value&&e.duration){const t=n/100*e.duration;i.value.currentTime=t,e.currentTime=t,h(t,e.currentTime)}}return(n,t)=>{const o=_e,E=q,me=xe,fe=be;return u(),m("div",$e,[f("div",Ae,[a(r).cover?(u(),m("div",Ue,[v(o,{src:a(r).cover,alt:a(B).title,class:"cover-image",loading:"lazy",fit:"cover"},null,8,["src","alt"])])):p("",!0),f("div",ze,[a(e).isLoading?(u(),m("div",De,[v(E,{name:"eos-icons:loading",size:"14"}),t[1]||(t[1]=f("span",null,"加载中...",-1))])):(u(),m(Q,{key:1},[f("div",Oe,M(a(B).title),1),f("div",Fe,M(a(B).artist),1),a(Y)&&a(N)?(u(),m("a",{key:0,href:a(N),target:"_blank",rel:"noopener noreferrer",class:"music-source",title:`在 ${a(S)} 中打开`},[v(E,{name:"mdi:music",size:"14"}),f("span",null,M(a(S)),1)],8,Ke)):(u(),m("div",Re,[v(E,{name:"mdi:music",size:"14"}),f("span",null,M(a(S)),1)]))],64))])]),v(fe,null,{default:pe(()=>[a(r).url?(u(),m("audio",{key:0,ref_key:"audioElement",ref:i,src:a(r).url,crossorigin:"anonymous",onEnded:ne,onPlay:ae,onPause:te,onError:se,onTimeupdate:le,onLoadedmetadata:ce},null,40,Ve)):p("",!0),a(e).isPlaying&&a(e).duration>0?(u(),R(me,{key:1,percent:a(Z),"current-time":z(a(e).currentTime),duration:z(a(e).duration),onChange:de},null,8,["percent","current-time","duration"])):p("",!0),v(Ne,{"is-playing":a(e).isPlaying,"is-loading":a(e).isLoading,"has-error":a(e).hasError,"error-message":a(e).errorMessage,"music-url":a(r).url,onTogglePlay:D},null,8,["is-playing","is-loading","has-error","error-message","music-url"]),a(l).lines.length>0&&a(A).showMusicLyrics&&a(e).hasPlayedBefore?(u(),R(Te,{key:2,ref_key:"lyricsRef",ref:I,lines:a(l).lines,"current-index":a(l).currentIndex,onSeek:ue,onModeChanged:t[0]||(t[0]=$=>L.value=$)},null,8,["lines","current-index"])):p("",!0),a(l).lines.length>0&&a(l).lines.some($=>$.translation)&&a(A).showMusicLyrics&&a(e).hasPlayedBefore?(u(),m("button",{key:3,class:"lyric-mode-btn",title:"切换歌词显示模式",onClick:F,onKeydown:Me(Pe(F,["prevent"]),["enter"])},[v(E,{name:a(L)==="original"?"mdi:text":a(L)==="translation"?"mdi:translate":"mdi:list-box-outline"},null,8,["name"]),f("span",null,M(a(L)==="original"?"原文":a(L)==="translation"?"翻译":"双语"),1)],40,Ge)):p("",!0)]),_:1})])}}}),Ye=Object.assign(j(Qe,[["__scopeId","data-v-7106efb0"]]),{__name:"MusicPlayer"});export{Ye as default};
