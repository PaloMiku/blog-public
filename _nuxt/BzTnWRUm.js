import{z as K,r as v,G as I,o as Q,bf as X,ad as Y,d as s,e as n,f as d,L as t,h as l,N as F,t as f,g as S,J as Z,O as ee,F as L,P as O,a2 as te,n as ae,aC as N,_ as se}from"./CyAqJ3nm.js";import{s as ne}from"./DtpBtLwR.js";const oe={class:"galgame-wrapper"},re={key:0,class:"galgame-error"},le={key:1,class:"md-galgame ai-galgame"},ie={class:"ai-galgame-header"},ce={class:"ai-galgame-title"},ue={class:"ai-galgame-label"},de={class:"ai-galgame-toolbar"},ve=["title"],ge={key:0,class:"galgame-speaker"},me={class:"galgame-text"},he={key:0,class:"typewriter-caret"},fe={key:2,class:"galgame-hint"},pe={key:0,class:"galgame-choices"},ye=["onClick"],_e={key:1,class:"galgame-ending"},ke={key:2,class:"galgame-history-panel"},be={class:"history-header"},we={class:"history-title"},xe={class:"history-list"},Te={key:0,class:"history-empty"},Ce={key:1,class:"history-timeline"},Ie=["onClick"],Se={class:"timeline-node"},$e={key:0,class:"node-connector"},Ee={class:"history-content"},He={class:"history-main"},Ge={key:0,class:"history-choice"},Me={key:1,class:"history-paragraph"},Pe={class:"history-meta"},Ve={key:3,class:"galgame-empty"},Ne=K({__name:"Galgame",props:{data:{},showHistory:{type:Boolean,default:!0},showRestart:{type:Boolean,default:!0}},setup(q){const y=q,g=v(null),p=v(""),x=v(""),u=v([]),w=v({}),m=v(!1),h=v(!1),_=v(0),E=v(""),H=v(!1);let T=null;const i=I(()=>g.value?g.value.paragraphs.find(e=>e.id===x.value):null),C=I(()=>i.value?.choices?i.value.choices.filter(e=>e.visible===void 0?!0:typeof e.visible=="boolean"?e.visible:typeof e.visible=="function"?e.visible():!0):[]),j=I(()=>{if(!i.value)return[];const e=i.value.text;return Array.isArray(e)?e:e.split(`
`)}),k=I(()=>_.value<j.value.length-1),B=I(()=>j.value.slice(0,_.value+1));async function z(e){try{const r=`${e.startsWith("/")?e:`/assets/galgames/${e}`}`,c=await fetch(r);if(!c.ok)throw new Error(`Failed to load: ${c.statusText}`);return await c.json()}catch(a){return p.value=`加载游戏数据失败: ${a instanceof Error?a.message:String(a)}`,console.error(p.value,a),null}}async function G(){try{p.value="";let e=null;if(y.data&&(typeof y.data=="string"?e=await z(y.data):e=y.data),!e){p.value="未提供有效的游戏数据";return}g.value=e,x.value=e.start,_.value=0,w.value={...e.globalMarks},u.value=[],m.value=!1,h.value=!1,M(e.start)}catch(e){p.value=`初始化失败: ${e instanceof Error?e.message:String(e)}`,console.error(p.value,e)}}function M(e,a){u.value.length>0&&u.value[u.value.length-1]?.paragraphId===e||u.value.push({paragraphId:e,choiceText:a,timestamp:Date.now()})}function U(e){M(e.next,e.text),e.mark&&(typeof e.mark=="string"?w.value[e.mark]=!0:Object.assign(w.value,e.mark)),x.value=e.next,_.value=0,i.value?.isEnding&&(m.value=!0),N(()=>{const a=document.querySelector(".galgame-container");a&&a.scrollIntoView({behavior:"smooth",block:"start"})})}function P(){if(i.value){if(k.value){_.value++;return}C.value.length>0||i.value.auto&&(M(i.value.auto),x.value=i.value.auto,_.value=0,i.value?.isEnding&&(m.value=!0),N(()=>{const e=document.querySelector(".galgame-container");e&&e.scrollIntoView({behavior:"smooth",block:"start"})}))}}function A(e){if(!e.target.closest("button")){if(k.value){P();return}if(m.value&&k.value){P();return}!m.value&&C.value.length>0||P()}}function D(){G()}function R(e){if(e<0||e>=u.value.length)return;const a=u.value[e];if(a){x.value=a.paragraphId,_.value=0,u.value.splice(e+1),w.value={...g.value?.globalMarks};for(let o=1;o<=e;o++){const r=u.value[o];if(!r)continue;const c=u.value[o-1];if(!c)continue;const b=g.value?.paragraphs.find(V=>V.id===c.paragraphId);if(!b)continue;const $=b.choices?.find(V=>V.text===r.choiceText);$?.mark&&(typeof $.mark=="string"?w.value[$.mark]=!0:Object.assign(w.value,$.mark))}h.value=!1,N(()=>{const o=document.querySelector(".galgame-container");o&&o.scrollIntoView({behavior:"smooth",block:"start"})})}}Q(()=>{G()}),X(()=>{y.data&&G()});function J(){T&&clearInterval(T);const e=B.value;if(e.length===0)return;const a=e[e.length-1]||"";H.value=!0;const o=e.slice(0,-1).join(`
`);E.value=o+(o?`
`:"");let r=0;T=ne(()=>{r<=a.length?(E.value=o+(o?`
`:"")+a.substring(0,r),r++):(T&&clearInterval(T),H.value=!1)},50)}function W(e){const a=new Date(e),o=a.getHours().toString().padStart(2,"0"),r=a.getMinutes().toString().padStart(2,"0"),c=a.getSeconds().toString().padStart(2,"0");return`${o}:${r}:${c}`}return Y(B,()=>{J()},{immediate:!0}),(e,a)=>{const o=Z;return n(),s("div",oe,[t(p)?(n(),s("div",re,[a[2]||(a[2]=l("strong",null,"错误:",-1)),F(" "+f(t(p)),1)])):d("",!0),t(i)&&t(g)?(n(),s("div",le,[l("div",ie,[l("div",ce,[S(o,{name:"proicons:game",class:"ai-icon-galgame"}),l("span",ue,f(t(g).title||"Galgame"),1)]),l("div",de,[y.showHistory?(n(),s("button",{key:0,class:"toolbar-btn",title:t(h)?"关闭历史":"打开历史",onClick:a[0]||(a[0]=r=>h.value=!t(h))},[S(o,{name:"material-symbols:history",class:"btn-icon"}),l("span",null,f(t(h)?"关闭":"历史"),1)],8,ve)):d("",!0),y.showRestart?(n(),s("button",{key:1,class:"toolbar-btn",title:"重新开始",onClick:D},[S(o,{name:"material-symbols:restart-alt",class:"btn-icon"}),a[3]||(a[3]=l("span",null,"重新开始",-1))])):d("",!0)])]),l("div",{class:"ai-galgame-content",onClick:A},[t(i).speaker?(n(),s("div",ge,f(t(i).speaker),1)):d("",!0),t(i).background?(n(),s("div",{key:1,class:"galgame-background",style:ee({backgroundImage:`url(${t(i).background})`})},null,4)):d("",!0),l("div",me,[F(f(t(E)),1),t(H)?(n(),s("span",he,"_")):d("",!0)]),t(k)||t(m)&&t(k)||!t(m)&&t(C).length===0?(n(),s("div",fe," 点击继续 ")):d("",!0)]),!t(m)&&!t(k)&&t(C).length>0?(n(),s("div",pe,[(n(!0),s(L,null,O(t(C),(r,c)=>(n(),s("button",{key:c,class:"choice-btn",onClick:te(b=>U(r),["stop"])},f(r.text),9,ye))),128))])):d("",!0),t(m)&&!t(k)?(n(),s("div",_e,[l("button",{class:"ending-btn",onClick:D}," 重新开始 ")])):d("",!0)])):d("",!0),t(h)?(n(),s("div",ke,[l("div",be,[l("div",we,[S(o,{name:"material-symbols:history",class:"history-icon"}),a[4]||(a[4]=l("h3",null,"历史回顾",-1))]),l("button",{title:"关闭",class:"history-close",onClick:a[1]||(a[1]=r=>h.value=!1)},[S(o,{name:"yesicon:close"})])]),l("div",xe,[t(u).length===0?(n(),s("div",Te," 还没有历史记录 ")):(n(),s("div",Ce,[(n(!0),s(L,null,O(t(u),(r,c)=>(n(),s("button",{key:c,class:ae(["history-item",{active:c===t(u).length-1,"is-choice":!!r.choiceText}]),onClick:b=>R(c)},[l("div",Se,[a[5]||(a[5]=l("div",{class:"node-circle"},null,-1)),c<t(u).length-1?(n(),s("div",$e)):d("",!0)]),l("div",Ee,[l("div",He,[r.choiceText?(n(),s("span",Ge,"→ "+f(r.choiceText),1)):(n(),s("span",Me,f(t(g).paragraphs.find(b=>b.id===r.paragraphId)?.speaker||"开始"),1))]),l("div",Pe,f(W(r.timestamp)),1)])],10,Ie))),128))]))])])):d("",!0),!t(i)&&!t(g)&&!t(h)?(n(),s("div",Ve," 无游戏数据 ")):d("",!0)])}}}),De=Object.assign(se(Ne,[["__scopeId","data-v-2ed97ad0"]]),{__name:"Galgame"});export{De as default};
