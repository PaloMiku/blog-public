import{J as O,r as J,G as Z,x as m,ad as X,S as Y,Q as l,aQ as c,K as e,aN as n,b5 as r,aZ as P,aM as W,br as ee,aR as x,b8 as u,aU as D,aV as E,b7 as q,b4 as te}from"./D6ajeznB.js";import{_ as ae,f as se}from"./uVxEmkb0.js";import"./D-deoX8n.js";function F(s){return s.type==="character"}function B(s){return s.type==="media"}class K{cache=new Map;maxSize;defaultTTL;constructor(a=100,i=1440*60*1e3){this.maxSize=a,this.defaultTTL=i}get(a){const i=this.cache.get(a);return i?this.isExpired(i)?(this.cache.delete(a),null):i.data:null}set(a,i,d){if(this.cache.size>=this.maxSize){const k=this.cache.keys().next().value;this.cache.delete(k)}this.cache.set(a,{data:i,timestamp:Date.now(),ttl:d??this.defaultTTL})}delete(a){this.cache.delete(a)}clear(){this.cache.clear()}has(a){const i=this.cache.get(a);return i?this.isExpired(i)?(this.cache.delete(a),!1):!0:!1}size(){return this.cache.size}cleanup(){let a=0;for(const[i,d]of this.cache.entries())this.isExpired(d)&&(this.cache.delete(i),a++);return a}isExpired(a){return Date.now()-a.timestamp>a.ttl}getTimeToLive(a){const i=this.cache.get(a);if(!i)return-1;const d=Date.now()-i.timestamp,k=i.ttl-d;return k>0?k:0}}function ie(s){if(!Array.isArray(s))return[];const a=new Map;return s.forEach(i=>{a.has(i.name)||a.set(i.name,{name:i.name||"未知声优",image:i.image||i.images?.medium||i.images?.small,link:i.link||(i.id?`https://bangumi.tv/person/${i.id}`:void 0)})}),Array.from(a.values()).slice(0,3)}function ne(s){const a=new Map;return Array.isArray(s)&&s.forEach(i=>{typeof i.value=="string"&&a.set(i.key,i.value)}),a}function re(s){if(!Array.isArray(s))return"";const a=s.find(d=>d.key==="别名");if(!a||!Array.isArray(a.value))return"";const i=a.value.find(d=>d.k==="纯 假名"||d.k==="假名");return i?i.v:""}function oe(s){const a=ne(s.infobox),i=re(s.infobox),d=ie(s.voiceActors||[]);return{type:"character",source:"bangumi",title:s.name||"未知角色",subtitle:i||void 0,description:s.summary||void 0,image:s.images?.large||s.images?.medium||void 0,rating:void 0,tags:void 0,link:`https://bangumi.tv/character/${s.id}`,nameJp:i||void 0,nameCn:s.name_cn||void 0,gender:a.get("性别")||a.get("性 别")||void 0,birthday:a.get("生日")||void 0,bloodType:a.get("血型")||void 0,height:a.get("身高")||void 0,weight:a.get("体重")||void 0,bwh:a.get("BWH")||void 0,voiceActors:d.length>0?d:void 0,metadata:{characterId:s.id}}}function le(s){return{type:"media",source:"bangumi",title:s.name||"未命名作品",subtitle:s.name_cn||void 0,description:s.summary||void 0,image:s.images?.large||s.images?.common||void 0,rating:s.rating?.score||void 0,tags:s.tags?.map(a=>a.name).slice(0,5)||void 0,link:`https://bangumi.tv/subject/${s.id}`,episode:s.eps||void 0,status:s.status==="Air"?"on-air":s.status==="End"?"finished":"planned",airDate:s.date||void 0,rank:s.rank||void 0,metadata:{bangumiId:s.id,ratingCount:s.rating?.total||void 0}}}const ce=["data-type","data-source","title"],ue={key:1,class:"card-image-placeholder"},de={key:2,class:"rating-badge"},ve={class:"card-content"},me={class:"title-section"},he={class:"card-title"},pe={key:0,class:"card-subtitle"},fe={key:0,class:"card-description"},ge={key:0,class:"attributes-section"},be={key:0,class:"attribute-item"},_e={class:"attribute-value"},ye={key:1,class:"attribute-item"},ke={class:"attribute-value"},we={key:2,class:"attribute-item"},Ce={class:"attribute-value"},xe={key:3,class:"attribute-item"},De={class:"attribute-value"},Ae={key:4,class:"attribute-item"},Ie={class:"attribute-value"},Te={key:5,class:"attribute-item"},$e={class:"attribute-value"},Ee={key:1,class:"voice-actors-section"},Be={class:"voice-actors-header"},Me={class:"voice-actors-list"},ze={key:0,class:"media-info-section"},Le={class:"media-info-label"},Ne={class:"media-info-value"},je={key:1,class:"date-range"},Ve={key:0,class:"date-item"},Se={key:1,class:"date-item"},Je={key:3,class:"tags-container"},Pe={class:"card-footer"},We={class:"source-badge"},qe={class:"source-name"},Fe=["aria-label"],Ke={key:1,class:"info-card info-card-error"},Qe={key:2,class:"info-card info-card-loading"},Re=O({__name:"index",props:{data:{},loading:{type:Boolean},error:{type:Boolean},type:{},id:{}},setup(s){const a=s,i=F,d=B,k=new K(100,1440*60*1e3),Q=new K(100,1440*60*1e3),A=J(!1),g=J(""),w=Z(null);let y=null;const M=m(()=>"type"in a&&"id"in a),T=m(()=>"data"in a&&a.data),t=m(()=>T.value?a.data:w.value),I=m(()=>t.value?F(t.value):!1),z=m(()=>t.value?B(t.value):!1),$=m(()=>t.value?t.value.source==="bangumi"?"Bangumi":t.value.source:""),L=m(()=>"ri:bilibili-line");function R(){t.value?.link&&window.open(t.value.link,"_blank")}function N(p){return p?new Date(p).toLocaleDateString("zh-CN"):""}const j=m(()=>{if(!z.value||!t.value||!B(t.value))return[];const p=t.value,o=[];return p.episode&&o.push({label:"话数",value:p.episode}),p.rank&&o.push({label:"排名",value:`#${p.rank}`}),o}),U=m(()=>I.value?"card-layout-vertical":"card-layout-horizontal"),G=m(()=>I.value?"card-image-portrait":"card-image-landscape"),V=m(()=>T.value?a.loading||!1:A.value),S=m(()=>T.value?a.error||!1:g.value!=="");async function H(){if(!M.value)return;const p=a,{type:o,id:b}=p;if(!b)return;const f=o==="character"?k:Q,h=f.get(b);if(h){w.value=h,A.value=!1,g.value="";return}A.value=!0,g.value="",y&&y.abort(),y=new AbortController;try{const v=se.bangumi?.apiBase;if(!v){g.value="Bangumi API 未配置",console.error("[InfoCard] Bangumi API base not configured");return}let _,C;o==="character"?(_=await fetch(`${v}/api/character?id=${b}`,{signal:y.signal}),_.ok?(C=await _.json(),C.id?(w.value=oe(C),f.set(b,w.value)):g.value="获取人物数据失败"):g.value=`请求失败 (${_.status})`):o==="media"&&(_=await fetch(`${v}/api/subject?id=${b}`,{signal:y.signal}),_.ok?(C=await _.json(),C.id?(w.value=le(C),f.set(b,w.value)):g.value="获取媒体数据失败"):g.value=`请求失败 (${_.status})`)}catch(v){v instanceof Error&&v.name!=="AbortError"&&(console.error("[InfoCard] Fetch error:",v),g.value=v.message||"未知错误")}finally{A.value=!1}}return X(async()=>{M.value&&await H()}),Y(()=>{y&&y.abort()}),(p,o)=>{const b=ee,f=ae;return!e(V)&&!e(S)&&e(t)?(n(),l("div",{key:0,class:"info-card","data-type":e(t).type,"data-source":e(t).source,title:`点击查看${e($)}页面`},[r("div",{class:P(e(U))},[r("div",{class:P(["card-image-wrapper",e(G)])},[e(t).image?(n(),W(b,{key:0,src:e(t).image,alt:e(t).title,class:"card-image",loading:"lazy"},null,8,["src","alt"])):(n(),l("div",ue,[x(f,{name:e(I)?"ph:user-circle-bold":"ph:image-square-bold",class:"placeholder-icon"},null,8,["name"])])),e(t).rating?(n(),l("div",de," ⭐ "+u(e(t).rating),1)):c("",!0)],2),r("div",ve,[r("div",me,[r("h3",he,u(e(t).title),1),e(t).subtitle?(n(),l("p",pe,u(e(t).subtitle),1)):c("",!0)]),e(t).description?(n(),l("p",fe,u(e(t).description),1)):c("",!0),e(I)&&e(i)(e(t))?(n(),l(D,{key:1},[e(t).gender||e(t).birthday||e(t).height||e(t).bloodType?(n(),l("div",ge,[e(t).gender?(n(),l("div",be,[o[0]||(o[0]=r("span",{class:"attribute-label"},"性别",-1)),r("span",_e,u(e(t).gender),1)])):c("",!0),e(t).birthday?(n(),l("div",ye,[o[1]||(o[1]=r("span",{class:"attribute-label"},"生日",-1)),r("span",ke,u(e(t).birthday),1)])):c("",!0),e(t).height?(n(),l("div",we,[o[2]||(o[2]=r("span",{class:"attribute-label"},"身高",-1)),r("span",Ce,u(e(t).height),1)])):c("",!0),e(t).bloodType?(n(),l("div",xe,[o[3]||(o[3]=r("span",{class:"attribute-label"},"血型",-1)),r("span",De,u(e(t).bloodType),1)])):c("",!0),e(t).weight?(n(),l("div",Ae,[o[4]||(o[4]=r("span",{class:"attribute-label"},"体重",-1)),r("span",Ie,u(e(t).weight),1)])):c("",!0),e(t).bwh?(n(),l("div",Te,[o[5]||(o[5]=r("span",{class:"attribute-label"},"三围",-1)),r("span",$e,u(e(t).bwh),1)])):c("",!0)])):c("",!0),e(t).voiceActors&&e(t).voiceActors.length>0?(n(),l("div",Ee,[r("div",Be,[x(f,{name:"ri:mic-line",class:"voice-actors-icon"}),o[6]||(o[6]=r("span",null,"声优",-1))]),r("div",Me,[(n(!0),l(D,null,E(e(t).voiceActors,(h,v)=>(n(),l("div",{key:v,class:"voice-actor"},u(h.name),1))),128))])])):c("",!0)],64)):c("",!0),e(z)&&e(d)(e(t))?(n(),l(D,{key:2},[e(j).length>0?(n(),l("div",ze,[(n(!0),l(D,null,E(e(j),(h,v)=>(n(),l("div",{key:`${h.label}-${v}`,class:"media-info-item"},[r("span",Le,u(h.label)+":",1),r("span",Ne,u(h.value),1)]))),128))])):c("",!0),e(t).airDate||e(t).endDate?(n(),l("div",je,[e(t).airDate?(n(),l("span",Ve,[x(f,{name:"clarity:date-line",class:"date-icon"}),q(" "+u(N(e(t).airDate)),1)])):c("",!0),e(t).endDate?(n(),l("span",Se,[x(f,{name:"clarity:date-line",class:"date-icon"}),q(" "+u(N(e(t).endDate)),1)])):c("",!0)])):c("",!0)],64)):c("",!0),e(t).tags&&e(t).tags.length>0?(n(),l("div",Je,[(n(!0),l(D,null,E(e(t).tags,h=>(n(),l("span",{key:h,class:"tag"},u(h),1))),128))])):c("",!0),r("div",Pe,[r("div",We,[e(L)?(n(),W(f,{key:0,name:e(L),class:"source-icon"},null,8,["name"])):c("",!0),r("span",qe,u(e($)),1)]),e(t).link?(n(),l("button",{key:0,class:"view-button","aria-label":`查看 ${e($)} 上 ${e(t).title} 的详情`,onClick:R},[o[7]||(o[7]=r("span",null,"查看详情",-1)),x(f,{name:"ri:arrow-right-line",class:"button-icon"})],8,Fe)):c("",!0)])])],2)],8,ce)):e(S)?(n(),l("div",Ke,[...o[8]||(o[8]=[r("div",{class:"error-content"},[r("p",null,"加载失败"),r("small",null,"请检查 ID 是否正确或稍后重试")],-1)])])):e(V)?(n(),l("div",Qe,[...o[9]||(o[9]=[r("div",{class:"loading-skeleton"},null,-1)])])):c("",!0)}}}),Oe=Object.assign(te(Re,[["__scopeId","data-v-94f38e85"]]),{__name:"InfoCard"});export{Oe as default};
