import{J as U,r as W,G as X,x as v,ad as Y,S as Z,Q as r,aR as c,K as e,aO as n,b6 as o,a_ as P,aN as q,bs as ee,aS as x,b9 as u,aV as D,aW as B,b8 as T,b5 as te}from"./e2a45o_1.js";import{_ as ae,f as se}from"./PI9c30pl.js";import"./D-deoX8n.js";function F(s){return s.type==="character"}function M(s){return s.type==="media"}class K{cache=new Map;maxSize;defaultTTL;constructor(a=100,i=1440*60*1e3){this.maxSize=a,this.defaultTTL=i}get(a){const i=this.cache.get(a);return i?this.isExpired(i)?(this.cache.delete(a),null):i.data:null}set(a,i,d){if(this.cache.size>=this.maxSize){const k=this.cache.keys().next().value;this.cache.delete(k)}this.cache.set(a,{data:i,timestamp:Date.now(),ttl:d??this.defaultTTL})}delete(a){this.cache.delete(a)}clear(){this.cache.clear()}has(a){const i=this.cache.get(a);return i?this.isExpired(i)?(this.cache.delete(a),!1):!0:!1}size(){return this.cache.size}cleanup(){let a=0;for(const[i,d]of this.cache.entries())this.isExpired(d)&&(this.cache.delete(i),a++);return a}isExpired(a){return Date.now()-a.timestamp>a.ttl}getTimeToLive(a){const i=this.cache.get(a);if(!i)return-1;const d=Date.now()-i.timestamp,k=i.ttl-d;return k>0?k:0}}function ie(s){if(!Array.isArray(s))return[];const a=new Map;return s.forEach(i=>{a.has(i.name)||a.set(i.name,{name:i.name||"未知声优",image:i.image||i.images?.medium||i.images?.small,link:i.link||(i.id?`https://bangumi.tv/person/${i.id}`:void 0)})}),Array.from(a.values()).slice(0,3)}function ne(s){const a=new Map;return Array.isArray(s)&&s.forEach(i=>{typeof i.value=="string"&&a.set(i.key,i.value)}),a}function re(s){if(!Array.isArray(s))return"";const a=s.find(d=>d.key==="别名");if(!a||!Array.isArray(a.value))return"";const i=a.value.find(d=>d.k==="纯 假名"||d.k==="假名");return i?i.v:""}function oe(s){const a=ne(s.infobox),i=re(s.infobox),d=ie(s.voiceActors||[]);return{type:"character",source:"bangumi",title:s.name||"未知角色",subtitle:i||void 0,description:s.summary||void 0,image:s.images?.large||s.images?.medium||void 0,rating:void 0,tags:void 0,link:`https://bangumi.tv/character/${s.id}`,nameJp:i||void 0,nameCn:s.name_cn||void 0,gender:a.get("性别")||a.get("性 别")||void 0,birthday:a.get("生日")||void 0,bloodType:a.get("血型")||void 0,height:a.get("身高")||void 0,weight:a.get("体重")||void 0,bwh:a.get("BWH")||void 0,voiceActors:d.length>0?d:void 0,metadata:{characterId:s.id}}}function le(s){return{type:"media",source:"bangumi",title:s.name||"未命名作品",subtitle:s.name_cn||void 0,description:s.summary||void 0,image:s.images?.large||s.images?.common||void 0,rating:s.rating?.score||void 0,tags:s.tags?.map(a=>a.name).slice(0,5)||void 0,link:`https://bangumi.tv/subject/${s.id}`,episode:s.eps||void 0,status:s.status==="Air"?"on-air":s.status==="End"?"finished":"planned",airDate:s.date||void 0,rank:s.rank||void 0,metadata:{bangumiId:s.id,ratingCount:s.rating?.total||void 0}}}const ce=["data-type","data-source","title"],ue={key:1,class:"card-image-placeholder"},de={key:2,class:"rating-badge"},me={class:"card-content"},ve={class:"title-section"},he={class:"card-title"},pe={key:0,class:"card-subtitle"},fe={key:0,class:"card-description"},ge={key:0,class:"attributes-section"},be={key:0,class:"attribute-item"},_e={class:"attribute-value"},ye={key:1,class:"attribute-item"},ke={class:"attribute-value"},we={key:2,class:"attribute-item"},Ce={class:"attribute-value"},De={key:3,class:"attribute-item"},xe={class:"attribute-value"},Ae={key:4,class:"attribute-item"},Ie={class:"attribute-value"},Te={key:5,class:"attribute-item"},$e={class:"attribute-value"},Ee={key:1,class:"voice-actors-section"},Be={class:"voice-actors-header"},Me={class:"voice-actors-list"},ze={key:0,class:"media-info-section"},Le={class:"media-info-label"},Ne={class:"media-info-value"},je={key:1,class:"date-range"},Se={key:0,class:"date-item"},Ve={key:1,class:"date-item"},Je={key:3,class:"tags-container"},We={class:"card-footer"},Pe={class:"source-badge"},qe={class:"source-name"},Fe=["aria-label"],Ke={key:1,class:"info-card info-card-error"},Oe={key:2,class:"info-card info-card-loading"},Re=U({__name:"index",props:{data:{},loading:{type:Boolean},error:{type:Boolean},type:{},id:{}},setup(s){const a=s,i=F,d=M,k=new K(100,1440*60*1e3),O=new K(100,1440*60*1e3),A=W(!1),g=W(""),w=X(null);let y=null;const z=v(()=>"type"in a&&"id"in a),$=v(()=>"data"in a&&a.data),t=v(()=>$.value?a.data:w.value),I=v(()=>t.value?F(t.value):!1),L=v(()=>t.value?M(t.value):!1),E=v(()=>t.value?t.value.source==="bangumi"?"Bangumi":t.value.source:""),N=v(()=>"ri:bilibili-line");function R(){t.value?.link&&window.open(t.value.link,"_blank")}function j(p){return p?new Date(p).toLocaleDateString("zh-CN"):""}const S=v(()=>{if(!L.value||!t.value||!M(t.value))return[];const p=t.value,l=[];return p.episode&&l.push({label:"话数",value:p.episode}),p.rank&&l.push({label:"排名",value:`#${p.rank}`}),l}),G=v(()=>I.value?"card-layout-vertical":"card-layout-horizontal"),H=v(()=>I.value?"card-image-portrait":"card-image-landscape"),V=v(()=>$.value?a.loading||!1:A.value),J=v(()=>$.value?a.error||!1:g.value!=="");async function Q(){if(!z.value)return;const p=a,{type:l,id:b}=p;if(!b)return;const f=l==="character"?k:O,h=f.get(b);if(h){w.value=h,A.value=!1,g.value="";return}A.value=!0,g.value="",y&&y.abort(),y=new AbortController;try{const m=se.bangumi?.apiBase;if(!m){g.value="Bangumi API 未配置",console.error("[InfoCard] Bangumi API base not configured");return}let _,C;l==="character"?(_=await fetch(`${m}/api/character?id=${b}`,{signal:y.signal}),_.ok?(C=await _.json(),C.id?(w.value=oe(C),f.set(b,w.value)):g.value="获取人物数据失败"):g.value=`请求失败 (${_.status})`):l==="media"&&(_=await fetch(`${m}/api/subject?id=${b}`,{signal:y.signal}),_.ok?(C=await _.json(),C.id?(w.value=le(C),f.set(b,w.value)):g.value="获取媒体数据失败"):g.value=`请求失败 (${_.status})`)}catch(m){m instanceof Error&&m.name!=="AbortError"&&(console.error("[InfoCard] Fetch error:",m),g.value=m.message||"未知错误")}finally{A.value=!1}}return Y(async()=>{z.value&&await Q()}),Z(()=>{y&&y.abort()}),(p,l)=>{const b=ee,f=ae;return!e(V)&&!e(J)&&e(t)?(n(),r("div",{key:0,class:"info-card","data-type":e(t).type,"data-source":e(t).source,title:`点击查看${e(E)}页面`},[o("div",{class:P(e(G))},[o("div",{class:P(["card-image-wrapper",e(H)])},[e(t).image?(n(),q(b,{key:0,src:e(t).image,alt:e(t).title,class:"card-image",loading:"lazy"},null,8,["src","alt"])):(n(),r("div",ue,[x(f,{name:e(I)?"ph:user-circle-bold":"ph:image-square-bold",class:"placeholder-icon"},null,8,["name"])])),e(t).rating?(n(),r("div",de," ⭐ "+u(e(t).rating),1)):c("",!0)],2),o("div",me,[o("div",ve,[o("h3",he,u(e(t).title),1),e(t).subtitle?(n(),r("p",pe,u(e(t).subtitle),1)):c("",!0)]),e(t).description?(n(),r("p",fe,u(e(t).description),1)):c("",!0),e(I)&&e(i)(e(t))?(n(),r(D,{key:1},[e(t).gender||e(t).birthday||e(t).height||e(t).bloodType?(n(),r("div",ge,[e(t).gender?(n(),r("div",be,[l[0]||(l[0]=o("span",{class:"attribute-label"},"性别",-1)),o("span",_e,u(e(t).gender),1)])):c("",!0),e(t).birthday?(n(),r("div",ye,[l[1]||(l[1]=o("span",{class:"attribute-label"},"生日",-1)),o("span",ke,u(e(t).birthday),1)])):c("",!0),e(t).height?(n(),r("div",we,[l[2]||(l[2]=o("span",{class:"attribute-label"},"身高",-1)),o("span",Ce,u(e(t).height),1)])):c("",!0),e(t).bloodType?(n(),r("div",De,[l[3]||(l[3]=o("span",{class:"attribute-label"},"血型",-1)),o("span",xe,u(e(t).bloodType),1)])):c("",!0),e(t).weight?(n(),r("div",Ae,[l[4]||(l[4]=o("span",{class:"attribute-label"},"体重",-1)),o("span",Ie,u(e(t).weight),1)])):c("",!0),e(t).bwh?(n(),r("div",Te,[l[5]||(l[5]=o("span",{class:"attribute-label"},"三围",-1)),o("span",$e,u(e(t).bwh),1)])):c("",!0)])):c("",!0),e(t).voiceActors&&e(t).voiceActors.length>0?(n(),r("div",Ee,[o("div",Be,[x(f,{name:"ri:mic-line",class:"voice-actors-icon"}),l[6]||(l[6]=o("span",null,"声优",-1))]),o("div",Me,[(n(!0),r(D,null,B(e(t).voiceActors,(h,m)=>(n(),r("span",{key:m,class:"voice-actor"},[m>0?(n(),r(D,{key:0},[T(" / ")],64)):c("",!0),T(u(h.name),1)]))),128))])])):c("",!0)],64)):c("",!0),e(L)&&e(d)(e(t))?(n(),r(D,{key:2},[e(S).length>0?(n(),r("div",ze,[(n(!0),r(D,null,B(e(S),(h,m)=>(n(),r("div",{key:`${h.label}-${m}`,class:"media-info-item"},[o("span",Le,u(h.label)+":",1),o("span",Ne,u(h.value),1)]))),128))])):c("",!0),e(t).airDate||e(t).endDate?(n(),r("div",je,[e(t).airDate?(n(),r("span",Se,[x(f,{name:"clarity:date-line",class:"date-icon"}),T(" "+u(j(e(t).airDate)),1)])):c("",!0),e(t).endDate?(n(),r("span",Ve,[x(f,{name:"clarity:date-line",class:"date-icon"}),T(" "+u(j(e(t).endDate)),1)])):c("",!0)])):c("",!0)],64)):c("",!0),e(t).tags&&e(t).tags.length>0?(n(),r("div",Je,[(n(!0),r(D,null,B(e(t).tags,h=>(n(),r("span",{key:h,class:"tag"},u(h),1))),128))])):c("",!0),o("div",We,[o("div",Pe,[e(N)?(n(),q(f,{key:0,name:e(N),class:"source-icon"},null,8,["name"])):c("",!0),o("span",qe,u(e(E)),1)]),e(t).link?(n(),r("button",{key:0,class:"view-button","aria-label":`查看 ${e(E)} 上 ${e(t).title} 的详情`,onClick:R},[l[7]||(l[7]=o("span",null,"查看详情",-1)),x(f,{name:"ri:arrow-right-line",class:"button-icon"})],8,Fe)):c("",!0)])])],2)],8,ce)):e(J)?(n(),r("div",Ke,[...l[8]||(l[8]=[o("div",{class:"error-content"},[o("p",null,"加载失败"),o("small",null,"请检查 ID 是否正确或稍后重试")],-1)])])):e(V)?(n(),r("div",Oe,[...l[9]||(l[9]=[o("div",{class:"loading-skeleton"},null,-1)])])):c("",!0)}}}),Ue=Object.assign(te(Re,[["__scopeId","data-v-2dac9245"]]),{__name:"InfoCard"});export{Ue as default};
