import{_ as K}from"./iUv9qIY0.js";import{J as Q,r as v,x as I,N as U,ad as X,o as Y,Q as r,aO as n,aR as c,K as t,b6 as i,b8 as D,b9 as p,aS as $,a$ as Z,aV as F,aW as O,b7 as ee,a_ as te,q as j,b5 as ae}from"./DeZJN128.js";import{s as se}from"./DyxKHOu7.js";import"./D-deoX8n.js";const re={class:"galgame-wrapper"},ne={key:0,class:"galgame-error"},oe={key:1,class:"md-galgame ai-galgame"},le={class:"ai-galgame-header"},ie={class:"ai-galgame-title"},ce={class:"ai-galgame-label"},ue={class:"ai-galgame-toolbar"},ve=["title"],ge={key:0,class:"galgame-speaker"},de={class:"galgame-text"},me={key:0,class:"typewriter-caret"},fe={key:2,class:"galgame-hint"},he={key:0,class:"galgame-choices"},pe=["onClick"],ye={key:1,class:"galgame-ending"},_e={key:2,class:"galgame-history-panel"},ke={class:"history-header"},be={class:"history-title"},we={class:"history-list"},xe={key:0,class:"history-empty"},Te=["onClick"],Ce={class:"history-index"},Ie={class:"history-content"},$e={key:0,class:"history-choice"},Ee={key:1,class:"history-paragraph"},Se={key:3,class:"galgame-empty"},Ve=Q({__name:"Galgame",props:{data:{},showHistory:{type:Boolean,default:!0},showRestart:{type:Boolean,default:!0}},setup(L){const y=L,g=v(null),f=v(""),x=v(""),u=v([]),b=v({}),d=v(!1),h=v(!1),_=v(0),S=v(""),V=v(!1);let T=null;const o=I(()=>g.value?g.value.paragraphs.find(e=>e.id===x.value):null),C=I(()=>o.value?.choices?o.value.choices.filter(e=>e.visible===void 0?!0:typeof e.visible=="boolean"?e.visible:typeof e.visible=="function"?e.visible():!0):[]),B=I(()=>{if(!o.value)return[];const e=o.value.text;return Array.isArray(e)?e:e.split(`
`)}),k=I(()=>_.value<B.value.length-1),P=I(()=>B.value.slice(0,_.value+1));async function R(e){try{const a=e.startsWith("/")?e:`/assets/galgames/${e}`,s=await fetch(a);if(!s.ok)throw new Error(`Failed to load: ${s.statusText}`);return await s.json()}catch(a){return f.value=`加载游戏数据失败: ${a instanceof Error?a.message:String(a)}`,console.error(f.value,a),null}}async function H(){try{f.value="";let e=null;if(y.data&&(typeof y.data=="string"?e=await R(y.data):e=y.data),!e){f.value="未提供有效的游戏数据";return}g.value=e,x.value=e.start,_.value=0,b.value={...e.globalMarks},u.value=[],d.value=!1,h.value=!1,G(e.start)}catch(e){f.value=`初始化失败: ${e instanceof Error?e.message:String(e)}`,console.error(f.value,e)}}function G(e,a){u.value.push({paragraphId:e,choiceText:a,timestamp:Date.now()})}function z(e){G(e.next,e.text),e.mark&&(typeof e.mark=="string"?b.value[e.mark]=!0:Object.assign(b.value,e.mark)),x.value=e.next,_.value=0,o.value?.isEnding&&(d.value=!0),j(()=>{const a=document.querySelector(".galgame-container");a&&a.scrollIntoView({behavior:"smooth",block:"start"})})}function M(){if(o.value){if(k.value){_.value++;return}C.value.length>0||o.value.auto&&(G(o.value.auto),x.value=o.value.auto,_.value=0,o.value?.isEnding&&(d.value=!0),j(()=>{const e=document.querySelector(".galgame-container");e&&e.scrollIntoView({behavior:"smooth",block:"start"})}))}}function A(e){if(!e.target.closest("button")){if(k.value){M();return}if(d.value&&k.value){M();return}!d.value&&C.value.length>0||M()}}function q(){H()}function W(e){if(e<0||e>=u.value.length)return;const a=u.value[e];if(a){x.value=a.paragraphId,_.value=0,u.value.splice(e+1),b.value={...g.value?.globalMarks};for(let s=1;s<=e;s++){const l=u.value[s];if(!l)continue;const m=u.value[s-1];if(!m)continue;const w=g.value?.paragraphs.find(N=>N.id===m.paragraphId);if(!w)continue;const E=w.choices?.find(N=>N.text===l.choiceText);E?.mark&&(typeof E.mark=="string"?b.value[E.mark]=!0:Object.assign(b.value,E.mark))}h.value=!1,j(()=>{const s=document.querySelector(".galgame-container");s&&s.scrollIntoView({behavior:"smooth",block:"start"})})}}U(()=>{H()}),X(()=>{y.data&&H()});function J(){T&&clearInterval(T);const e=P.value;if(e.length===0)return;const a=e[e.length-1]||"";V.value=!0;const s=e.slice(0,-1).join(`
`);S.value=s+(s?`
`:"");let l=0;T=se(()=>{l<=a.length?(S.value=s+(s?`
`:"")+a.substring(0,l),l++):(T&&clearInterval(T),V.value=!1)},50)}return Y(P,()=>{J()},{immediate:!0}),(e,a)=>{const s=K;return n(),r("div",re,[t(f)?(n(),r("div",ne,[a[2]||(a[2]=i("strong",null,"错误:",-1)),D(" "+p(t(f)),1)])):c("",!0),t(o)&&t(g)?(n(),r("div",oe,[i("div",le,[i("div",ie,[$(s,{name:"proicons:game",class:"ai-icon-galgame"}),i("span",ce,p(t(g).title||"Galgame"),1)]),i("div",ue,[y.showHistory?(n(),r("button",{key:0,class:"toolbar-btn",title:t(h)?"关闭历史":"打开历史",onClick:a[0]||(a[0]=l=>h.value=!t(h))},[$(s,{name:"material-symbols:history"})],8,ve)):c("",!0),y.showRestart?(n(),r("button",{key:1,class:"toolbar-btn",title:"重新开始",onClick:q},[$(s,{name:"material-symbols:restart-alt"})])):c("",!0)])]),i("div",{class:"ai-galgame-content",onClick:A},[t(o).speaker?(n(),r("div",ge,p(t(o).speaker),1)):c("",!0),t(o).background?(n(),r("div",{key:1,class:"galgame-background",style:Z({backgroundImage:`url(${t(o).background})`})},null,4)):c("",!0),i("div",de,[D(p(t(S)),1),t(V)?(n(),r("span",me,"_")):c("",!0)]),t(k)||t(d)&&t(k)||!t(d)&&t(C).length===0?(n(),r("div",fe," 点击继续 ")):c("",!0)]),!t(d)&&!t(k)&&t(C).length>0?(n(),r("div",he,[(n(!0),r(F,null,O(t(C),(l,m)=>(n(),r("button",{key:m,class:"choice-btn",onClick:ee(w=>z(l),["stop"])},p(l.text),9,pe))),128))])):c("",!0),t(d)&&!t(k)?(n(),r("div",ye,[i("button",{class:"ending-btn",onClick:q}," 重新开始 ")])):c("",!0)])):c("",!0),t(h)?(n(),r("div",_e,[i("div",ke,[i("div",be,[$(s,{name:"material-symbols:history",class:"history-icon"}),a[3]||(a[3]=i("h3",null,"历史回顾",-1))]),i("button",{title:"关闭",class:"history-close",onClick:a[1]||(a[1]=l=>h.value=!1)},[$(s,{name:"yesicon:close"})])]),i("div",we,[t(u).length===0?(n(),r("div",xe," 还没有历史记录 ")):(n(!0),r(F,{key:1},O(t(u),(l,m)=>(n(),r("button",{key:m,class:te(["history-item",{active:m===t(u).length-1}]),onClick:w=>W(m)},[i("span",Ce,p(m+1),1),i("span",Ie,[l.choiceText?(n(),r("span",$e,"→ "+p(l.choiceText),1)):(n(),r("span",Ee,p(t(g).paragraphs.find(w=>w.id===l.paragraphId)?.speaker||"开始"),1))])],10,Te))),128))])])):c("",!0),!t(o)&&!t(g)&&!t(h)?(n(),r("div",Se," 无游戏数据 ")):c("",!0)])}}}),je=Object.assign(ae(Ve,[["__scopeId","data-v-788889c8"]]),{__name:"Galgame"});export{je as default};
