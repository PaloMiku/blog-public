import{G as W,r as v,z as S,o as J,bl as X,ah as Y,d as s,e as n,f as d,Q as t,h as l,S as N,t as f,g as I,O as Z,U as ee,F as O,V as U,aQ as te,n as ae,aK as j,_ as se}from"./fsc30HAO.js";import{s as ne}from"./DNqp3_hf.js";const oe={class:"galgame-wrapper"},re={key:0,class:"galgame-error"},le={key:1,class:"md-galgame ai-galgame"},ie={class:"ai-galgame-header"},ce={class:"ai-galgame-title"},ue={class:"ai-galgame-label"},de={class:"ai-galgame-toolbar"},ve=["title"],ge={key:0,class:"galgame-speaker"},he={class:"galgame-text"},me={key:0,class:"typewriter-caret"},fe={key:2,class:"galgame-hint"},pe={key:0,class:"galgame-choices"},ye=["onClick"],_e={key:1,class:"galgame-ending"},ke={key:2,class:"galgame-history-panel"},be={class:"history-header"},we={class:"history-title"},xe={class:"history-list"},Te={key:0,class:"history-empty"},Ce={key:1,class:"history-timeline"},Se=["onClick"],Ie={class:"timeline-node"},$e={key:0,class:"node-connector"},Ee={class:"history-content"},He={class:"history-main"},Ve={key:0,class:"history-choice"},Ge={key:1,class:"history-paragraph"},Me={class:"history-meta"},Pe={key:3,class:"galgame-empty"},je=W({__name:"Galgame",props:{data:{},showHistory:{type:Boolean,default:!0},showRestart:{type:Boolean,default:!0}},setup(q){const y=q,g=v(null),p=v(""),x=v(""),u=v([]),w=v({}),h=v(!1),m=v(!1),_=v(0),E=v(""),H=v(!1);let T=null;const i=S(()=>g.value?g.value.paragraphs.find(e=>e.id===x.value):null),C=S(()=>i.value?.choices?i.value.choices.filter(e=>e.visible===void 0?!0:typeof e.visible=="boolean"?e.visible:typeof e.visible=="function"?e.visible():!0):[]),B=S(()=>{if(!i.value)return[];const e=i.value.text;return Array.isArray(e)?e:e.split(`
`)}),k=S(()=>_.value<B.value.length-1),D=S(()=>B.value.slice(0,_.value+1));async function z(e){try{const r=`${e.startsWith("/")?e:`/assets/galgames/${e}`}`,c=await fetch(r);if(!c.ok)throw new Error(`Failed to load: ${c.statusText}`);return await c.json()}catch(a){return p.value=`加载游戏数据失败: ${a instanceof Error?a.message:String(a)}`,console.error(p.value,a),null}}async function V(){try{p.value="";let e=null;if(y.data&&(typeof y.data=="string"?e=await z(y.data):e=y.data),!e){p.value="未提供有效的游戏数据";return}g.value=e,x.value=e.start,_.value=0,w.value={...e.globalMarks},u.value=[],h.value=!1,m.value=!1,G(e.start)}catch(e){p.value=`初始化失败: ${e instanceof Error?e.message:String(e)}`,console.error(p.value,e)}}function G(e,a){u.value.length>0&&u.value[u.value.length-1]?.paragraphId===e||u.value.push({paragraphId:e,choiceText:a,timestamp:Date.now()})}function L(e){G(e.next,e.text),e.mark&&(typeof e.mark=="string"?w.value[e.mark]=!0:Object.assign(w.value,e.mark)),x.value=e.next,_.value=0,i.value?.isEnding&&(h.value=!0),j(()=>{const a=document.querySelector(".galgame-container");a&&a.scrollIntoView({behavior:"smooth",block:"start"})})}function M(){if(i.value){if(k.value){_.value++;return}C.value.length>0||i.value.auto&&(G(i.value.auto),x.value=i.value.auto,_.value=0,i.value?.isEnding&&(h.value=!0),j(()=>{const e=document.querySelector(".galgame-container");e&&e.scrollIntoView({behavior:"smooth",block:"start"})}))}}function A(e){if(!e.target.closest("button")){if(k.value){M();return}if(h.value&&k.value){M();return}!h.value&&C.value.length>0||M()}}function F(){V()}function Q(e){if(e<0||e>=u.value.length)return;const a=u.value[e];if(a){x.value=a.paragraphId,_.value=0,u.value.splice(e+1),w.value={...g.value?.globalMarks};for(let o=1;o<=e;o++){const r=u.value[o];if(!r)continue;const c=u.value[o-1];if(!c)continue;const b=g.value?.paragraphs.find(P=>P.id===c.paragraphId);if(!b)continue;const $=b.choices?.find(P=>P.text===r.choiceText);$?.mark&&(typeof $.mark=="string"?w.value[$.mark]=!0:Object.assign(w.value,$.mark))}m.value=!1,j(()=>{const o=document.querySelector(".galgame-container");o&&o.scrollIntoView({behavior:"smooth",block:"start"})})}}J(()=>{V()}),X(()=>{y.data&&V()});function R(){T&&clearInterval(T);const e=D.value;if(e.length===0)return;const a=e[e.length-1]||"";H.value=!0;const o=e.slice(0,-1).join(`
`);E.value=o+(o?`
`:"");let r=0;T=ne(()=>{r<=a.length?(E.value=o+(o?`
`:"")+a.substring(0,r),r++):(T&&clearInterval(T),H.value=!1)},50)}function K(e){const a=new Date(e),o=a.getHours().toString().padStart(2,"0"),r=a.getMinutes().toString().padStart(2,"0"),c=a.getSeconds().toString().padStart(2,"0");return`${o}:${r}:${c}`}return Y(D,()=>{R()},{immediate:!0}),(e,a)=>{const o=Z;return n(),s("div",oe,[t(p)?(n(),s("div",re,[a[2]||(a[2]=l("strong",null,"错误:",-1)),N(" "+f(t(p)),1)])):d("",!0),t(i)&&t(g)?(n(),s("div",le,[l("div",ie,[l("div",ce,[I(o,{name:"proicons:game",class:"ai-icon-galgame"}),l("span",ue,f(t(g).title||"Galgame"),1)]),l("div",de,[y.showHistory?(n(),s("button",{key:0,class:"toolbar-btn",title:t(m)?"关闭历史":"打开历史",onClick:a[0]||(a[0]=r=>m.value=!t(m))},[I(o,{name:"material-symbols:history",class:"btn-icon"}),l("span",null,f(t(m)?"关闭":"历史"),1)],8,ve)):d("",!0),y.showRestart?(n(),s("button",{key:1,class:"toolbar-btn",title:"重新开始",onClick:F},[I(o,{name:"material-symbols:restart-alt",class:"btn-icon"}),a[3]||(a[3]=l("span",null,"重新开始",-1))])):d("",!0)])]),l("div",{class:"ai-galgame-content",onClick:A},[t(i).speaker?(n(),s("div",ge,f(t(i).speaker),1)):d("",!0),t(i).background?(n(),s("div",{key:1,class:"galgame-background",style:ee({backgroundImage:`url(${t(i).background})`})},null,4)):d("",!0),l("div",he,[N(f(t(E)),1),t(H)?(n(),s("span",me,"_")):d("",!0)]),t(k)||t(h)&&t(k)||!t(h)&&t(C).length===0?(n(),s("div",fe," 点击继续 ")):d("",!0)]),!t(h)&&!t(k)&&t(C).length>0?(n(),s("div",pe,[(n(!0),s(O,null,U(t(C),(r,c)=>(n(),s("button",{key:c,class:"choice-btn",onClick:te(b=>L(r),["stop"])},f(r.text),9,ye))),128))])):d("",!0),t(h)&&!t(k)?(n(),s("div",_e,[l("button",{class:"ending-btn",onClick:F}," 重新开始 ")])):d("",!0)])):d("",!0),t(m)?(n(),s("div",ke,[l("div",be,[l("div",we,[I(o,{name:"material-symbols:history",class:"history-icon"}),a[4]||(a[4]=l("h3",null,"历史回顾",-1))]),l("button",{title:"关闭",class:"history-close",onClick:a[1]||(a[1]=r=>m.value=!1)},[I(o,{name:"yesicon:close"})])]),l("div",xe,[t(u).length===0?(n(),s("div",Te," 还没有历史记录 ")):(n(),s("div",Ce,[(n(!0),s(O,null,U(t(u),(r,c)=>(n(),s("button",{key:c,class:ae(["history-item",{active:c===t(u).length-1,"is-choice":!!r.choiceText}]),onClick:b=>Q(c)},[l("div",Ie,[a[5]||(a[5]=l("div",{class:"node-circle"},null,-1)),c<t(u).length-1?(n(),s("div",$e)):d("",!0)]),l("div",Ee,[l("div",He,[r.choiceText?(n(),s("span",Ve,"→ "+f(r.choiceText),1)):(n(),s("span",Ge,f(t(g).paragraphs.find(b=>b.id===r.paragraphId)?.speaker||"开始"),1))]),l("div",Me,f(K(r.timestamp)),1)])],10,Se))),128))]))])])):d("",!0),!t(i)&&!t(g)&&!t(m)?(n(),s("div",Pe," 无游戏数据 ")):d("",!0)])}}}),Fe=Object.assign(se(je,[["__scopeId","data-v-c3c464bf"]]),{__name:"Galgame"});export{Fe as default};
