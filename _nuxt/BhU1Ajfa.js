import{u as M,t as v,A as K,b as L,B as X,_ as $}from"#entry";import{L as C}from"./DKEEkYN0.js";import{J as S,N,s as m,q as T,aD as A,Q as I,aN as q,b7 as u,aR as w,b9 as _,M as z,b4 as P}from"./BOu4zRvQ.js";const B={class:"z-comment"},O={class:"text-creative"},D={id:"artalk"},R={class:"loading-box"},V=S({__name:"Comment",setup(j){const d=M(),p=v(),f=K(),h=X.getInstance(),y=L();function x(e){return!e||e==="/"||e.endsWith("/")?e:`${e}/`}function E(){return new Promise((e,n)=>{if(typeof window<"u"&&window.katex){e(window.katex);return}const o=document.querySelector('script[src*="katex"]');if(o){o.addEventListener("load",()=>e(window.katex)),o.addEventListener("error",()=>{console.warn("[KaTeX] 加载失败"),n(new Error("KaTeX 加载失败"))});return}const t=document.createElement("script");t.src="https://lib.baomitu.com/KaTeX/0.16.9/katex.min.js",t.onload=()=>{console.debug("[KaTeX] 加载成功"),e(window.katex)},t.onerror=()=>{console.warn("[KaTeX] 加载失败"),n(new Error("KaTeX 脚本加载失败"))},document.head.appendChild(t)})}async function l(){try{await E();const e=typeof window<"u"?window.katex:void 0;if(!e){console.warn("[KaTeX] 未检测到 KaTeX 实例，稍后重试"),setTimeout(()=>l(),1e3);return}document.querySelectorAll("#artalk .atk-content:not(.math-processed)").forEach(o=>{o.classList.add("math-processed");let t=o.innerHTML;const c=t;t=t.replace(/\$\$([^$]+)\$\$/g,(r,a)=>{try{return`<span class="math-display">${e.renderToString(a.trim(),{displayMode:!0})}</span>`}catch(i){return console.warn("KaTeX display render error:",i),r}}),t=t.replace(/\$([^$\n]+)\$/g,(r,a)=>{if(r.includes('<span class="math-'))return r;try{return`<span class="math-inline">${e.renderToString(a.trim(),{displayMode:!1})}</span>`}catch(i){return console.warn("KaTeX inline render error:",i),r}}),t=t.replace(/```math\s*([\s\S]*?)```/g,(r,a)=>{try{return`<div class="math-block">${e.renderToString(a.trim(),{displayMode:!0})}</div>`}catch(i){return console.warn("KaTeX math block render error:",i),r}}),t!==c&&(o.innerHTML=t)})}catch(e){console.error("Failed to load KaTeX:",e),setTimeout(()=>l(),1e3)}}function g(){document.querySelectorAll("#artalk .atk-content img").forEach(n=>{const o=n;o.style.cursor!=="zoom-in"&&(o.style.cursor="zoom-in",o.addEventListener("click",()=>{const{open:t}=y.use(()=>z(C,{el:o}));t()}))})}let s=null;function b(){const e=document.getElementById("artalk");e&&(s&&s.disconnect(),s=new MutationObserver(n=>{let o=!1,t=!1;n.forEach(c=>{c.type==="childList"&&c.addedNodes.length>0&&c.addedNodes.forEach(r=>{if(r.nodeType===Node.ELEMENT_NODE){const a=r;(a.tagName==="IMG"||a.querySelector("img"))&&(o=!0),(a.classList?.contains("atk-content")||a.querySelector(".atk-content"))&&(t=!0)}})}),o&&setTimeout(()=>g(),100),t&&setTimeout(()=>l(),500)}),s.observe(e,{childList:!0,subtree:!0}))}async function k(){try{const e=x(p.path);console.debug("[Artalk] 开始初始化...",{path:e}),await h.init({el:"#artalk",pageKey:e,pageTitle:document.title.replace(` | ${d.title}`,""),server:d.artalk?.server,site:d.artalk?.site,emoticons:"/assets/Owo-Artalk.json",darkMode:f.value==="dark"}),console.debug("[Artalk] 初始化完成"),await m(()=>{setTimeout(()=>{g(),setTimeout(()=>l(),1e3),b()},500)})}catch(e){console.error("[Artalk] 初始化失败:",e instanceof Error?e.message:e)}}return N(()=>{m(()=>{setTimeout(k,100)})}),T(()=>p.path,()=>{m(()=>{setTimeout(k,100)})}),T(()=>f.value,e=>{h.setDarkMode(e==="dark")}),A(()=>{s&&(s.disconnect(),s=null)}),(e,n)=>{const o=$;return q(),I("section",B,[u("h3",O,[w(o,{name:"i-hugeicons:comment-01",class:"comment-tip"}),n[0]||(n[0]=_("评论 ",-1))]),u("div",D,[u("p",R,[w(o,{name:"line-md:loading-twotone-loop",class:"loadig-img"}),n[1]||(n[1]=_("评论加载中... ",-1))])])])}}}),G=Object.assign(P(V,[["__scopeId","data-v-3206c485"]]),{__name:"PostComment"});export{G as _};
