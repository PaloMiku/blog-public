import{J as U,r as q,G as X,x as p,ad as Y,S as Z,Q as o,aR as u,K as e,aO as r,b6 as i,a_ as z,aN as E,ba as ee,aS as y,aV as k,b9 as d,aW as D,b8 as F,b5 as te}from"./uFNG57UN.js";import{_ as ae,f as se}from"./CwNEwvkc.js";import ie from"./Bjh-dV2t.js";import"./D-deoX8n.js";import"./4S_s68Rg.js";function K(s){return s.type==="character"}function L(s){return s.type==="media"}class O{cache=new Map;maxSize;defaultTTL;constructor(a=100,n=1440*60*1e3){this.maxSize=a,this.defaultTTL=n}get(a){const n=this.cache.get(a);return n?this.isExpired(n)?(this.cache.delete(a),null):n.data:null}set(a,n,m){if(this.cache.size>=this.maxSize){const w=this.cache.keys().next().value;this.cache.delete(w)}this.cache.set(a,{data:n,timestamp:Date.now(),ttl:m??this.defaultTTL})}delete(a){this.cache.delete(a)}clear(){this.cache.clear()}has(a){const n=this.cache.get(a);return n?this.isExpired(n)?(this.cache.delete(a),!1):!0:!1}size(){return this.cache.size}cleanup(){let a=0;for(const[n,m]of this.cache.entries())this.isExpired(m)&&(this.cache.delete(n),a++);return a}isExpired(a){return Date.now()-a.timestamp>a.ttl}getTimeToLive(a){const n=this.cache.get(a);if(!n)return-1;const m=Date.now()-n.timestamp,w=n.ttl-m;return w>0?w:0}}function ne(s){if(!Array.isArray(s))return[];const a=new Map;return s.forEach(n=>{a.has(n.name)||a.set(n.name,{name:n.name||"未知声优",image:n.image||n.images?.medium||n.images?.small,link:n.link||(n.id?`https://bangumi.tv/person/${n.id}`:void 0)})}),Array.from(a.values()).slice(0,3)}function re(s){const a=new Map;return Array.isArray(s)&&s.forEach(n=>{typeof n.value=="string"&&a.set(n.key,n.value)}),a}function oe(s){if(!Array.isArray(s))return"";const a=s.find(m=>m.key==="别名");if(!a||!Array.isArray(a.value))return"";const n=a.value.find(m=>m.k==="纯 假名"||m.k==="假名");return n?n.v:""}function le(s){const a=re(s.infobox),n=oe(s.infobox),m=ne(s.voiceActors||[]);return{type:"character",source:"bangumi",title:s.name||"未知角色",subtitle:n||void 0,description:s.summary||void 0,image:s.images?.large||s.images?.medium||void 0,rating:void 0,tags:void 0,link:`https://bangumi.tv/character/${s.id}`,nameJp:n||void 0,nameCn:s.name_cn||void 0,gender:a.get("性别")||a.get("性 别")||void 0,birthday:a.get("生日")||void 0,bloodType:a.get("血型")||void 0,height:a.get("身高")||void 0,weight:a.get("体重")||void 0,bwh:a.get("BWH")||void 0,voiceActors:m.length>0?m:void 0,metadata:{characterId:s.id}}}function ce(s){return{type:"media",source:"bangumi",title:s.name||"未命名作品",subtitle:s.name_cn||void 0,description:s.summary||void 0,image:s.images?.large||s.images?.common||void 0,rating:s.rating?.score||void 0,tags:s.tags?.map(a=>a.name).slice(0,5)||void 0,link:`https://bangumi.tv/subject/${s.id}`,episode:s.eps||void 0,status:s.status==="Air"?"on-air":s.status==="End"?"finished":"planned",airDate:s.date||void 0,rank:s.rank||void 0,metadata:{bangumiId:s.id,ratingCount:s.rating?.total||void 0}}}const ue=["data-type","data-source"],de={key:1,class:"card-image-placeholder"},me={class:"card-content"},he={class:"character-main-section"},ve={class:"title-section"},pe={class:"card-title"},ge={key:0,class:"card-subtitle"},_e={key:0,class:"card-description"},fe={class:"character-info-section"},be={key:0,class:"tags-container"},ye={key:1,class:"attributes-section"},ke={key:0,class:"attribute-item"},we={class:"attribute-value"},Ce={key:1,class:"attribute-item"},xe={class:"attribute-value"},De={key:2,class:"attribute-item"},Ae={class:"attribute-value"},$e={key:3,class:"attribute-item"},Ie={class:"attribute-value"},Te={key:4,class:"attribute-item"},Be={class:"attribute-value"},Ee={key:5,class:"attribute-item"},Me={class:"attribute-value"},ze={key:2,class:"voice-actors-section"},Le={class:"voice-actors-header"},Ne={class:"voice-actors-badges"},je={class:"card-footer"},Se={class:"source-badge"},Ve={class:"source-name"},Je=["aria-label"],We={class:"media-main-section"},Pe={class:"title-section"},qe={class:"card-title"},Fe={key:0,class:"card-subtitle"},Ke={key:0,class:"card-description"},Oe={class:"media-info-section"},Re={key:0,class:"rating-stars-section"},Ge={class:"rating-stars"},He={class:"rating-text"},Qe={key:1,class:"tags-container"},Ue={key:2,class:"media-info-combined"},Xe={class:"media-info-label"},Ye={class:"media-info-value"},Ze={key:0,class:"date-item"},et={key:1,class:"date-item"},tt={class:"card-footer"},at={class:"source-badge"},st={class:"source-name"},it=["aria-label"],nt={key:1,class:"info-card info-card-error"},rt={key:2,class:"info-card info-card-loading"},ot=U({__name:"index",props:{data:{},loading:{type:Boolean},error:{type:Boolean},type:{},id:{}},setup(s){const a=s,n=K,m=L,w=new O(100,1440*60*1e3),R=new O(100,1440*60*1e3),A=q(!1),_=q(""),C=X(null);let b=null;const N=p(()=>"type"in a&&"id"in a),M=p(()=>"data"in a&&a.data),t=p(()=>M.value?a.data:C.value),$=p(()=>t.value?K(t.value):!1),j=p(()=>t.value?L(t.value):!1),I=p(()=>t.value?t.value.source==="bangumi"?"Bangumi":t.value.source:""),T=p(()=>"ri:bilibili-line");function S(){t.value?.link&&window.open(t.value.link,"_blank")}function V(g){return g?new Date(g).toLocaleDateString("zh-CN"):""}const J=p(()=>{if(!j.value||!t.value||!L(t.value))return[];const g=t.value,l=[];return g.episode&&l.push({label:"话数",value:g.episode}),g.rank&&l.push({label:"排名",value:`#${g.rank}`}),l}),G=p(()=>$.value?"card-layout-vertical":"card-layout-horizontal"),H=p(()=>$.value?"card-image-portrait":"card-image-landscape"),W=p(()=>M.value?a.loading||!1:A.value),P=p(()=>M.value?a.error||!1:_.value!=="");async function Q(){if(!N.value)return;const g=a,{type:l,id:f}=g;if(!f)return;const h=l==="character"?w:R,B=h.get(f);if(B){C.value=B,A.value=!1,_.value="";return}A.value=!0,_.value="",b&&b.abort(),b=new AbortController;try{const c=se.bangumi?.apiBase;if(!c){_.value="Bangumi API 未配置",console.error("[InfoCard] Bangumi API base not configured");return}let v,x;l==="character"?(v=await fetch(`${c}/api/character?id=${f}`,{signal:b.signal}),v.ok?(x=await v.json(),x.id?(C.value=le(x),h.set(f,C.value)):_.value="获取人物数据失败"):_.value=`请求失败 (${v.status})`):l==="media"&&(v=await fetch(`${c}/api/subject?id=${f}`,{signal:b.signal}),v.ok?(x=await v.json(),x.id?(C.value=ce(x),h.set(f,C.value)):_.value="获取媒体数据失败"):_.value=`请求失败 (${v.status})`)}catch(c){c instanceof Error&&c.name!=="AbortError"&&(console.error("[InfoCard] Fetch error:",c),_.value=c.message||"未知错误")}finally{A.value=!1}}return Y(async()=>{N.value&&await Q()}),Z(()=>{b&&b.abort()}),(g,l)=>{const f=ee,h=ae,B=ie;return!e(W)&&!e(P)&&e(t)?(r(),o("div",{key:0,class:"info-card","data-type":e(t).type,"data-source":e(t).source},[i("div",{class:z(e(G))},[i("div",{class:z(["card-image-wrapper",e(H)])},[e(t).image?(r(),E(f,{key:0,src:e(t).image,alt:e(t).title,class:"card-image",loading:"lazy"},null,8,["src","alt"])):(r(),o("div",de,[y(h,{name:e($)?"ph:user-circle-bold":"ph:image-square-bold",class:"placeholder-icon"},null,8,["name"])]))],2),i("div",me,[e($)&&e(n)(e(t))?(r(),o(k,{key:0},[i("div",he,[i("div",ve,[i("h3",pe,d(e(t).title),1),e(t).subtitle?(r(),o("p",ge,d(e(t).subtitle),1)):u("",!0)]),e(t).description?(r(),o("p",_e,d(e(t).description),1)):u("",!0)]),i("div",fe,[e(t).tags&&e(t).tags.length>0?(r(),o("div",be,[(r(!0),o(k,null,D(e(t).tags,c=>(r(),o("span",{key:c,class:"tag"},d(c),1))),128))])):u("",!0),e(t).gender||e(t).birthday||e(t).height||e(t).bloodType||e(t).weight||e(t).bwh?(r(),o("div",ye,[e(t).gender?(r(),o("div",ke,[l[0]||(l[0]=i("span",{class:"attribute-label"},"性别",-1)),i("span",we,d(e(t).gender),1)])):u("",!0),e(t).birthday?(r(),o("div",Ce,[l[1]||(l[1]=i("span",{class:"attribute-label"},"生日",-1)),i("span",xe,d(e(t).birthday),1)])):u("",!0),e(t).height?(r(),o("div",De,[l[2]||(l[2]=i("span",{class:"attribute-label"},"身高",-1)),i("span",Ae,d(e(t).height),1)])):u("",!0),e(t).bloodType?(r(),o("div",$e,[l[3]||(l[3]=i("span",{class:"attribute-label"},"血型",-1)),i("span",Ie,d(e(t).bloodType),1)])):u("",!0),e(t).weight?(r(),o("div",Te,[l[4]||(l[4]=i("span",{class:"attribute-label"},"体重",-1)),i("span",Be,d(e(t).weight),1)])):u("",!0),e(t).bwh?(r(),o("div",Ee,[l[5]||(l[5]=i("span",{class:"attribute-label"},"三围",-1)),i("span",Me,d(e(t).bwh),1)])):u("",!0)])):u("",!0),e(t).voiceActors&&e(t).voiceActors.length>0?(r(),o("div",ze,[i("div",Le,[y(h,{name:"ri:mic-line",class:"voice-actors-icon"}),l[6]||(l[6]=i("span",null,"声优",-1))]),i("div",Ne,[(r(!0),o(k,null,D(e(t).voiceActors,(c,v)=>(r(),E(B,{key:v,img:c.image,text:c.name,link:c.link,round:""},null,8,["img","text","link"]))),128))])])):u("",!0),i("div",je,[i("div",Se,[e(T)?(r(),E(h,{key:0,name:e(T),class:"source-icon"},null,8,["name"])):u("",!0),i("span",Ve,d(e(I)),1)]),e(t).link?(r(),o("button",{key:0,class:"view-button","aria-label":`查看 ${e(I)} 上 ${e(t).title} 的详情`,onClick:S},[l[7]||(l[7]=i("span",null,"查看详情",-1)),y(h,{name:"ri:arrow-right-line",class:"button-icon"})],8,Je)):u("",!0)])])],64)):e(j)&&e(m)(e(t))?(r(),o(k,{key:1},[i("div",We,[i("div",Pe,[i("h3",qe,d(e(t).title),1),e(t).subtitle?(r(),o("p",Fe,d(e(t).subtitle),1)):u("",!0)]),e(t).description?(r(),o("p",Ke,d(e(t).description),1)):u("",!0)]),i("div",Oe,[e(t).rating?(r(),o("div",Re,[i("div",Ge,[(r(),o(k,null,D(5,c=>y(h,{key:c,class:z(["star-icon",c<=Math.round(e(t).rating/2)?"star-filled":"star-empty"]),name:c<=Math.round(e(t).rating/2)?"ri:star-fill":"ri:star-line"},null,8,["class","name"])),64))]),i("span",He,d(e(t).rating),1)])):u("",!0),e(t).tags&&e(t).tags.length>0?(r(),o("div",Qe,[(r(!0),o(k,null,D(e(t).tags,c=>(r(),o("span",{key:c,class:"tag"},d(c),1))),128))])):u("",!0),e(J).length>0||e(t).airDate||e(t).endDate?(r(),o("div",Ue,[(r(!0),o(k,null,D(e(J),(c,v)=>(r(),o("div",{key:`${c.label}-${v}`,class:"media-info-item"},[i("span",Xe,d(c.label)+":",1),i("span",Ye,d(c.value),1)]))),128)),e(t).airDate?(r(),o("span",Ze,[y(h,{name:"clarity:date-line",class:"date-icon"}),F(" "+d(V(e(t).airDate)),1)])):u("",!0),e(t).endDate?(r(),o("span",et,[y(h,{name:"clarity:date-line",class:"date-icon"}),F(" "+d(V(e(t).endDate)),1)])):u("",!0)])):u("",!0),i("div",tt,[i("div",at,[e(T)?(r(),E(h,{key:0,name:e(T),class:"source-icon"},null,8,["name"])):u("",!0),i("span",st,d(e(I)),1)]),e(t).link?(r(),o("button",{key:0,class:"view-button","aria-label":`查看 ${e(I)} 上 ${e(t).title} 的详情`,onClick:S},[l[8]||(l[8]=i("span",null,"查看详情",-1)),y(h,{name:"ri:arrow-right-line",class:"button-icon"})],8,it)):u("",!0)])])],64)):u("",!0)])],2)],8,ue)):e(P)?(r(),o("div",nt,[...l[9]||(l[9]=[i("div",{class:"error-content"},[i("p",null,"加载失败"),i("small",null,"请检查 ID 是否正确或稍后重试")],-1)])])):e(W)?(r(),o("div",rt,[...l[10]||(l[10]=[i("div",{class:"loading-skeleton"},null,-1)])])):u("",!0)}}}),ht=Object.assign(te(ot,[["__scopeId","data-v-9e9bd9dc"]]),{__name:"InfoCard"});export{ht as default};
