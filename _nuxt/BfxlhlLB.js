import{J as ie,g as ae,r as A,o as ce,N as oe,x as k,Q as g,aO as m,b6 as p,aS as L,aR as w,K as r,bs as ue,aV as O,b9 as P,aU as le,aN as de,a_ as z,aW as me,a$ as fe,b5 as ye}from"./C30-xQm5.js";import{f as M,r as ge,_ as he,k as pe}from"./BdOb6OmJ.js";import{_ as ve}from"./BNAXQ_5p.js";const b=new Map,x=new Map,I=new Map;function _e(s){if(!s)return[];const t=[],n=s.split(`
`);for(const u of n){if(!u.trim()||!u.includes("["))continue;const f=u.match(/\[(\d{2}):(\d{2})\.(\d+)\]/);if(!f)continue;const v=Number.parseInt(f[1]??"0",10),y=Number.parseInt(f[2]??"0",10),l=Number.parseInt(f[3]??"0",10),S=v*60+y+l/1e3;let e=u;e=e.replace(/\[\d{2}:\d{2}\.\d+\]/g,"").trim(),e&&t.push({time:S,text:e})}return t.sort((u,f)=>u.time-f.time)}function B(s){try{let t=s.match(/[?&]id=(\d+)/);return t?.[1]||(t=s.match(/\/song[/?#]*(\d+)/),t?.[1])||(t=s.match(/\/m\/song\/(\d+)/),t?.[1])?t[1]:null}catch{return null}}function U(s){const t=s.toLowerCase();return t.includes("music.163.com")||t.includes("netease")?"netease":t.includes("qq.com")||t.includes("y.qq.com")?"tencent":t.includes("kuwo.cn")?"kuwo":t.includes("xiami.com")?"xiami":t.includes("kugou.com")?"kugou":t.includes("youtube.com")||t.includes("youtu.be")?"youtube":"url"}function W(s,t){switch(t){case"netease":return B(s);case"tencent":return s.match(/(?:song\/|songid=)(\d+)/)?.[1]||null;default:return s.match(/(\d+)/)?.[1]||null}}async function Le(s){const t=`netease:${s}`;if(x.has(t))return x.get(t);const n=(async()=>{try{if(!M.meting?.apiServer)return console.warn("[MusicParser] Meting API server not configured"),{};const f=`${M.meting.apiServer.endsWith("/")?M.meting.apiServer:`${M.meting.apiServer}/`}?type=song&id=${s}`,v=await fetch(f);if(!v.ok)return console.warn(`[MusicParser] Song API returned status ${v.status}`),{};const y=await v.json();let l=y;if(Array.isArray(y)&&y.length>0&&(l=y[0]),!l||typeof l!="object")return console.warn("[MusicParser] Invalid response format:",y),{};const S=l.pic;let e;return l.url&&(e=l.url),{title:l.name||l.title||"未知曲目",artist:l.artist?Array.isArray(l.artist)?l.artist.map(d=>typeof d=="string"?d:d.name).join(" / "):String(l.artist):"未知艺术家",cover:S||void 0,url:e||void 0}}catch(u){return console.error(`[MusicParser] Failed to fetch netease metadata for id ${s}:`,u),{}}})();return x.set(t,n),n}async function we(s){const t=`netease:lyrics:${s}`;if(I.has(t))return I.get(t);const n=(async()=>{try{if(!M.meting?.apiServer)return console.warn("[MusicParser] Meting API server not configured"),"";const f=`${M.meting.apiServer.endsWith("/")?M.meting.apiServer:`${M.meting.apiServer}/`}?server=netease&type=lrc&id=${s}`,v=await fetch(f);if(!v.ok)return console.warn(`[MusicParser] Lyric API returned status ${v.status}`),"";const y=await v.text();return!y||y.includes("暂无歌词")?"":y}catch(u){return console.error(`[MusicParser] Failed to fetch lyrics for id ${s}:`,u),""}})();return I.set(t,n),n}function q(){return{id:"",title:"解析失败",artist:"无法解析音乐信息",source:"url"}}function Me(s){if(!s||typeof s!="string")return q();if(b.has(s))return b.get(s);let t;try{if(s.trim().startsWith("{")){const n=JSON.parse(s);if(n&&typeof n=="object")return t={id:(n.id||"").toString(),title:(n.title||"未知曲目").toString(),artist:(n.artist||"未知艺术家").toString(),cover:n.cover?String(n.cover):void 0,url:n.url?String(n.url):void 0,source:n.source||"url",platform:n.platform?String(n.platform):void 0},b.set(s,t),t}if(s.trim().startsWith("http")){const n=s.trim(),u=U(n);return t={id:W(n,u)||"",title:"加载中...",artist:"加载中...",url:n,source:u,cover:void 0},b.set(s,t),t}throw new Error("Invalid format")}catch(n){console.warn("[MusicParser] Failed to parse music extension:",s,n),t=q()}return b.set(s,t),t}function Pe(){b.clear(),x.clear(),I.clear()}function ke(s,t){if(!t)return null;switch(s){case"netease":return`https://music.163.com/#/song?id=${t}`;case"tencent":return`https://y.qq.com/n/yqq/song/${t}.html`;case"kuwo":return`https://www.kuwo.cn/play_detail/${t}`;case"xiami":return`https://www.xiami.com/song/${t}`;case"kugou":return`https://www.kugou.com/song/${t}`;case"youtube":return`https://www.youtube.com/watch?v=${t}`;case"url":return null;default:return null}}function be(){return{parseMusicExtension:Me,createEmptyMusic:q,clearCache:Pe,detectMusicSource:U,extractMusicId:W,extractNeteaseMusicId:B,fetchNeteaseMetadata:Le,fetchNeteaseLyrics:we,getMusicLink:ke,parseLyrics:_e}}const Se={class:"music-player"},$e={class:"music-info"},xe={key:0,class:"music-cover"},Ie={class:"music-details"},Ee={key:0,class:"music-loading"},Te={class:"music-title"},Ce={class:"music-artist"},Ne=["href","title"],Ae={key:1,class:"music-source-text"},ze=["src"],qe={class:"music-actions"},Fe=["title"],je=["title","disabled"],Oe={key:2,class:"lyrics-display"},Be={key:3,class:"music-error"},Ue=ie({__name:"MusicPlayer",props:{music:{}},setup(s){const t=s,{fetchNeteaseMetadata:n,fetchNeteaseLyrics:u,detectMusicSource:f,extractMusicId:v,getMusicLink:y,parseLyrics:l}=be(),S=ge(),e=ae({isLoading:!1,hasError:!1,errorMessage:"",isPlaying:!1,currentTime:0,duration:0,isLyricsLoading:!1,currentLyricIndex:0,showLyrics:!1}),i=A(t.music),d=A(),h=A([]),D={netease:"网易云音乐",tencent:"QQ音乐",kuwo:"酷我音乐",xiami:"虾米音乐",kugou:"酷狗音乐",youtube:"YouTube",url:"外部链接"};ce(()=>t.music.id,c=>{c&&(i.value=t.music,Q(),F())}),oe(()=>{i.value=t.music,F()});const E=k(()=>({title:i.value.title||"未知曲目",artist:i.value.artist||"未知艺术家",platform:i.value.platform||i.value.source||"音乐"})),T=k(()=>D[i.value.source]||i.value.source),C=k(()=>y(i.value.source,i.value.id)),R=k(()=>!!C.value),V=k(()=>e.duration?e.currentTime/e.duration*100:0),K=k(()=>{if(h.value.length===0)return 0;const c=h.value[e.currentLyricIndex],a=h.value[e.currentLyricIndex+1];if(!c)return 0;if(!a){const N=e.currentTime-c.time;return Math.min(100,N/3*100)}const o=a.time-c.time;if(o<=0)return 100;const _=e.currentTime-c.time;return _>=o?100:Math.max(0,_/o*100)});function Q(){e.isPlaying&&d.value&&d.value.pause(),e.isPlaying=!1,e.currentTime=0,e.duration=0,e.hasError=!1,e.errorMessage="",e.showLyrics=!1,e.currentLyricIndex=0,e.isLyricsLoading=!1,h.value=[]}async function F(){let c=i.value.source,a=i.value.id;if(i.value.url&&!a&&(c=f(i.value.url),a=v(i.value.url,c)||"",i.value={...i.value,source:c,id:a}),c!=="netease"||!a){e.isLoading=!1;return}try{e.isLoading=!0,e.hasError=!1,e.errorMessage="";const o=await n(a);(o.title||o.artist||o.cover||o.url)&&(i.value={...i.value,title:o.title||i.value.title,artist:o.artist||i.value.artist,cover:o.cover||i.value.cover,url:o.url||i.value.url}),await J(a)}catch(o){console.error("[MusicPlayer] Failed to fetch metadata:",o),e.hasError=!0,o instanceof TypeError?e.errorMessage="网络连接失败，请检查网络设置":o instanceof SyntaxError?e.errorMessage="音乐信息格式错误":e.errorMessage="加载音乐信息失败"}finally{e.isLoading=!1}}async function J(c){try{e.isLyricsLoading=!0;const a=await u(c);a&&(h.value=l(a),e.currentLyricIndex=0,e.showLyrics=!0)}catch(a){console.warn("[MusicPlayer] Failed to fetch lyrics:",a),h.value=[]}finally{e.isLyricsLoading=!1}}function j(c){if(!Number.isFinite(c))return"0:00";const a=Math.floor(c/60),o=Math.floor(c%60);return`${a}:${o<10?"0":""}${o}`}function Y(){d.value&&(e.isPlaying?d.value.pause():d.value.play().catch(c=>{console.warn("[MusicPlayer] Failed to play audio:",c),e.hasError=!0}))}function Z(){e.isPlaying=!1}function G(){e.isPlaying=!0}function H(){e.isPlaying=!1}function X(){console.error("[MusicPlayer] Audio playback error"),e.isPlaying&&(e.hasError=!0,e.errorMessage="音乐播放失败，可能文件不可用或格式不支持"),e.isPlaying=!1}function ee(){if(!d.value)return;const c=d.value.currentTime;Math.abs(c-e.currentTime)>=.1&&(e.currentTime=c),te(c)}function te(c){if(h.value.length!==0)for(let a=h.value.length-1;a>=0;a--){const o=h.value[a];if(o&&o.time<=c){e.currentLyricIndex=a;break}}}function re(){d.value&&(e.duration=d.value.duration)}function se(c){if(d.value&&e.duration){const a=c/100*e.duration;d.value.currentTime=a,e.currentTime=a}}return(c,a)=>{const o=ue,_=he,N=ve,ne=pe;return m(),g("div",Se,[p("div",$e,[r(i).cover?(m(),g("div",xe,[L(o,{src:r(i).cover,alt:r(E).title,class:"cover-image",loading:"lazy",fit:"cover"},null,8,["src","alt"])])):w("",!0),p("div",Ie,[r(e).isLoading?(m(),g("div",Ee,[L(_,{name:"eos-icons:loading",size:"14"}),a[1]||(a[1]=p("span",null,"加载中...",-1))])):(m(),g(O,{key:1},[p("div",Te,P(r(E).title),1),p("div",Ce,P(r(E).artist),1),r(R)&&r(C)?(m(),g("a",{key:0,href:r(C),target:"_blank",rel:"noopener noreferrer",class:"music-source",title:`在 ${r(T)} 中打开`},[L(_,{name:"mdi:music",size:"14"}),p("span",null,P(r(T)),1)],8,Ne)):(m(),g("div",Ae,[L(_,{name:"mdi:music",size:"14"}),p("span",null,P(r(T)),1)]))],64))])]),L(ne,null,{default:le(()=>[r(i).url?(m(),g("audio",{key:0,ref_key:"audioElement",ref:d,src:r(i).url,crossorigin:"anonymous",onEnded:Z,onPlay:G,onPause:H,onError:X,onTimeupdate:ee,onLoadedmetadata:re},null,40,ze)):w("",!0),r(e).isPlaying&&r(e).duration>0?(m(),de(N,{key:1,percent:r(V),"current-time":j(r(e).currentTime),duration:j(r(e).duration),onChange:se},null,8,["percent","current-time","duration"])):w("",!0),p("div",qe,[r(i).url?(m(),g("button",{key:0,class:z(["play-button",{playing:r(e).isPlaying}]),title:r(e).isPlaying?"暂停":"播放",onClick:Y},[L(_,{name:r(e).isPlaying?"mdi:pause-circle":"mdi:play-circle",size:"20"},null,8,["name"]),p("span",null,P(r(e).isPlaying?"暂停":"播放"),1)],10,Fe)):w("",!0),r(h).length>0||r(e).isLyricsLoading?(m(),g("button",{key:1,class:z(["lyrics-toggle-button",{active:r(e).showLyrics,loading:r(e).isLyricsLoading}]),title:r(e).showLyrics?"隐藏歌词":"显示歌词",disabled:r(e).isLyricsLoading,onClick:a[0]||(a[0]=$=>r(e).showLyrics=!r(e).showLyrics)},[L(_,{name:r(e).isLyricsLoading?"eos-icons:loading":"mdi:text-box",size:"18"},null,8,["name"])],10,je)):w("",!0)]),r(h).length>0&&r(e).showLyrics&&r(e).isPlaying?(m(),g("div",Oe,[(m(),g(O,null,me([-1,0,1],$=>p("div",{key:`${r(e).currentLyricIndex}-${$}`,class:z(["lyric-line",{active:$===0}])},[p("span",null,P(r(h)[r(e).currentLyricIndex+$]?.text||""),1),$===0&&r(S).showLyricProgress?(m(),g("div",{key:0,class:"lyric-progress",style:fe({width:`${r(K)}%`})},null,4)):w("",!0)],2)),64))])):w("",!0),r(e).hasError&&r(i).url?(m(),g("div",Be,[L(_,{name:"mdi:alert-circle",size:"16"}),p("span",null,P(r(e).errorMessage||"音乐加载失败"),1)])):w("",!0)]),_:1})])}}}),We=Object.assign(ye(Ue,[["__scopeId","data-v-586fb3e6"]]),{__name:"MusicPlayer"}),Ke=Object.freeze(Object.defineProperty({__proto__:null,default:We},Symbol.toStringTag,{value:"Module"}));export{Ke as M,We as _,be as u};
